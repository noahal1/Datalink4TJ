import{_ as e,U as l,b as a,n as t,a as o,d as s,M as u}from"./entry-index.D92NaooR.js";import{e as d,f as n,j as i,Z as r,k as c,ah as m,$ as _,aw as v,az as f,a2 as p,C as g,V as h,g as y,y as b,W as V,z as w,A as k,ab as x,h as z,l as C,a1 as U,_ as I,af as $,a3 as N,a4 as B,aa as R,a9 as j,ao as P,ap as E,aq as S,ar as D,as as M,T as q,a5 as A,a6 as H,a7 as L,a8 as O}from"./chunk-vue-core.CxEQweee.js";import{r as T,d as F,ae as K,ac as W,ad as X,H as Z,K as G,a4 as J,X as Q,af as Y,ab as ee,F as le,ag as ae,I as te,w as oe,N as se,ah as ue}from"./chunk-vendors.D0_dqILu.js";import{u as de}from"./chunk-useNotification.BHip036b.js";import"./chunk-utils-vendor.DVew6AbD.js";import"./chunk-chart-core.HkgdsJMe.js";const ne={class:"d-flex align-center"},ie={class:"font-weight-bold"},re={class:"text-caption text-grey"},ce={class:"d-flex align-center"},me={class:"pa-2"},_e={key:0,class:"text-caption text-grey"},ve=["title"],fe=e({__name:"RoleList",props:{roles:{type:Array,default:()=>[]},totalRoles:{type:Number,default:0},loading:{type:Boolean,default:!1}},emits:["add-role","edit-role","delete-role","manage-routes","load-items"],setup(e,{emit:l}){const a=e,t=l,o=T(""),s=T(10),u=F((()=>a.roles.filter((e=>{var l;return(null==(l=e.permissions)?void 0:l.length)>0})).length)),y=F((()=>a.roles.filter((e=>!e.permissions||0===e.permissions.length)).length)),b=[{title:"角色信息",key:"name",sortable:!0,width:"25%"},{title:"描述",key:"description",sortable:!0,width:"30%"},{title:"权限数量",key:"permissions_count",sortable:!0,width:"15%"},{title:"状态",key:"status",sortable:!0,width:"15%"},{title:"操作",key:"actions",sortable:!1,align:"center",width:"15%"}],V=e=>{t("load-items",e)},w=e=>{var l;const a=(null==(l=e.permissions)?void 0:l.length)||0;return 0===a?"grey":a<3?"blue":a<6?"green":a<10?"orange":"red"};return(l,a)=>(W(),K(h,{class:"role-list-card",elevation:"2"},{default:X((()=>[Z(d,{class:"d-flex align-center bg-primary text-white"},{default:X((()=>[Z(n,{class:"mr-2"},{default:X((()=>a[3]||(a[3]=[J(" mdi-account-group ")]))),_:1,__:[3]}),a[6]||(a[6]=G("span",null,"角色列表",-1)),Z(i),Z(r,{modelValue:o.value,"onUpdate:modelValue":a[0]||(a[0]=e=>o.value=e),"append-inner-icon":"mdi-magnify",label:"搜索角色","single-line":"","hide-details":"",density:"compact",variant:"outlined","bg-color":"white",class:"ml-2",style:{"max-width":"300px"},clearable:""},null,8,["modelValue"]),Z(c,{color:"white",variant:"outlined",class:"ml-2",onClick:a[1]||(a[1]=e=>l.$emit("add-role"))},{default:X((()=>[Z(n,{class:"mr-1"},{default:X((()=>a[4]||(a[4]=[J(" mdi-plus ")]))),_:1,__:[4]}),a[5]||(a[5]=J(" 添加角色 "))])),_:1,__:[5]})])),_:1,__:[6]}),Z(m,{class:"d-flex align-center py-2"},{default:X((()=>[Z(_,{size:"small",color:"info",variant:"outlined",class:"mr-2"},{default:X((()=>[Z(n,{size:"small",class:"mr-1"},{default:X((()=>a[7]||(a[7]=[J(" mdi-account-group ")]))),_:1,__:[7]}),J(" 总计: "+Q(e.totalRoles),1)])),_:1}),Z(_,{size:"small",color:"success",variant:"outlined",class:"mr-2"},{default:X((()=>[Z(n,{size:"small",class:"mr-1"},{default:X((()=>a[8]||(a[8]=[J(" mdi-account-check ")]))),_:1,__:[8]}),J(" 有权限: "+Q(u.value),1)])),_:1}),Z(_,{size:"small",color:"warning",variant:"outlined"},{default:X((()=>[Z(n,{size:"small",class:"mr-1"},{default:X((()=>a[9]||(a[9]=[J(" mdi-account-alert ")]))),_:1,__:[9]}),J(" 无权限: "+Q(y.value),1)])),_:1})])),_:1}),Z(v,{"items-per-page":s.value,"onUpdate:itemsPerPage":a[2]||(a[2]=e=>s.value=e),headers:b,items:e.roles,"items-length":e.totalRoles,loading:e.loading,search:o.value,class:"elevation-1","onUpdate:options":V},{"item.name":X((({item:e})=>[G("div",ne,[Z(g,{size:"32",color:w(e),class:"mr-3"},{default:X((()=>[Z(n,{color:"white",size:"small"},{default:X((()=>a[10]||(a[10]=[J(" mdi-account ")]))),_:1,__:[10]})])),_:2},1032,["color"]),G("div",null,[G("div",ie,Q(e.name),1),G("div",re," ID: "+Q(e.id),1)])])])),"item.permissions_count":X((({item:e})=>{var l,t,o;return[G("div",ce,[Z(_,{color:(o=(null==(l=e.permissions)?void 0:l.length)||0,0===o?"grey":o<3?"blue":o<6?"green":o<10?"amber":"red"),"text-color":"white",size:"small",class:"mr-2"},{default:X((()=>{var l;return[J(Q((null==(l=e.permissions)?void 0:l.length)||0),1)]})),_:2},1032,["color"]),(null==(t=e.permissions)?void 0:t.length)>0?(W(),K(p,{key:0,location:"bottom"},{activator:X((({props:e})=>[Z(n,te(e,{size:"small",color:"info"}),{default:X((()=>a[11]||(a[11]=[J(" mdi-information ")]))),_:2,__:[11]},1040)])),default:X((()=>{var l,t;return[G("div",me,[a[12]||(a[12]=G("div",{class:"text-subtitle-2 mb-1"}," 权限列表: ",-1)),(W(!0),ee(le,null,ae(null==(l=e.permissions)?void 0:l.slice(0,5),(e=>(W(),ee("div",{key:e.id,class:"text-caption"}," • "+Q(e.module)+"."+Q(e.level),1)))),128)),(null==(t=e.permissions)?void 0:t.length)>5?(W(),ee("div",_e," ... 还有 "+Q(e.permissions.length-5)+" 个权限 ",1)):Y("",!0)])]})),_:2},1024)):Y("",!0)])]})),"item.description":X((({item:e})=>[G("div",{class:"text-truncate",style:{"max-width":"300px"},title:e.description},Q(e.description||"无描述"),9,ve)])),"item.status":X((({item:e})=>{var l;return[Z(_,{color:(null==(l=e.permissions)?void 0:l.length)>0?"success":"warning",size:"small",variant:"outlined"},{default:X((()=>{var l;return[Z(n,{size:"small",class:"mr-1"},{default:X((()=>{var l;return[J(Q((null==(l=e.permissions)?void 0:l.length)>0?"mdi-check-circle":"mdi-alert-circle"),1)]})),_:2},1024),J(" "+Q((null==(l=e.permissions)?void 0:l.length)>0?"活跃":"待配置"),1)]})),_:2},1032,["color"])]})),"item.actions":X((({item:e})=>[Z(f,{density:"compact",variant:"outlined"},{default:X((()=>{var t;return[Z(c,{size:"small",color:"primary",onClick:a=>l.$emit("edit-role",e)},{default:X((()=>[Z(n,{size:"small"},{default:X((()=>a[13]||(a[13]=[J(" mdi-pencil ")]))),_:1,__:[13]}),Z(p,{activator:"parent",location:"bottom"},{default:X((()=>a[14]||(a[14]=[J(" 编辑角色 ")]))),_:1,__:[14]})])),_:2},1032,["onClick"]),Z(c,{size:"small",color:"info",onClick:a=>l.$emit("manage-routes",e)},{default:X((()=>[Z(n,{size:"small"},{default:X((()=>a[15]||(a[15]=[J(" mdi-routes ")]))),_:1,__:[15]}),Z(p,{activator:"parent",location:"bottom"},{default:X((()=>a[16]||(a[16]=[J(" 管理路由权限 ")]))),_:1,__:[16]})])),_:2},1032,["onClick"]),Z(c,{size:"small",color:"error",disabled:(null==(t=e.permissions)?void 0:t.length)>0,onClick:a=>l.$emit("delete-role",e)},{default:X((()=>[Z(n,{size:"small"},{default:X((()=>a[17]||(a[17]=[J(" mdi-delete ")]))),_:1,__:[17]}),Z(p,{activator:"parent",location:"bottom"},{default:X((()=>{var l;return[J(Q((null==(l=e.permissions)?void 0:l.length)>0?"有权限的角色不能删除":"删除角色"),1)]})),_:2},1024)])),_:2},1032,["disabled","onClick"])]})),_:2},1024)])),_:1},8,["items-per-page","items","items-length","loading","search"])])),_:1}))}},[["__scopeId","data-v-c0702729"]]),pe={__name:"RoleDialog",props:{modelValue:{type:Boolean,default:!1},role:{type:Object,default:()=>({id:null,name:"",description:""})},isNew:{type:Boolean,default:!0},loading:{type:Boolean,default:!1}},emits:["update:modelValue","update:role","save","close"],setup(e,{emit:l}){const a=e,t=l,o=T(a.modelValue),s=T({...a.role}),u=T(!1),n=T(null);oe((()=>a.modelValue),(e=>{o.value=e})),oe((()=>o.value),(e=>{t("update:modelValue",e)})),oe((()=>a.role),(e=>{s.value={...e}}));const m=()=>{o.value=!1,t("close")},_=()=>{var e;(null==(e=n.value)?void 0:e.validate())&&(t("update:role",s.value),t("save"))};return(l,a)=>(W(),K(C,{modelValue:o.value,"onUpdate:modelValue":a[3]||(a[3]=e=>o.value=e),"max-width":"600px",persistent:"","onClick:outside":m},{default:X((()=>[Z(h,null,{default:X((()=>[Z(d,{class:"text-h5"},{default:X((()=>[J(Q(e.isNew?"创建新角色":"编辑角色"),1)])),_:1}),Z(y,null,{default:X((()=>[Z(b,null,{default:X((()=>[Z(V,{ref_key:"formRef",ref:n,modelValue:u.value,"onUpdate:modelValue":a[2]||(a[2]=e=>u.value=e),"lazy-validation":""},{default:X((()=>[Z(w,null,{default:X((()=>[Z(k,{cols:"12"},{default:X((()=>[Z(r,{modelValue:s.value.name,"onUpdate:modelValue":a[0]||(a[0]=e=>s.value.name=e),label:"角色名称*",required:"",rules:[e=>!!e||"角色名称不能为空"],hint:"输入角色的名称，如：系统管理员、质量主管等","persistent-hint":""},null,8,["modelValue","rules"])])),_:1}),Z(k,{cols:"12"},{default:X((()=>[Z(x,{modelValue:s.value.description,"onUpdate:modelValue":a[1]||(a[1]=e=>s.value.description=e),label:"角色描述",hint:"输入角色的详细描述","persistent-hint":"",rows:"3","auto-grow":""},null,8,["modelValue"])])),_:1})])),_:1})])),_:1},8,["modelValue"])])),_:1})])),_:1}),Z(z,null,{default:X((()=>[Z(i),Z(c,{color:"grey-darken-1",variant:"text",disabled:e.loading,onClick:m},{default:X((()=>a[4]||(a[4]=[J(" 取消 ")]))),_:1,__:[4]},8,["disabled"]),Z(c,{color:"primary",loading:e.loading,disabled:!u.value||e.loading,onClick:_},{default:X((()=>a[5]||(a[5]=[J(" 保存 ")]))),_:1,__:[5]},8,["loading","disabled"])])),_:1})])),_:1})])),_:1},8,["modelValue"]))}},ge={class:"mb-2"},he={class:"mb-2"},ye={class:"mb-2"},be={key:1,class:"text-grey"},Ve=e({__name:"RoleRoutesDialog",props:{modelValue:{type:Boolean,default:!1},role:{type:Object,default:null},routes:{type:Array,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["update:modelValue","save","close"],setup(e,{emit:l}){const{showError:a}=de(),t=e,o=l,s=T([]),u=T(!1),r=F({get:()=>t.modelValue,set:e=>o("update:modelValue",e)});oe((()=>t.role),(e=>{e&&(s.value=[],u.value=!1)}),{immediate:!0}),oe(s,(e=>{u.value=e.length===t.routes.length}),{deep:!0});const m=()=>{u.value?s.value=t.routes.map((e=>e.id)):s.value=[]},v=e=>{const l=t.routes.find((l=>l.id===e));return l?l.name:`路由${e}`},f=()=>{t.role?o("save",t.role.id,s.value):a("请选择角色")},p=()=>{o("close"),o("update:modelValue",!1)};return(l,a)=>(W(),K(C,{modelValue:r.value,"onUpdate:modelValue":a[2]||(a[2]=e=>r.value=e),"max-width":"800px",persistent:""},{default:X((()=>[Z(h,null,{default:X((()=>[Z(d,{class:"d-flex align-center"},{default:X((()=>[Z(n,{class:"mr-2"},{default:X((()=>a[3]||(a[3]=[J(" mdi-shield-account ")]))),_:1,__:[3]}),a[5]||(a[5]=J(" 管理角色路由权限 ")),Z(i),Z(c,{icon:"",onClick:p},{default:X((()=>[Z(n,null,{default:X((()=>a[4]||(a[4]=[J("mdi-close")]))),_:1,__:[4]})])),_:1})])),_:1,__:[5]}),Z(y,null,{default:X((()=>[e.role?(W(),K(U,{key:0,type:"info",class:"mb-4"},{default:X((()=>[a[6]||(a[6]=J(" 正在为角色 ")),G("strong",null,Q(e.role.name),1),a[7]||(a[7]=J(" 配置路由访问权限 "))])),_:1,__:[6,7]})):Y("",!0),Z(U,{type:"warning",class:"mb-4"},{default:X((()=>a[8]||(a[8]=[G("strong",null,"注意：",-1),J("当前权限系统已简化，权限规则由系统预定义。此功能主要用于查看和记录权限配置请求。 ")]))),_:1,__:[8]}),Z(h,{variant:"outlined",class:"mb-4"},{default:X((()=>[Z(d,{class:"text-h6"},{default:X((()=>[Z(n,{class:"mr-2"},{default:X((()=>a[9]||(a[9]=[J(" mdi-routes ")]))),_:1,__:[9]}),a[10]||(a[10]=J(" 可访问路由 "))])),_:1,__:[10]}),Z(y,null,{default:X((()=>[Z(w,null,{default:X((()=>[Z(k,{cols:"12"},{default:X((()=>[Z(I,{modelValue:u.value,"onUpdate:modelValue":a[0]||(a[0]=e=>u.value=e),label:"全选/全不选",color:"primary",onChange:m},null,8,["modelValue"])])),_:1})])),_:1}),Z(w,null,{default:X((()=>[(W(!0),ee(le,null,ae(e.routes,(e=>(W(),K(k,{key:e.id,cols:"12",sm:"6",md:"4"},{default:X((()=>[Z(I,{modelValue:s.value,"onUpdate:modelValue":a[1]||(a[1]=e=>s.value=e),value:e.id,label:e.name,hint:e.path,"persistent-hint":"",color:"primary"},null,8,["modelValue","value","label","hint"])])),_:2},1024)))),128))])),_:1})])),_:1})])),_:1}),e.role?(W(),K(h,{key:1,variant:"outlined"},{default:X((()=>[Z(d,{class:"text-h6"},{default:X((()=>[Z(n,{class:"mr-2"},{default:X((()=>a[11]||(a[11]=[J(" mdi-eye ")]))),_:1,__:[11]}),a[12]||(a[12]=J(" 当前权限预览 "))])),_:1,__:[12]}),Z(y,null,{default:X((()=>[G("div",ge,[a[13]||(a[13]=G("strong",null,"角色：",-1)),J(Q(e.role.name),1)]),G("div",he,[a[14]||(a[14]=G("strong",null,"描述：",-1)),J(Q(e.role.description||"无描述"),1)]),G("div",ye,[a[15]||(a[15]=G("strong",null,"选中路由：",-1)),J(Q(s.value.length)+" / "+Q(e.routes.length),1)]),s.value.length>0?(W(),K($,{key:0},{default:X((()=>[(W(!0),ee(le,null,ae(s.value,(e=>(W(),K(_,{key:e,size:"small",color:"primary"},{default:X((()=>[J(Q(v(e)),1)])),_:2},1024)))),128))])),_:1})):(W(),ee("div",be," 未选择任何路由 "))])),_:1})])),_:1})):Y("",!0)])),_:1}),Z(z,null,{default:X((()=>[Z(i),Z(c,{onClick:p},{default:X((()=>a[16]||(a[16]=[J(" 取消 ")]))),_:1,__:[16]}),Z(c,{color:"primary",loading:e.loading,disabled:!e.role,onClick:f},{default:X((()=>a[17]||(a[17]=[J(" 保存 ")]))),_:1,__:[17]},8,["loading","disabled"])])),_:1})])),_:1})])),_:1},8,["modelValue"]))}},[["__scopeId","data-v-662786e9"]]),we={class:"route-checkboxes"},ke=e({__name:"RoutePermissionMatrix",props:{loading:{type:Boolean,default:!1}},emits:["refresh"],setup(e,{emit:t}){const{showSuccess:o,showError:s}=de(),u=t,r=T([]),m=T([]),v=T([]),f=T(!1),p=T(!1),g=T(null),b=T([]),V=T("none"),x=T(!1),U=F((()=>[{title:"角色",key:"roleName",sortable:!0,width:"150px"},...m.value.map((e=>({title:e.name,key:`route_${e.id}`,sortable:!1,width:"100px",align:"center"})))])),$=F((()=>r.value.map(((e,l)=>{const a={roleId:e.id,roleName:e.name};return m.value.forEach(((e,t)=>{var o;a[`route_${e.id}`]=(null==(o=v.value[l])?void 0:o[t])||!1})),a})))),P=async()=>{var e,l;try{const e=(await a.get("/permissions/routes-matrix")).data;r.value=e.roles||[],m.value=e.routes||[],v.value=e.access_matrix||[],o("权限矩阵刷新成功"),u("refresh")}catch(t){s("刷新权限矩阵失败: "+((null==(l=null==(e=t.response)?void 0:e.data)?void 0:l.detail)||t.message))}},E=()=>{p.value=!0,g.value=null,b.value=[],V.value="none"},S=()=>{p.value=!1,g.value=null,b.value=[]},D=()=>{if(!g.value)return void(b.value=[]);const e=r.value.findIndex((e=>e.id===g.value));if(-1!==e&&v.value[e]){const l=[];m.value.forEach(((a,t)=>{v.value[e][t]&&l.push(a.id)})),b.value=l}};oe(V,(e=>{if(g.value)switch(e){case"none":b.value=[];break;case"all":b.value=m.value.map((e=>e.id));break;case"basic":const e=["/dashboard","/events"];b.value=m.value.filter((l=>e.includes(l.path))).map((e=>e.id))}}));const M=async()=>{var e,l;try{x.value=!0,await a.put(`/permissions/roles/${g.value}/routes`,{route_ids:b.value}),o("角色权限批量设置成功"),await P(),S()}catch(t){s("批量设置权限失败: "+((null==(l=null==(e=t.response)?void 0:e.data)?void 0:l.detail)||t.message))}finally{x.value=!1}},q=e=>{var l;const a=r.value.findIndex((l=>l.id===e));return-1===a?0:(null==(l=v.value[a])?void 0:l.filter(Boolean).length)||0},A=e=>{const l=m.value.findIndex((l=>l.id===e));return-1===l?0:v.value.filter((e=>e[l])).length},H=e=>{const l=e/m.value.length;return l>=.8?"success":l>=.5?"warning":"error"},L=e=>{const l=e/r.value.length;return l>=.8?"success":l>=.5?"warning":"error"};return se((()=>{P()})),(t,u)=>(W(),K(h,null,{default:X((()=>[Z(d,{class:"d-flex align-center"},{default:X((()=>[Z(n,{class:"mr-2"},{default:X((()=>u[4]||(u[4]=[J(" mdi-matrix ")]))),_:1,__:[4]}),u[9]||(u[9]=J(" 角色路由访问权限矩阵 ")),Z(i),Z(c,{color:"primary",loading:e.loading,class:"mr-2",onClick:P},{default:X((()=>[Z(n,{left:""},{default:X((()=>u[5]||(u[5]=[J(" mdi-refresh ")]))),_:1,__:[5]}),u[6]||(u[6]=J(" 刷新 "))])),_:1,__:[6]},8,["loading"]),Z(c,{color:"success",disabled:!r.value.length||!m.value.length,onClick:E},{default:X((()=>[Z(n,{left:""},{default:X((()=>u[7]||(u[7]=[J(" mdi-account-cog ")]))),_:1,__:[7]}),u[8]||(u[8]=J(" 批量设置 "))])),_:1,__:[8]},8,["disabled"])])),_:1,__:[9]}),Z(y,null,{default:X((()=>[Z(l,{headers:U.value,items:$.value,loading:e.loading,class:"elevation-1","item-key":"roleId",density:"compact","items-per-page":-1,"hide-default-footer":""},ue({top:X((()=>[Z(N,{flat:""},{default:X((()=>[Z(B,null,{default:X((()=>u[10]||(u[10]=[J("权限矩阵")]))),_:1,__:[10]}),Z(i),Z(_,{color:"success",class:"mr-2"},{default:X((()=>[J(Q(r.value.length)+" 个角色 ",1)])),_:1}),Z(_,{color:"info"},{default:X((()=>[J(Q(m.value.length)+" 个路由 ",1)])),_:1})])),_:1})])),"item.roleName":X((({item:e})=>{return[Z(_,{color:(l=e.roleName,{"超级管理员":"red","管理员":"purple","部门负责人":"blue","班组负责人":"green","普通用户":"grey"}[l]||"primary"),dark:"",size:"small"},{default:X((()=>[J(Q(e.roleName),1)])),_:2},1032,["color"])];var l})),_:2},[ae(m.value,(e=>({name:`item.route_${e.id}`,fn:X((({item:l})=>[Z(I,{"model-value":l[`route_${e.id}`],loading:f.value,"hide-details":"",density:"compact",color:"success","onUpdate:modelValue":t=>(async(e,l,t)=>{var u,d;try{f.value=!0;const s=r.value.findIndex((l=>l.id===e));if(-1===s)throw new Error("找不到指定角色");const u=v.value[s]||[],d=[];m.value.forEach(((e,a)=>{(e.id===l?t:u[a])&&d.push(e.id)})),await a.put(`/permissions/roles/${e}/routes`,{route_ids:d}),v.value[s][m.value.findIndex((e=>e.id===l))]=t,o("权限设置成功")}catch(n){s("设置权限失败: "+((null==(d=null==(u=n.response)?void 0:u.data)?void 0:d.detail)||n.message)),await P()}finally{f.value=!1}})(l.roleId,e.id,t)},null,8,["model-value","loading","onUpdate:modelValue"])]))})))]),1032,["headers","items","loading"]),Z(w,{class:"mt-4"},{default:X((()=>[Z(k,{cols:"12",md:"6"},{default:X((()=>[Z(h,{variant:"outlined"},{default:X((()=>[Z(d,{class:"text-h6"},{default:X((()=>[Z(n,{class:"mr-2"},{default:X((()=>u[11]||(u[11]=[J(" mdi-account-group ")]))),_:1,__:[11]}),u[12]||(u[12]=J(" 角色统计 "))])),_:1,__:[12]}),Z(y,null,{default:X((()=>[(W(!0),ee(le,null,ae(r.value,(e=>(W(),ee("div",{key:e.id,class:"d-flex justify-space-between mb-2"},[G("span",null,Q(e.name),1),Z(_,{size:"small",color:H(q(e.id))},{default:X((()=>[J(Q(q(e.id))+" / "+Q(m.value.length),1)])),_:2},1032,["color"])])))),128))])),_:1})])),_:1})])),_:1}),Z(k,{cols:"12",md:"6"},{default:X((()=>[Z(h,{variant:"outlined"},{default:X((()=>[Z(d,{class:"text-h6"},{default:X((()=>[Z(n,{class:"mr-2"},{default:X((()=>u[13]||(u[13]=[J(" mdi-routes ")]))),_:1,__:[13]}),u[14]||(u[14]=J(" 路由统计 "))])),_:1,__:[14]}),Z(y,null,{default:X((()=>[(W(!0),ee(le,null,ae(m.value,(e=>(W(),ee("div",{key:e.id,class:"d-flex justify-space-between mb-2"},[G("span",null,Q(e.name),1),Z(_,{size:"small",color:L(A(e.id))},{default:X((()=>[J(Q(A(e.id))+" / "+Q(r.value.length),1)])),_:2},1032,["color"])])))),128))])),_:1})])),_:1})])),_:1})])),_:1})])),_:1}),Z(C,{modelValue:p.value,"onUpdate:modelValue":u[3]||(u[3]=e=>p.value=e),"max-width":"600px"},{default:X((()=>[Z(h,null,{default:X((()=>[Z(d,null,{default:X((()=>[Z(n,{class:"mr-2"},{default:X((()=>u[15]||(u[15]=[J(" mdi-account-cog ")]))),_:1,__:[15]}),u[16]||(u[16]=J(" 批量设置角色权限 "))])),_:1,__:[16]}),Z(y,null,{default:X((()=>[Z(w,null,{default:X((()=>[Z(k,{cols:"12"},{default:X((()=>[Z(R,{modelValue:g.value,"onUpdate:modelValue":[u[0]||(u[0]=e=>g.value=e),D],items:r.value,"item-title":"name","item-value":"id",label:"选择角色","prepend-icon":"mdi-account",variant:"outlined"},null,8,["modelValue","items"])])),_:1}),g.value?(W(),K(k,{key:0,cols:"12"},{default:X((()=>[Z(h,{variant:"outlined"},{default:X((()=>[Z(d,{class:"text-subtitle-1"},{default:X((()=>u[17]||(u[17]=[J(" 选择可访问的路由 ")]))),_:1,__:[17]}),Z(y,null,{default:X((()=>[Z(w,null,{default:X((()=>[Z(k,{cols:"12"},{default:X((()=>[Z(j,{modelValue:V.value,"onUpdate:modelValue":u[1]||(u[1]=e=>V.value=e),mandatory:"",class:"mb-3"},{default:X((()=>[Z(c,{value:"none",size:"small"},{default:X((()=>u[18]||(u[18]=[J(" 全不选 ")]))),_:1,__:[18]}),Z(c,{value:"all",size:"small"},{default:X((()=>u[19]||(u[19]=[J(" 全选 ")]))),_:1,__:[19]}),Z(c,{value:"basic",size:"small"},{default:X((()=>u[20]||(u[20]=[J(" 基础权限 ")]))),_:1,__:[20]})])),_:1},8,["modelValue"])])),_:1})])),_:1}),Z(w,null,{default:X((()=>[Z(k,{cols:"12"},{default:X((()=>[G("div",we,[(W(!0),ee(le,null,ae(m.value,(e=>(W(),K(I,{key:e.id,modelValue:b.value,"onUpdate:modelValue":u[2]||(u[2]=e=>b.value=e),value:e.id,label:e.name,"hide-details":"",density:"compact",class:"mb-1"},null,8,["modelValue","value","label"])))),128))])])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})):Y("",!0)])),_:1})])),_:1}),Z(z,null,{default:X((()=>[Z(i),Z(c,{onClick:S},{default:X((()=>u[21]||(u[21]=[J(" 取消 ")]))),_:1,__:[21]}),Z(c,{color:"primary",loading:x.value,disabled:!g.value||0===b.value.length,onClick:M},{default:X((()=>u[22]||(u[22]=[J(" 保存权限 ")]))),_:1,__:[22]},8,["loading","disabled"])])),_:1})])),_:1})])),_:1},8,["modelValue"])])),_:1}))}},[["__scopeId","data-v-e656d073"]]),xe=e({__name:"PermissionCodesManager",props:{loading:{type:Boolean,default:!1}},emits:["refresh"],setup(e,{emit:l}){const{showSuccess:a}=de(),t=l,o=T([{code:"admin_access",description:"管理员访问权限",roles:["超级管理员","管理员"]},{code:"user_manage",description:"用户管理权限",roles:["超级管理员","管理员"]},{code:"role_manage",description:"角色管理权限",roles:["超级管理员","管理员"]},{code:"route_manage",description:"路由管理权限",roles:["超级管理员","管理员"]},{code:"quality_manage",description:"质量管理权限",roles:["超级管理员","管理员","质量部门负责人","质量班组负责人"]},{code:"maintenance_manage",description:"维修管理权限",roles:["超级管理员","管理员","维修班组负责人"]},{code:"safety_manage",description:"安全管理权限",roles:["超级管理员","管理员","安全负责人"]},{code:"dashboard_view",description:"仪表板查看权限",roles:["超级管理员","管理员","普通用户","质量部门负责人","质量班组负责人","维修班组负责人","安全负责人"]},{code:"quality_view",description:"质量数据查看权限",roles:["质量部门负责人","质量班组负责人"]},{code:"maintenance_view",description:"维修数据查看权限",roles:["维修班组负责人"]},{code:"safety_view",description:"安全数据查看权限",roles:["安全负责人"]}]),s=F((()=>[{title:"角色",key:"roleName",sortable:!0,width:"150px"},...o.value.map((e=>({title:e.code,key:e.code,sortable:!1,width:"120px",align:"center"})))])),u=F((()=>["超级管理员","管理员","普通用户","质量部门负责人","质量班组负责人","维修班组负责人","安全负责人"].map((e=>{const l=o.value.filter((l=>l.roles.includes(e))).length;return{name:e,permissionCount:l}})))),r=F((()=>u.value.map((e=>{const l={roleName:e.name};return o.value.forEach((a=>{l[a.code]=a.roles.includes(e.name)})),l})))),m=()=>{a("权限代码刷新成功"),t("refresh")},v=e=>({"超级管理员":"red","管理员":"purple","质量部门负责人":"blue","质量班组负责人":"light-blue","维修班组负责人":"green","安全负责人":"orange","普通用户":"grey"}[e]||"primary");return se((()=>{m()})),(l,a)=>(W(),K(h,null,{default:X((()=>[Z(d,{class:"d-flex align-center"},{default:X((()=>[Z(n,{class:"mr-2"},{default:X((()=>a[0]||(a[0]=[J(" mdi-code-tags ")]))),_:1,__:[0]}),a[3]||(a[3]=J(" 权限代码管理 ")),Z(i),Z(c,{color:"primary",loading:e.loading,onClick:m},{default:X((()=>[Z(n,{left:""},{default:X((()=>a[1]||(a[1]=[J(" mdi-refresh ")]))),_:1,__:[1]}),a[2]||(a[2]=J(" 刷新 "))])),_:1,__:[2]},8,["loading"])])),_:1,__:[3]}),Z(y,null,{default:X((()=>[Z(U,{type:"info",class:"mb-4"},{default:X((()=>a[4]||(a[4]=[G("strong",null,"简化权限系统：",-1),J("权限代码基于角色自动分配，系统预定义权限规则。 ")]))),_:1,__:[4]}),Z(P,{class:"mb-4"},{default:X((()=>[Z(E,null,{default:X((()=>[Z(S,null,{default:X((()=>[Z(n,{class:"mr-2"},{default:X((()=>a[5]||(a[5]=[J(" mdi-information ")]))),_:1,__:[5]}),a[6]||(a[6]=J(" 权限代码说明 "))])),_:1,__:[6]}),Z(D,null,{default:X((()=>[Z(M,{density:"compact"},{default:X((()=>[a[7]||(a[7]=G("thead",null,[G("tr",null,[G("th",null,"权限代码"),G("th",null,"描述"),G("th",null,"适用角色")])],-1)),G("tbody",null,[(W(!0),ee(le,null,ae(o.value,(e=>(W(),ee("tr",{key:e.code},[G("td",null,[Z(_,{size:"small",color:"primary"},{default:X((()=>[J(Q(e.code),1)])),_:2},1024)]),G("td",null,Q(e.description),1),G("td",null,[Z($,null,{default:X((()=>[(W(!0),ee(le,null,ae(e.roles,(e=>(W(),K(_,{key:e,size:"small",color:v(e)},{default:X((()=>[J(Q(e),1)])),_:2},1032,["color"])))),128))])),_:2},1024)])])))),128))])])),_:1,__:[7]})])),_:1})])),_:1})])),_:1}),Z(h,{variant:"outlined"},{default:X((()=>[Z(d,{class:"text-h6"},{default:X((()=>[Z(n,{class:"mr-2"},{default:X((()=>a[8]||(a[8]=[J(" mdi-matrix ")]))),_:1,__:[8]}),a[9]||(a[9]=J(" 角色权限代码矩阵 "))])),_:1,__:[9]}),Z(y,null,{default:X((()=>[Z(q,{headers:s.value,items:r.value,loading:e.loading,class:"elevation-1","item-key":"roleName",density:"compact"},ue({"item.roleName":X((({item:e})=>[Z(_,{color:v(e.roleName),dark:"",size:"small"},{default:X((()=>[J(Q(e.roleName),1)])),_:2},1032,["color"])])),_:2},[ae(o.value,(e=>({name:`item.${e.code}`,fn:X((({item:l})=>[Z(n,{color:l[e.code]?"success":"error",size:"small"},{default:X((()=>[J(Q(l[e.code]?"mdi-check-circle":"mdi-close-circle"),1)])),_:2},1032,["color"])]))})))]),1032,["headers","items","loading"])])),_:1})])),_:1}),Z(w,{class:"mt-4"},{default:X((()=>[Z(k,{cols:"12",md:"6"},{default:X((()=>[Z(h,{variant:"outlined"},{default:X((()=>[Z(d,{class:"text-h6"},{default:X((()=>[Z(n,{class:"mr-2"},{default:X((()=>a[10]||(a[10]=[J(" mdi-chart-bar ")]))),_:1,__:[10]}),a[11]||(a[11]=J(" 权限代码统计 "))])),_:1,__:[11]}),Z(y,null,{default:X((()=>[(W(!0),ee(le,null,ae(o.value,(e=>(W(),ee("div",{key:e.code,class:"d-flex justify-space-between mb-2"},[G("span",null,Q(e.code),1),Z(_,{size:"small",color:"info"},{default:X((()=>[J(Q(e.roles.length)+" 个角色 ",1)])),_:2},1024)])))),128))])),_:1})])),_:1})])),_:1}),Z(k,{cols:"12",md:"6"},{default:X((()=>[Z(h,{variant:"outlined"},{default:X((()=>[Z(d,{class:"text-h6"},{default:X((()=>[Z(n,{class:"mr-2"},{default:X((()=>a[12]||(a[12]=[J(" mdi-account-group ")]))),_:1,__:[12]}),a[13]||(a[13]=J(" 角色权限统计 "))])),_:1,__:[13]}),Z(y,null,{default:X((()=>[(W(!0),ee(le,null,ae(u.value,(e=>{return W(),ee("div",{key:e.name,class:"d-flex justify-space-between mb-2"},[G("span",null,Q(e.name),1),Z(_,{size:"small",color:(l=e.permissionCount,l>=6?"success":l>=3?"warning":"error")},{default:X((()=>[J(Q(e.permissionCount)+" 个权限 ",1)])),_:2},1032,["color"])]);var l})),128))])),_:1})])),_:1})])),_:1})])),_:1})])),_:1})])),_:1}))}},[["__scopeId","data-v-4034da3c"]]),ze=e({__name:"ConfirmDialog",props:{modelValue:{type:Boolean,default:!1},title:{type:String,default:"确认操作"},message:{type:String,default:""},loading:{type:Boolean,default:!1}},emits:["update:modelValue","confirm","cancel"],setup(e,{expose:l,emit:a}){const o=e,s=a,u=T(o.modelValue);let n=null,r=null;oe((()=>o.modelValue),(e=>{u.value=e})),oe((()=>u.value),(e=>{s("update:modelValue",e)}));const m=()=>{s("confirm"),"function"==typeof n&&n(),o.loading||(u.value=!1,n=null,r=null)},_=()=>{s("cancel"),"function"==typeof r&&r(),u.value=!1,n=null,r=null},v=(e,l,a,t)=>{title.value=e,message.value=l,n=a,r=t,u.value=!0};return se((()=>{t.on("dialog:confirm",(({title:e,message:l,onConfirm:a,onCancel:t})=>{v(e,l,a,t)}))})),l({showConfirm:v}),(l,a)=>(W(),K(C,{modelValue:u.value,"onUpdate:modelValue":a[0]||(a[0]=e=>u.value=e),"max-width":"400px",persistent:""},{default:X((()=>[Z(h,null,{default:X((()=>[Z(d,{class:"text-h6 pb-2"},{default:X((()=>[J(Q(e.title),1)])),_:1}),Z(y,null,{default:X((()=>[J(Q(e.message),1)])),_:1}),Z(z,null,{default:X((()=>[Z(i),Z(c,{variant:"text",disabled:e.loading,onClick:_},{default:X((()=>a[1]||(a[1]=[J(" 取消 ")]))),_:1,__:[1]},8,["disabled"]),Z(c,{color:"primary",variant:"elevated",loading:e.loading,disabled:e.loading,onClick:m},{default:X((()=>a[2]||(a[2]=[J(" 确定 ")]))),_:1,__:[2]},8,["loading","disabled"])])),_:1})])),_:1})])),_:1},8,["modelValue"]))}},[["__scopeId","data-v-14c749cc"]]),Ce=e({__name:"PermissionManagement",setup(e){const l=T("roles"),t=o(),d=T([]),n=T(!1),i=T(!1),r=T([]),c=T(0),m=T(!1),_=T(!1),v=T(!1),f=T(-1),p=T({id:null,name:"",description:""}),g=T(!1),h=T(null),y=T(!1),V=async(e={})=>{try{m.value=!0;const l={skip:e.page?(e.page-1)*e.itemsPerPage:0,limit:e.itemsPerPage||10};e.sortBy&&e.sortBy.length>0&&(l.order_by=e.sortBy[0].key,l.order_desc="desc"===e.sortBy[0].order);const t=await a.get("/roles",{params:l});t&&t.data&&(r.value=t.data,c.value=t.headers["x-total-count"]||r.value.length)}catch(l){u.error("加载角色列表失败")}finally{m.value=!1}},x=(e=null)=>{e?(f.value=r.value.findIndex((l=>l.id===e.id)),p.value={...e}):(f.value=-1,p.value={id:null,name:"",description:""}),v.value=!0},z=e=>{x(e)},C=async()=>{var e,l;try{_.value=!0;const e={name:p.value.name,description:p.value.description,permission_ids:p.value.permission_ids};if("string"==typeof e.name&&e.name.includes("name="))try{const l=e.name.match(/name=['"]([^'"]+)['"]/);l&&l[1]&&(e.name=l[1])}catch(t){}if(-1===f.value){await a.post("/roles",e);u.success("角色创建成功"),await V()}else await a.put(`/roles/${p.value.id}`,e),u.success("角色更新成功"),r.value[f.value]={...p.value,name:e.name,description:e.description};U()}catch(o){u.error("保存角色失败: "+((null==(l=null==(e=o.response)?void 0:e.data)?void 0:l.detail)||o.message))}finally{_.value=!1}},U=()=>{v.value=!1,setTimeout((()=>{p.value={id:null,name:"",description:""}}),300)},I=e=>{h.value=e,g.value=!0},$=()=>{g.value=!1,h.value=null},N=async(e,l)=>{var t,o;try{y.value=!0;await a.put(`/permissions/roles/${e}/routes`,{route_ids:l});u.success("角色路由权限更新成功"),await B(),$()}catch(s){u.error("更新角色路由权限失败: "+((null==(o=null==(t=s.response)?void 0:t.data)?void 0:o.detail)||s.message))}finally{y.value=!1}},B=async()=>{var e,l;try{n.value=!0;const e=await a.get("/routes");e&&e.data&&(d.value=e.data),u.success("路由权限矩阵加载成功")}catch(t){u.error("加载路由权限矩阵失败: "+((null==(l=null==(e=t.response)?void 0:e.data)?void 0:l.detail)||t.message))}finally{n.value=!1}},R=async()=>{var e,l;try{i.value=!0,u.success("权限代码加载成功")}catch(a){u.error("加载权限代码失败: "+((null==(l=null==(e=a.response)?void 0:e.data)?void 0:l.detail)||a.message))}finally{i.value=!1}},j=T(!1),P=T(""),E=T(""),S=T(!1),D=T(null),M=T(""),q=e=>{D.value=e,M.value="role",P.value="确认删除角色",E.value=`确定要删除角色 "${e.name}" 吗？此操作不可撤销。`,j.value=!0},F=async()=>{var e,l;try{S.value=!0,"role"===M.value&&(await a.delete(`/roles/${D.value.id}`),u.success("角色删除成功"),await V()),j.value=!1}catch(t){u.error("删除失败: "+((null==(l=null==(e=t.response)?void 0:e.data)?void 0:l.detail)||t.message))}finally{S.value=!1,D.value=null,M.value=""}};return se((async()=>{await V(),await B(),await t.initPermissions()})),(e,a)=>(W(),K(s,{title:"权限角色管理",icon:"mdi-shield-account",color:"primary"},{default:X((()=>[Z(A,{modelValue:l.value,"onUpdate:modelValue":a[0]||(a[0]=e=>l.value=e),"bg-color":"primary"},{default:X((()=>[Z(H,{value:"roles"},{default:X((()=>a[7]||(a[7]=[J(" 角色管理 ")]))),_:1,__:[7]}),Z(H,{value:"route-permissions"},{default:X((()=>a[8]||(a[8]=[J(" 路由权限矩阵 ")]))),_:1,__:[8]}),Z(H,{value:"permission-codes"},{default:X((()=>a[9]||(a[9]=[J(" 权限代码 ")]))),_:1,__:[9]})])),_:1},8,["modelValue"]),Z(L,{modelValue:l.value,"onUpdate:modelValue":a[2]||(a[2]=e=>l.value=e),class:"mt-4"},{default:X((()=>[Z(O,{value:"roles"},{default:X((()=>[Z(b,null,{default:X((()=>[Z(w,null,{default:X((()=>[Z(k,{cols:"12"},{default:X((()=>[Z(fe,{roles:r.value,"total-roles":c.value,loading:m.value,onAddRole:a[1]||(a[1]=e=>x()),onEditRole:z,onDeleteRole:q,onManageRoutes:I,onLoadItems:V},null,8,["roles","total-roles","loading"])])),_:1})])),_:1})])),_:1})])),_:1}),Z(O,{value:"route-permissions"},{default:X((()=>[Z(b,null,{default:X((()=>[Z(w,null,{default:X((()=>[Z(k,{cols:"12"},{default:X((()=>[Z(ke,{loading:n.value,onRefresh:B},null,8,["loading"])])),_:1})])),_:1})])),_:1})])),_:1}),Z(O,{value:"permission-codes"},{default:X((()=>[Z(b,null,{default:X((()=>[Z(w,null,{default:X((()=>[Z(k,{cols:"12"},{default:X((()=>[Z(xe,{loading:i.value,onRefresh:R},null,8,["loading"])])),_:1})])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"]),Z(pe,{modelValue:v.value,"onUpdate:modelValue":a[3]||(a[3]=e=>v.value=e),role:p.value,"onUpdate:role":a[4]||(a[4]=e=>p.value=e),"is-new":-1===f.value,loading:_.value,onSave:C,onClose:U},null,8,["modelValue","role","is-new","loading"]),Z(Ve,{modelValue:g.value,"onUpdate:modelValue":a[5]||(a[5]=e=>g.value=e),role:h.value,routes:d.value,loading:y.value,onSave:N,onClose:$},null,8,["modelValue","role","routes","loading"]),Z(ze,{modelValue:j.value,"onUpdate:modelValue":a[6]||(a[6]=e=>j.value=e),title:P.value,message:E.value,loading:S.value,onConfirm:F},null,8,["modelValue","title","message","loading"])])),_:1}))}},[["__scopeId","data-v-a8da74c2"]]);export{Ce as default};
