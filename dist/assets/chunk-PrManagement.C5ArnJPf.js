const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["/assets/entry-index.D92NaooR.js","/assets/chunk-vendors.D0_dqILu.js","/assets/css/vendors.CYg2uPei.css","/assets/chunk-vue-core.CxEQweee.js","/assets/chunk-chart-core.HkgdsJMe.js","/assets/css/vue-core.BMFs3-do.css","/assets/chunk-utils-vendor.DVew6AbD.js","/assets/css/index.B_oiUGRj.css"])))=>i.map(i=>d[i]);
import{r as e,d as a,w as l,ab as t,ac as s,H as i,ad as n,ae as r,af as d,K as u,X as o,a4 as c,W as m,F as v,ag as p,$ as _,I as f,a as y,N as g,ak as b,J as h}from"./chunk-vendors.D0_dqILu.js";import{_ as x,u as k,b as V,h as w,d as z,M as C}from"./entry-index.D92NaooR.js";import{V as q,e as U,f as P,k as j,ah as E,af as R,$ as M,v as L,g as D,W as A,z as O,A as $,ac as N,ad as I,Z as S,ab as T,a1 as F,an as B,T as J,_ as W,h as K,j as H,l as X,ax as Z,ay as G,aa as Q,q as Y,aw as ee,az as ae,B as le,w as te,r as se}from"./chunk-vue-core.CxEQweee.js";import"./chunk-utils-vendor.DVew6AbD.js";import"./chunk-chart-core.HkgdsJMe.js";const ie={class:"d-flex align-center"},ne={class:"text-h6",style:{"font-weight":"500"}},re={class:"d-flex justify-center"},de={key:0},ue={class:"text-h6 mb-4 d-flex align-center"},oe={class:"d-flex align-center"},ce={class:"d-flex align-center"},me={key:0},ve={class:"text-subtitle-1 mb-3 d-flex align-center"},pe={key:1},_e={class:"text-subtitle-1 mb-3 d-flex align-center"},fe={key:0},ye={class:"d-flex align-center mb-2"},ge={class:"font-weight-medium"},be={key:0,class:"text-body-2"},he={key:1},xe={class:"text-body-2"},ke={key:2},Ve={class:"text-body-2"},we={class:"text-h6 mb-4 d-flex align-center"},ze={class:"text-h6 mb-4 d-flex align-center"},Ce={key:0},qe={class:"text-body-1 font-weight-medium"},Ue={class:"text-body-1 font-weight-medium"},Pe={class:"text-body-1"},je={class:"text-body-1"},Ee={class:"text-body-1"},Re={class:"text-body-1"},Me={class:"text-body-1"},Le={class:"text-body-1"},De={key:1},Ae={key:0},Oe={class:"text-body-2 mb-3"},$e={class:"text-center pa-2 text-caption text-grey"},Ne={key:1,class:"text-center text-grey"},Ie={key:1},Se={class:"text-h6 mb-4 d-flex align-center"},Te={class:"text-h6 mb-4 d-flex align-center"},Fe={class:"text-h6 mb-4"},Be={key:0,class:"text-body-1"},Je={class:"text-h4 text-success"},We={class:"text-h4 text-info"},Ke={class:"text-h4 text-warning"},He={class:"text-h4 text-error"},Xe={key:0,class:"mt-4"},Ze=x({__name:"PrDialog",props:{modelValue:Boolean,pr:Object,isNew:Boolean,loading:Boolean,statusOptions:Array},emits:["update:modelValue","update:pr","save","close"],setup(f,{emit:y}){const g=f,b=y;k();const h=e(null),x=e(!1),z=e({}),C=e(1),Z=e("manual"),G=e(null),Q=e(null),Y=e(!1),ee=e(!1),ae=e(!1),le=e(!1),te=e(!1),se=e(""),Ze=e(null),Ge=a({get:()=>g.modelValue,set:e=>b("update:modelValue",e)}),Qe=a((()=>(new Date).toISOString().split("T")[0])),Ye=a((()=>{var e;if(g.isNew)return!0;const a=null==(e=z.value.status)?void 0:e.name;return["待提交","审批中"].includes(a)})),ea=a((()=>{var e;if(g.isNew)return!0;const a=null==(e=z.value.status)?void 0:e.name;return["待提交"].includes(a)})),aa=a((()=>{var e;if(g.isNew)return!1;const a=null==(e=z.value.status)?void 0:e.name;return["采购中","已到货"].includes(a)})),la=a((()=>{var e;if(g.isNew)return!0;const a=null==(e=z.value.status)?void 0:e.name;return!["已取消","已拒绝"].includes(a)})),ta=a((()=>!!g.isNew||(Ye.value||ea.value||aa.value||la.value))),sa=a((()=>{switch(C.value){case 1:return"manual"===Z.value||Q.value&&Q.value.is_valid;case 2:return"manual"!==Z.value||z.value.material_name&&z.value.quantity&&z.value.quantity>0;default:return!0}})),ia=a((()=>[{title:"物品名称",key:"material_name",sortable:!1},{title:"数量",key:"quantity",sortable:!1},{title:"品牌",key:"brand",sortable:!1},{title:"请购单号",key:"purchase_order_number",sortable:!1},{title:"规格",key:"specification",sortable:!1},{title:"需求日期",key:"required_date",sortable:!1}])),na={required:e=>!!e||"此字段为必填项",positive:e=>e>0||"数值必须大于0",maxLength:e=>a=>!a||a.length<=e||`最多${e}个字符`},ra=()=>{sa.value&&C.value<3&&("excel"===Z.value&&1===C.value?C.value=3:C.value++)},da=()=>{C.value>1&&("excel"===Z.value&&3===C.value?C.value=1:C.value--)},ua=async()=>{var e,a;try{ee.value=!0;const e=await V.get("/pr/excel/template",{responseType:"blob"}),a=new Blob([e.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),t=window.URL.createObjectURL(a),s=document.createElement("a");s.href=t,s.download="PR_Import_Template.xlsx",document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(t);try{const{Message:e}=await w((async()=>{const{Message:e}=await import("./entry-index.D92NaooR.js").then((e=>e.r));return{Message:e}}),__vite__mapDeps([0,1,2,3,4,5,6,7]),import.meta.url);e&&e.success&&e.success("模板下载成功")}catch(l){}}catch(t){try{const{Message:l}=await w((async()=>{const{Message:e}=await import("./entry-index.D92NaooR.js").then((e=>e.r));return{Message:e}}),__vite__mapDeps([0,1,2,3,4,5,6,7]),import.meta.url),s=(null==(a=null==(e=null==t?void 0:t.response)?void 0:e.data)?void 0:a.detail)||(null==t?void 0:t.message)||"未知错误";l&&l.error&&l.error("下载模板失败: "+s)}catch(l){}}finally{ee.value=!1}},oa=async()=>{let e=null;if(e=Array.isArray(G.value)?G.value[0]:G.value,e&&e instanceof File)try{ae.value=!0;const l=new FormData;l.append("file",e);for(let[e,a]of l.entries());0===e.size||e.size;const t=await V.post("/pr/excel/validate",l);if(Q.value=t.data,Q.value&&Q.value.is_valid)try{const{Message:e}=await w((async()=>{const{Message:e}=await import("./entry-index.D92NaooR.js").then((e=>e.r));return{Message:e}}),__vite__mapDeps([0,1,2,3,4,5,6,7]),import.meta.url),a=Q.value.data?Q.value.data.length:0;e&&e.success&&e.success(`文件验证成功，发现 ${a} 条有效数据`)}catch(a){}}catch(l){let e="未知错误";try{if(l&&"object"==typeof l)if(l.response&&l.response.data){const a=l.response.data;422===l.response.status&&a.detail?Array.isArray(a.detail)?e=a.detail.map((e=>"object"==typeof e&&e.msg?e.msg:"string"==typeof e?e:String(e))).join(", "):"string"==typeof a.detail?e=a.detail:"object"==typeof a.detail&&a.detail.msg&&(e=a.detail.msg):a.detail?e="string"==typeof a.detail?a.detail:a.detail.msg||JSON.stringify(a.detail):a.message&&(e=a.message)}else l.message&&(e=l.message);else"string"==typeof l&&(e=l)}catch(t){e="解析错误信息失败"}try{const{Message:a}=await w((async()=>{const{Message:e}=await import("./entry-index.D92NaooR.js").then((e=>e.r));return{Message:e}}),__vite__mapDeps([0,1,2,3,4,5,6,7]),import.meta.url);a&&a.error&&a.error("验证文件失败: "+e)}catch(a){}Q.value=null}finally{ae.value=!1}else Q.value=null},ca=e=>{if(!e)return"";return new Date(e).toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric"})},ma=async()=>{if("manual"===Z.value){const{valid:e}=await h.value.validate();if(!e)return;b("save",z.value)}else await va()},va=async()=>{if(Q.value&&Q.value.is_valid)try{le.value=!0;const a=Array.isArray(G.value)?G.value[0]:G.value,l=new FormData;l.append("file",a),l.append("overwrite_existing",Y.value.toString());for(let[e,s]of l.entries());const t=await V.post("/pr/excel/import",l);try{const{Message:e}=await w((async()=>{const{Message:e}=await import("./entry-index.D92NaooR.js").then((e=>e.r));return{Message:e}}),__vite__mapDeps([0,1,2,3,4,5,6,7]),import.meta.url);if(t.data.success){const a=`导入成功！${t.data.message||""}`,l=[];t.data.imported_rows&&l.push(`新增: ${t.data.imported_rows}条`),t.data.updated_rows&&l.push(`更新: ${t.data.updated_rows}条`),t.data.skipped_rows&&l.push(`跳过: ${t.data.skipped_rows}条`);const s=l.length>0?`${a} (${l.join(", ")})`:a;e&&e.success&&e.success(s),te.value=!0,se.value=s,Ze.value=t.data}else{const a=t.data.message||"导入失败";e&&e.error&&e.error(a)}}catch(e){}}catch(a){let t="未知错误";try{if(a&&"object"==typeof a)if(a.response&&a.response.data){const e=a.response.data;422===a.response.status&&e.detail?Array.isArray(e.detail)?t=e.detail.map((e=>"object"==typeof e&&e.msg?e.msg:"string"==typeof e?e:String(e))).join(", "):"string"==typeof e.detail?t=e.detail:"object"==typeof e.detail&&e.detail.msg&&(t=e.detail.msg):e.detail?t="string"==typeof e.detail?e.detail:e.detail.msg||JSON.stringify(e.detail):e.message&&(t=e.message)}else a.message&&(t=a.message);else"string"==typeof a&&(t=a)}catch(l){t="解析错误信息失败"}try{const{Message:e}=await w((async()=>{const{Message:e}=await import("./entry-index.D92NaooR.js").then((e=>e.r));return{Message:e}}),__vite__mapDeps([0,1,2,3,4,5,6,7]),import.meta.url);e&&e.error&&e.error("导入数据失败: "+t)}catch(e){}}finally{le.value=!1}else{const{Message:e}=await w((async()=>{const{Message:e}=await import("./entry-index.D92NaooR.js").then((e=>e.r));return{Message:e}}),__vite__mapDeps([0,1,2,3,4,5,6,7]),import.meta.url);e.error("请先上传并验证Excel文件")}},pa=()=>{C.value=1,Z.value="manual",G.value=null,Q.value=null,Y.value=!1,te.value=!1,se.value="",Ze.value=null,b("close")},_a=()=>{te.value=!1,setTimeout((()=>{pa(),b("save",{isExcelImport:!0,result:Ze.value})}),300)};return l((()=>g.pr),(e=>{e&&(z.value={...e})}),{immediate:!0,deep:!0}),l(Ge,(e=>{e&&(C.value=1,h.value&&h.value.resetValidation())})),(e,a)=>(s(),t(v,null,[i(X,{modelValue:Ge.value,"onUpdate:modelValue":a[25]||(a[25]=e=>Ge.value=e),"max-width":"900",persistent:"",scrollable:""},{default:n((()=>[i(q,{class:"pr-dialog-card"},{default:n((()=>[i(U,{class:"d-flex justify-space-between align-center pa-4",style:{"background-color":"#1976d2 !important"}},{default:n((()=>[u("div",ie,[i(P,{icon:f.isNew?"mdi-plus-circle":"mdi-pencil-circle",class:"mr-2"},null,8,["icon"]),u("span",ne,o(f.isNew?"新建采购申请":"编辑采购申请"),1)]),i(j,{icon:"mdi-close",variant:"text",onClick:pa})])),_:1}),f.isNew?(s(),r(E,{key:0,class:"pa-3 bg-grey-lighten-5"},{default:n((()=>[u("div",re,[i(R,{modelValue:C.value,"onUpdate:modelValue":a[0]||(a[0]=e=>C.value=e),mandatory:""},{default:n((()=>[i(M,{value:1,color:C.value>=1?"primary":"grey",variant:1===C.value?"flat":"outlined",class:"mx-2"},{default:n((()=>[i(P,{start:"",icon:"manual"===Z.value?"mdi-information":"mdi-file-excel"},null,8,["icon"]),c(" "+o("manual"===Z.value?"基本信息":"Excel导入"),1)])),_:1},8,["color","variant"]),"manual"===Z.value?(s(),r(M,{key:0,value:2,color:C.value>=2?"primary":"grey",variant:2===C.value?"flat":"outlined",class:"mx-2"},{default:n((()=>[i(P,{start:"",icon:"mdi-package-variant"}),a[27]||(a[27]=c(" 物品详情 "))])),_:1,__:[27]},8,["color","variant"])):d("",!0),i(M,{value:3,color:C.value>=3?"primary":"grey",variant:3===C.value?"flat":"outlined",class:"mx-2"},{default:n((()=>[i(P,{start:"",icon:"mdi-check-circle"}),c(" "+o("manual"===Z.value?"确认提交":"确认导入"),1)])),_:1},8,["color","variant"])])),_:1},8,["modelValue"])])])),_:1})):d("",!0),i(L),i(D,{class:"pa-6"},{default:n((()=>[i(A,{ref_key:"formRef",ref:h,modelValue:x.value,"onUpdate:modelValue":a[24]||(a[24]=e=>x.value=e)},{default:n((()=>[f.isNew?(s(),t("div",de,[m(u("div",null,[u("div",ue,[i(P,{icon:"mdi-information",class:"mr-2",color:"primary"}),a[28]||(a[28]=c(" 创建方式 "))]),i(O,{class:"mb-4"},{default:n((()=>[i($,{cols:"12"},{default:n((()=>[i(q,{variant:"outlined",class:"pa-4"},{default:n((()=>[i(U,{class:"text-subtitle-1 pa-0 mb-3"},{default:n((()=>a[29]||(a[29]=[c(" 请选择创建方式 ")]))),_:1,__:[29]}),i(N,{modelValue:Z.value,"onUpdate:modelValue":a[1]||(a[1]=e=>Z.value=e),inline:""},{default:n((()=>[i(I,{value:"manual",label:"手动创建",color:"primary"},{label:n((()=>[u("div",oe,[i(P,{icon:"mdi-pencil",class:"mr-2"}),a[31]||(a[31]=u("span",null,"手动创建",-1)),i(M,{size:"small",color:"info",variant:"outlined",class:"ml-2"},{default:n((()=>a[30]||(a[30]=[c(" 单个 ")]))),_:1,__:[30]})])])),_:1}),i(I,{value:"excel",label:"Excel导入",color:"success"},{label:n((()=>[u("div",ce,[i(P,{icon:"mdi-file-excel",class:"mr-2"}),a[33]||(a[33]=u("span",null,"Excel导入",-1)),i(M,{size:"small",color:"success",variant:"outlined",class:"ml-2"},{default:n((()=>a[32]||(a[32]=[c(" 批量 ")]))),_:1,__:[32]})])])),_:1})])),_:1},8,["modelValue"])])),_:1})])),_:1})])),_:1}),"manual"===Z.value?(s(),t("div",me,[u("div",ve,[i(P,{icon:"mdi-information-outline",class:"mr-2",color:"primary"}),a[34]||(a[34]=c(" 基本信息 "))]),i(O,null,{default:n((()=>[i($,{cols:"12",md:"6"},{default:n((()=>[i(S,{modelValue:z.value.required_date,"onUpdate:modelValue":a[2]||(a[2]=e=>z.value.required_date=e),label:"需求日期",type:"date",variant:"outlined",density:"comfortable","prepend-inner-icon":"mdi-calendar",hint:"请选择您希望收到物品的日期","persistent-hint":"",min:Qe.value},null,8,["modelValue","min"])])),_:1}),i($,{cols:"12",md:"6"},{default:n((()=>[i(S,{modelValue:z.value.purchase_order_number,"onUpdate:modelValue":a[3]||(a[3]=e=>z.value.purchase_order_number=e),label:"请购单号",variant:"outlined",density:"comfortable","prepend-inner-icon":"mdi-file-document-outline",placeholder:"请输入请购单号（可选）",hint:"外部系统或供应商的请购单号","persistent-hint":"",clearable:""},null,8,["modelValue"])])),_:1}),i($,{cols:"12"},{default:n((()=>[i(T,{modelValue:z.value.description,"onUpdate:modelValue":a[4]||(a[4]=e=>z.value.description=e),label:"申请说明(可选)",rows:"3",variant:"outlined",density:"comfortable","prepend-inner-icon":"mdi-text",placeholder:"请简要说明申请原因、用途等...",counter:"500",rules:[na.maxLength(500)]},null,8,["modelValue","rules"])])),_:1})])),_:1})])):d("",!0),"excel"===Z.value?(s(),t("div",pe,[u("div",_e,[i(P,{icon:"mdi-file-excel",class:"mr-2",color:"success"}),a[35]||(a[35]=c(" Excel文件导入 "))]),i(O,{class:"mb-4"},{default:n((()=>[i($,{cols:"12"},{default:n((()=>[i(F,{type:"info",variant:"tonal",class:"mb-3"},{prepend:n((()=>[i(P,{icon:"mdi-information"})])),default:n((()=>[a[36]||(a[36]=u("div",null,[u("strong",null,"使用说明："),u("ol",{class:"mt-2"},[u("li",null,"点击下载模板按钮获取Excel模板文件"),u("li",null,"在模板中填写PR信息（物品名称和数量为必填项）"),u("li",null,"上传填写完成的Excel文件进行导入")])],-1))])),_:1,__:[36]}),i(j,{color:"info",variant:"outlined","prepend-icon":"mdi-download",onClick:ua,loading:ee.value,class:"mb-3"},{default:n((()=>a[37]||(a[37]=[c(" 下载Excel模板 ")]))),_:1,__:[37]},8,["loading"])])),_:1})])),_:1}),i(O,null,{default:n((()=>[i($,{cols:"12"},{default:n((()=>[i(B,{modelValue:G.value,"onUpdate:modelValue":[a[5]||(a[5]=e=>G.value=e),oa],label:"选择Excel文件",accept:".xlsx,.xls",variant:"outlined",density:"comfortable","prepend-inner-icon":"mdi-file-excel",rules:[na.required],onChange:oa,clearable:"",loading:ae.value,multiple:!1},null,8,["modelValue","rules","loading"])])),_:1})])),_:1}),Q.value?(s(),t("div",fe,[i(q,{color:Q.value.is_valid?"success":"error",variant:"tonal",class:"mt-3"},{default:n((()=>[i(D,null,{default:n((()=>[u("div",ye,[i(P,{icon:Q.value.is_valid?"mdi-check-circle":"mdi-alert-circle",class:"mr-2"},null,8,["icon"]),u("span",ge,o(Q.value.is_valid?"验证通过":"验证失败"),1)]),Q.value.is_valid?(s(),t("div",be," 共发现 "+o(Q.value.data.length)+" 条有效数据 ",1)):d("",!0),Q.value.errors.length>0?(s(),t("div",he,[a[38]||(a[38]=u("div",{class:"text-body-2 font-weight-medium mb-1"},"错误信息：",-1)),u("ul",xe,[(s(!0),t(v,null,p(Q.value.errors,(e=>(s(),t("li",{key:e},o(e),1)))),128))])])):d("",!0),Q.value.warnings.length>0?(s(),t("div",ke,[a[39]||(a[39]=u("div",{class:"text-body-2 font-weight-medium mb-1 mt-2"},"警告信息：",-1)),u("ul",Ve,[(s(!0),t(v,null,p(Q.value.warnings,(e=>(s(),t("li",{key:e},o(e),1)))),128))])])):d("",!0)])),_:1})])),_:1},8,["color"])])):d("",!0)])):d("",!0)],512),[[_,1===C.value]]),m(u("div",null,[u("div",we,[i(P,{icon:"mdi-package-variant",class:"mr-2",color:"primary"}),a[40]||(a[40]=c(" 物品详情 "))]),i(O,null,{default:n((()=>[i($,{cols:"12",md:"6"},{default:n((()=>[i(S,{modelValue:z.value.material_name,"onUpdate:modelValue":a[6]||(a[6]=e=>z.value.material_name=e),label:"物品名称",rules:[na.required],variant:"outlined",density:"comfortable","prepend-inner-icon":"mdi-package",placeholder:"请输入物品名称",clearable:""},null,8,["modelValue","rules"])])),_:1}),i($,{cols:"12",md:"6"},{default:n((()=>[i(S,{modelValue:z.value.brand,"onUpdate:modelValue":a[7]||(a[7]=e=>z.value.brand=e),label:"品牌",variant:"outlined",density:"comfortable","prepend-inner-icon":"mdi-tag",placeholder:"请输入品牌名称",clearable:""},null,8,["modelValue"])])),_:1}),i($,{cols:"12",md:"6"},{default:n((()=>[i(S,{modelValue:z.value.material_code,"onUpdate:modelValue":a[8]||(a[8]=e=>z.value.material_code=e),label:"物料编码",variant:"outlined",density:"comfortable","prepend-inner-icon":"mdi-barcode",placeholder:"请输入物料编码（可选）",clearable:"",hint:"如果知道物料编码，请填写以便快速识别","persistent-hint":""},null,8,["modelValue"])])),_:1}),i($,{cols:"12",md:"6"},{default:n((()=>[i(S,{modelValue:z.value.quantity,"onUpdate:modelValue":a[9]||(a[9]=e=>z.value.quantity=e),modelModifiers:{number:!0},label:"数量",type:"number",min:"0",step:"0.01",rules:[na.required,na.positive],variant:"outlined",density:"comfortable","prepend-inner-icon":"mdi-counter",placeholder:"请输入数量"},null,8,["modelValue","rules"])])),_:1}),i($,{cols:"12"},{default:n((()=>[i(T,{modelValue:z.value.specification,"onUpdate:modelValue":a[10]||(a[10]=e=>z.value.specification=e),label:"规格说明",rows:"3",variant:"outlined",density:"comfortable","prepend-inner-icon":"mdi-format-list-bulleted",placeholder:"请详细描述物品的规格、型号、技术参数等...",counter:"1000",rules:[na.maxLength(1e3)]},null,8,["modelValue","rules"])])),_:1})])),_:1})],512),[[_,2===C.value&&"manual"===Z.value]]),m(u("div",null,[u("div",ze,[i(P,{icon:"mdi-check-circle",class:"mr-2",color:"primary"}),a[41]||(a[41]=c(" 确认信息 "))]),"manual"===Z.value?(s(),t("div",Ce,[i(q,{class:"mb-4"},{default:n((()=>[i(U,{class:"text-subtitle-1 bg-grey-lighten-4"},{default:n((()=>[i(P,{icon:"mdi-eye",class:"mr-2"}),a[42]||(a[42]=c(" 申请信息预览 "))])),_:1,__:[42]}),i(D,{class:"pa-4"},{default:n((()=>[i(O,null,{default:n((()=>[i($,{cols:"12",md:"6"},{default:n((()=>[a[43]||(a[43]=u("div",{class:"text-caption text-grey"},"物品名称",-1)),u("div",qe,o(z.value.material_name||"未填写"),1)])),_:1,__:[43]}),i($,{cols:"12",md:"6"},{default:n((()=>[a[44]||(a[44]=u("div",{class:"text-caption text-grey"},"数量",-1)),u("div",Ue,o(z.value.quantity||"未填写"),1)])),_:1,__:[44]}),i($,{cols:"12",md:"6"},{default:n((()=>[a[45]||(a[45]=u("div",{class:"text-caption text-grey"},"品牌",-1)),u("div",Pe,o(z.value.brand||"未填写"),1)])),_:1,__:[45]}),i($,{cols:"12",md:"6"},{default:n((()=>[a[46]||(a[46]=u("div",{class:"text-caption text-grey"},"需求日期",-1)),u("div",je,o(ca(z.value.required_date)||"未填写"),1)])),_:1,__:[46]}),z.value.material_code?(s(),r($,{key:0,cols:"12"},{default:n((()=>[a[47]||(a[47]=u("div",{class:"text-caption text-grey"},"物料编码",-1)),u("div",Ee,o(z.value.material_code),1)])),_:1,__:[47]})):d("",!0),z.value.purchase_order_number?(s(),r($,{key:1,cols:"12"},{default:n((()=>[a[48]||(a[48]=u("div",{class:"text-caption text-grey"},"请购单号",-1)),u("div",Re,o(z.value.purchase_order_number),1)])),_:1,__:[48]})):d("",!0),z.value.specification?(s(),r($,{key:2,cols:"12"},{default:n((()=>[a[49]||(a[49]=u("div",{class:"text-caption text-grey"},"规格说明",-1)),u("div",Me,o(z.value.specification),1)])),_:1,__:[49]})):d("",!0),z.value.description?(s(),r($,{key:3,cols:"12"},{default:n((()=>[a[50]||(a[50]=u("div",{class:"text-caption text-grey"},"申请说明",-1)),u("div",Le,o(z.value.description),1)])),_:1,__:[50]})):d("",!0)])),_:1})])),_:1})])),_:1}),i(T,{modelValue:z.value.remarks,"onUpdate:modelValue":a[11]||(a[11]=e=>z.value.remarks=e),label:"备注信息",rows:"3",density:"comfortable","prepend-inner-icon":"mdi-note-text",counter:"500",rules:[na.maxLength(500)]},null,8,["modelValue","rules"])])):d("",!0),"excel"===Z.value?(s(),t("div",De,[i(q,{class:"mb-4"},{default:n((()=>[i(U,{class:"text-subtitle-1 bg-grey-lighten-4"},{default:n((()=>[i(P,{icon:"mdi-file-excel",class:"mr-2"}),a[51]||(a[51]=c(" 导入数据预览 "))])),_:1,__:[51]}),i(D,{class:"pa-4"},{default:n((()=>[Q.value&&Q.value.is_valid?(s(),t("div",Ae,[u("div",Oe,[a[52]||(a[52]=c(" 即将导入 ")),u("strong",null,o(Q.value.data.length),1),a[53]||(a[53]=c(" 条PR记录 "))]),i(J,{headers:ia.value,items:Q.value.data.slice(0,5),density:"compact",class:"border","hide-default-footer":""},{bottom:n((()=>[u("div",$e,o(Q.value.data.length>5?`仅显示前5条，共${Q.value.data.length}条`:`共${Q.value.data.length}条`),1)])),_:1},8,["headers","items"])])):(s(),t("div",Ne," 请先上传并验证Excel文件 "))])),_:1})])),_:1}),i(q,null,{default:n((()=>[i(U,{class:"text-subtitle-1 bg-grey-lighten-4"},{default:n((()=>[i(P,{icon:"mdi-cog",class:"mr-2"}),a[54]||(a[54]=c(" 导入选项 "))])),_:1,__:[54]}),i(D,{class:"pa-4"},{default:n((()=>[i(W,{modelValue:Y.value,"onUpdate:modelValue":a[12]||(a[12]=e=>Y.value=e),label:"覆盖已存在的相同物品申请",density:"compact",color:"warning"},null,8,["modelValue"]),a[55]||(a[55]=u("div",{class:"text-caption text-grey mt-1"}," 如果勾选，将更新已存在的相同物品名称的待提交状态PR；否则跳过重复项 ",-1))])),_:1,__:[55]})])),_:1})])):d("",!0)],512),[[_,3===C.value]])])):(s(),t("div",Ie,[i(O,null,{default:n((()=>[i($,{cols:"12"},{default:n((()=>[u("div",Se,[i(P,{icon:"mdi-information",class:"mr-2",color:"primary"}),a[56]||(a[56]=c(" 基本信息 "))])])),_:1}),i($,{cols:"12",md:"6"},{default:n((()=>[i(S,{modelValue:z.value.required_date,"onUpdate:modelValue":a[13]||(a[13]=e=>z.value.required_date=e),label:"需求日期",type:"date",variant:"outlined",density:"comfortable","prepend-inner-icon":"mdi-calendar",readonly:!Ye.value,hint:Ye.value?"请选择您希望收到物品的日期":"当前状态下不可编辑","persistent-hint":""},null,8,["modelValue","readonly","hint"])])),_:1}),i($,{cols:"12",md:"6"},{default:n((()=>[i(S,{modelValue:z.value.approved_date,"onUpdate:modelValue":a[14]||(a[14]=e=>z.value.approved_date=e),label:"批准时间",type:"datetime-local",variant:"outlined",density:"comfortable",readonly:"",hint:"状态变更为已批准时自动记录","persistent-hint":""},null,8,["modelValue"])])),_:1}),i($,{cols:"12",md:"6"},{default:n((()=>[i(S,{modelValue:z.value.purchase_order_number,"onUpdate:modelValue":a[15]||(a[15]=e=>z.value.purchase_order_number=e),label:"请购单号",variant:"outlined",density:"comfortable","prepend-inner-icon":"mdi-file-document-outline",readonly:!Ye.value,placeholder:Ye.value?"请输入请购单号（可选）":"当前状态下不可编辑",hint:Ye.value?"外部系统或供应商的请购单号":"当前状态下不可编辑","persistent-hint":"",clearable:Ye.value},null,8,["modelValue","readonly","placeholder","hint","clearable"])])),_:1}),i($,{cols:"12",md:"6"},{default:n((()=>[i(S,{modelValue:z.value.delivery_date,"onUpdate:modelValue":a[16]||(a[16]=e=>z.value.delivery_date=e),label:"到货时间",type:"datetime-local",variant:"outlined",density:"comfortable",readonly:!aa.value,hint:aa.value?"可手动修改到货时间":"状态变更为已到货时自动记录","persistent-hint":""},null,8,["modelValue","readonly","hint"])])),_:1}),i($,{cols:"12"},{default:n((()=>[i(T,{modelValue:z.value.description,"onUpdate:modelValue":a[17]||(a[17]=e=>z.value.description=e),label:"申请说明(可选)",rows:"2",variant:"outlined",density:"comfortable","prepend-inner-icon":"mdi-text",readonly:!Ye.value,placeholder:Ye.value?"请简要说明申请原因、用途等...":"当前状态下不可编辑"},null,8,["modelValue","readonly","placeholder"])])),_:1}),i($,{cols:"12"},{default:n((()=>[u("div",Te,[i(P,{icon:"mdi-package-variant",class:"mr-2",color:"primary"}),a[57]||(a[57]=c(" 物品信息 "))])])),_:1}),i($,{cols:"12",md:"6"},{default:n((()=>[i(S,{modelValue:z.value.material_name,"onUpdate:modelValue":a[18]||(a[18]=e=>z.value.material_name=e),label:"物品名称",rules:[na.required],variant:"outlined",density:"comfortable","prepend-inner-icon":"mdi-package",readonly:!ea.value,placeholder:ea.value?"请输入物品名称":"当前状态下不可编辑"},null,8,["modelValue","rules","readonly","placeholder"])])),_:1}),i($,{cols:"12",md:"6"},{default:n((()=>[i(S,{modelValue:z.value.brand,"onUpdate:modelValue":a[19]||(a[19]=e=>z.value.brand=e),label:"品牌",variant:"outlined",density:"comfortable","prepend-inner-icon":"mdi-tag",readonly:!ea.value,placeholder:ea.value?"请输入品牌名称":"当前状态下不可编辑"},null,8,["modelValue","readonly","placeholder"])])),_:1}),i($,{cols:"12",md:"6"},{default:n((()=>[i(S,{modelValue:z.value.material_code,"onUpdate:modelValue":a[20]||(a[20]=e=>z.value.material_code=e),label:"物料编码",variant:"outlined",density:"comfortable","prepend-inner-icon":"mdi-barcode",readonly:!ea.value,clearable:ea.value,placeholder:ea.value?"请输入物料编码（可选）":"当前状态下不可编辑"},null,8,["modelValue","readonly","clearable","placeholder"])])),_:1}),i($,{cols:"12",md:"6"},{default:n((()=>[i(S,{modelValue:z.value.quantity,"onUpdate:modelValue":a[21]||(a[21]=e=>z.value.quantity=e),modelModifiers:{number:!0},label:"数量",type:"number",min:"0",step:"0.01",rules:[na.required,na.positive],variant:"outlined",density:"comfortable","prepend-inner-icon":"mdi-counter",readonly:!ea.value,placeholder:ea.value?"请输入数量":"当前状态下不可编辑"},null,8,["modelValue","rules","readonly","placeholder"])])),_:1}),i($,{cols:"12"},{default:n((()=>[i(T,{modelValue:z.value.specification,"onUpdate:modelValue":a[22]||(a[22]=e=>z.value.specification=e),label:"规格说明",rows:"3",variant:"outlined",density:"comfortable","prepend-inner-icon":"mdi-format-list-bulleted",readonly:!ea.value,placeholder:ea.value?"请详细描述物品的规格、型号、技术参数等...":"当前状态下不可编辑"},null,8,["modelValue","readonly","placeholder"])])),_:1}),i($,{cols:"12"},{default:n((()=>[i(T,{modelValue:z.value.remarks,"onUpdate:modelValue":a[23]||(a[23]=e=>z.value.remarks=e),label:"备注",rows:"2",variant:"outlined",density:"comfortable","prepend-inner-icon":"mdi-note-text",placeholder:la.value?"可填写特殊要求、紧急程度等说明":"当前状态下不可编辑",readonly:!la.value},null,8,["modelValue","placeholder","readonly"])])),_:1})])),_:1})]))])),_:1},8,["modelValue"])])),_:1}),i(L),i(K,{class:"pa-4 bg-grey-lighten-5"},{default:n((()=>[i(H),f.isNew?(s(),t(v,{key:0},[i(j,{variant:"outlined",onClick:pa},{default:n((()=>[i(P,{icon:"mdi-close",class:"mr-1"}),a[58]||(a[58]=c(" 取消 "))])),_:1,__:[58]}),C.value>1?(s(),r(j,{key:0,variant:"outlined",color:"primary",onClick:da,class:"ml-2"},{default:n((()=>[i(P,{icon:"mdi-chevron-left",class:"mr-1"}),a[59]||(a[59]=c(" 上一步 "))])),_:1,__:[59]})):d("",!0),C.value<3?(s(),r(j,{key:1,color:"primary",disabled:!sa.value,onClick:ra,class:"ml-2"},{default:n((()=>[a[60]||(a[60]=c(" 下一步 ")),i(P,{icon:"mdi-chevron-right",class:"ml-1"})])),_:1,__:[60]},8,["disabled"])):d("",!0),3===C.value?(s(),r(j,{key:2,color:"success",loading:"manual"===Z.value?f.loading:le.value,disabled:"manual"===Z.value?!x.value:!Q.value||!Q.value.is_valid,onClick:ma,class:"ml-2"},{default:n((()=>[i(P,{icon:"manual"===Z.value?"mdi-check":"mdi-upload",class:"mr-1"},null,8,["icon"]),c(" "+o("manual"===Z.value?"提交申请":"开始导入"),1)])),_:1},8,["loading","disabled"])):d("",!0)],64)):(s(),t(v,{key:1},[i(j,{variant:"outlined",onClick:pa},{default:n((()=>[i(P,{icon:"mdi-close",class:"mr-1"}),a[61]||(a[61]=c(" 取消 "))])),_:1,__:[61]}),ta.value?(s(),r(j,{key:0,color:"primary",loading:f.loading,disabled:!x.value,onClick:ma,class:"ml-2"},{default:n((()=>[i(P,{icon:"mdi-content-save",class:"mr-1"}),a[62]||(a[62]=c(" 保存更改 "))])),_:1,__:[62]},8,["loading","disabled"])):(s(),r(j,{key:1,color:"grey",disabled:"",class:"ml-2"},{default:n((()=>[i(P,{icon:"mdi-lock",class:"mr-1"}),a[63]||(a[63]=c(" 当前状态不可编辑 "))])),_:1,__:[63]}))],64))])),_:1})])),_:1})])),_:1},8,["modelValue"]),i(X,{modelValue:te.value,"onUpdate:modelValue":a[26]||(a[26]=e=>te.value=e),"max-width":"500",persistent:""},{default:n((()=>[i(q,null,{default:n((()=>[i(U,{class:"text-h5 text-center pa-6"},{default:n((()=>[i(P,{icon:"mdi-check-circle",color:"success",size:"48",class:"mb-2"}),a[64]||(a[64]=u("div",{class:"text-success"},"导入成功！",-1))])),_:1,__:[64]}),i(D,{class:"text-center pa-6"},{default:n((()=>[u("div",Fe,o(se.value),1),Ze.value?(s(),t("div",Be,[i(O,{class:"text-center"},{default:n((()=>[i($,{cols:"3"},{default:n((()=>[u("div",Je,o(Ze.value.imported_rows||0),1),a[65]||(a[65]=u("div",{class:"text-caption"},"新增",-1))])),_:1,__:[65]}),i($,{cols:"3"},{default:n((()=>[u("div",We,o(Ze.value.updated_rows||0),1),a[66]||(a[66]=u("div",{class:"text-caption"},"更新",-1))])),_:1,__:[66]}),i($,{cols:"3"},{default:n((()=>[u("div",Ke,o(Ze.value.skipped_rows||0),1),a[67]||(a[67]=u("div",{class:"text-caption"},"跳过",-1))])),_:1,__:[67]}),i($,{cols:"3"},{default:n((()=>[u("div",He,o(Ze.value.error_rows||0),1),a[68]||(a[68]=u("div",{class:"text-caption"},"错误",-1))])),_:1,__:[68]})])),_:1}),Ze.value.created_pr_numbers&&Ze.value.created_pr_numbers.length>0?(s(),t("div",Xe,[i(L,{class:"mb-3"}),a[69]||(a[69]=u("div",{class:"text-subtitle-2 mb-2"},"创建的PR编号：",-1)),i(R,null,{default:n((()=>[(s(!0),t(v,null,p(Ze.value.created_pr_numbers,(e=>(s(),r(M,{key:e,size:"small",color:"primary",variant:"outlined"},{default:n((()=>[c(o(e),1)])),_:2},1024)))),128))])),_:1})])):d("",!0)])):d("",!0)])),_:1}),i(K,{class:"justify-center pa-6"},{default:n((()=>[i(j,{color:"success",variant:"elevated",size:"large",onClick:_a},{default:n((()=>[i(P,{icon:"mdi-check",class:"mr-2"}),a[70]||(a[70]=c(" 确定 "))])),_:1,__:[70]})])),_:1})])),_:1})])),_:1},8,["modelValue"])],64))}},[["__scopeId","data-v-37d67cce"]]),Ge={class:"d-flex align-center"},Qe={class:"info-item-large"},Ye={class:"info-label"},ea={class:"info-value-large"},aa={class:"info-item"},la={class:"info-label"},ta={class:"info-value"},sa={class:"info-item"},ia={class:"info-label"},na={class:"info-value"},ra={class:"info-item"},da={class:"info-label"},ua={class:"info-value"},oa={class:"info-item"},ca={class:"info-label"},ma={class:"info-value"},va={class:"info-item"},pa={class:"info-label"},_a={class:"info-value"},fa={class:"info-item"},ya={class:"info-label"},ga={class:"info-value"},ba={class:"info-item"},ha={class:"info-label"},xa={class:"info-value"},ka={class:"info-item"},Va={class:"info-label"},wa={class:"info-value"},za={class:"info-item"},Ca={class:"info-label"},qa={class:"info-value"},Ua={class:"info-item"},Pa={class:"info-label"},ja={class:"info-value text-success"},Ea={class:"info-item"},Ra={class:"info-label"},Ma={class:"info-value text-orange"},La={class:"text-caption text-medium-emphasis"},Da={class:"text-caption text-medium-emphasis"},Aa={class:"text-caption text-medium-emphasis"},Oa={class:"text-caption text-medium-emphasis"},$a={class:"text-caption text-medium-emphasis"},Na={class:"text-caption text-medium-emphasis"},Ia=x({__name:"PrDetailDialog",props:{modelValue:Boolean,pr:Object,statusOptions:Array},emits:["update:modelValue","status-change","close"],setup(l,{emit:t}){const m=l,v=t,p=e(null),_=e(""),y=e(!1),g=a({get:()=>m.modelValue,set:e=>v("update:modelValue",e)}),b=a((()=>!0)),h=e=>(null==e?void 0:e.color)?e.color:"grey",x=e=>{var a;if(!e)return"mdi-help-circle";switch(null==(a=e.name)?void 0:a.toLowerCase()){case"待提交":return"mdi-file-document-outline";case"待审批":case"审批中":return"mdi-clock-outline";case"已批准":case"已审批":return"mdi-check-circle";case"已下单":case"采购中":return"mdi-cart";case"已到货":return"mdi-truck-delivery";case"已完成":return"mdi-check-all";case"已拒绝":return"mdi-close-circle";default:return"mdi-help-circle"}},k=e=>e?new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",V=async()=>{if(p.value){y.value=!0;try{await v("status-change",{status_id:p.value,comments:_.value}),p.value=null,_.value=""}finally{y.value=!1}}},w=()=>{p.value=null,_.value="",v("close")};return(e,a)=>(s(),r(X,{modelValue:g.value,"onUpdate:modelValue":a[2]||(a[2]=e=>g.value=e),"max-width":"900",persistent:""},{default:n((()=>[l.pr?(s(),r(q,{key:0},{default:n((()=>[i(U,{class:"d-flex justify-space-between align-center"},{default:n((()=>[u("div",Ge,[a[3]||(a[3]=u("span",{class:"text-h6"},"请购单详情",-1)),i(M,{color:h(l.pr.status),size:"small",variant:"flat",class:"ml-3","prepend-icon":x(l.pr.status)},{default:n((()=>{var e;return[c(o(null==(e=l.pr.status)?void 0:e.name),1)]})),_:1},8,["color","prepend-icon"]),i(M,{color:"info",size:"small",variant:"outlined",class:"ml-2"},{default:n((()=>[c(o(l.pr.pr_number),1)])),_:1})]),i(j,{icon:"mdi-close",variant:"text",onClick:w})])),_:1}),i(L),i(D,{class:"pa-0"},{default:n((()=>[i(q,{flat:"",class:"ma-4 mb-2",border:""},{default:n((()=>[i(U,{class:"d-flex align-center pa-4 bg-blue-grey-lighten-5"},{default:n((()=>[i(P,{class:"mr-2",color:"blue-grey"},{default:n((()=>a[4]||(a[4]=[c("mdi-package-variant")]))),_:1,__:[4]}),a[5]||(a[5]=u("span",{class:"text-subtitle-1 font-weight-medium"},"物料信息",-1))])),_:1,__:[5]}),i(D,{class:"pa-4"},{default:n((()=>[i(O,{dense:""},{default:n((()=>[i($,{cols:"12"},{default:n((()=>[u("div",Qe,[u("div",Ye,[i(P,{size:"small",class:"mr-1"},{default:n((()=>a[6]||(a[6]=[c("mdi-tag")]))),_:1,__:[6]}),a[7]||(a[7]=c(" 物料名称 "))]),u("div",ea,o(l.pr.material_name||"-"),1)])])),_:1}),i($,{cols:"12",md:"6"},{default:n((()=>[u("div",aa,[u("div",la,[i(P,{size:"small",class:"mr-1"},{default:n((()=>a[8]||(a[8]=[c("mdi-barcode")]))),_:1,__:[8]}),a[9]||(a[9]=c(" 物料编码 "))]),u("div",ta,o(l.pr.material_code||"-"),1)])])),_:1}),i($,{cols:"12",md:"6"},{default:n((()=>[u("div",sa,[u("div",ia,[i(P,{size:"small",class:"mr-1"},{default:n((()=>a[10]||(a[10]=[c("mdi-counter")]))),_:1,__:[10]}),a[11]||(a[11]=c(" 数量 "))]),u("div",na,o(l.pr.quantity||0),1)])])),_:1}),i($,{cols:"12",md:"6"},{default:n((()=>[u("div",ra,[u("div",da,[i(P,{size:"small",class:"mr-1"},{default:n((()=>a[12]||(a[12]=[c("mdi-star")]))),_:1,__:[12]}),a[13]||(a[13]=c(" 品牌 "))]),u("div",ua,o(l.pr.brand||"-"),1)])])),_:1}),i($,{cols:"12",md:"6"},{default:n((()=>[u("div",oa,[u("div",ca,[i(P,{size:"small",class:"mr-1"},{default:n((()=>a[14]||(a[14]=[c("mdi-ruler")]))),_:1,__:[14]}),a[15]||(a[15]=c(" 规格 "))]),u("div",ma,o(l.pr.specification||"-"),1)])])),_:1}),l.pr.purchase_order_number?(s(),r($,{key:0,cols:"12",md:"6"},{default:n((()=>[u("div",va,[u("div",pa,[i(P,{size:"small",class:"mr-1"},{default:n((()=>a[16]||(a[16]=[c("mdi-file-document-outline")]))),_:1,__:[16]}),a[17]||(a[17]=c(" 请购单号 "))]),u("div",_a,o(l.pr.purchase_order_number),1)])])),_:1})):d("",!0),l.pr.description?(s(),r($,{key:1,cols:"12"},{default:n((()=>[u("div",fa,[u("div",ya,[i(P,{size:"small",class:"mr-1"},{default:n((()=>a[18]||(a[18]=[c("mdi-text")]))),_:1,__:[18]}),a[19]||(a[19]=c(" 详细描述 "))]),u("div",ga,o(l.pr.description),1)])])),_:1})):d("",!0),l.pr.remarks?(s(),r($,{key:2,cols:"12"},{default:n((()=>[u("div",ba,[u("div",ha,[i(P,{size:"small",class:"mr-1"},{default:n((()=>a[20]||(a[20]=[c("mdi-note-text")]))),_:1,__:[20]}),a[21]||(a[21]=c(" 备注 "))]),u("div",xa,o(l.pr.remarks),1)])])),_:1})):d("",!0)])),_:1})])),_:1})])),_:1}),i(q,{flat:"",class:"ma-4 mb-2",border:""},{default:n((()=>[i(U,{class:"d-flex align-center pa-4 bg-green-lighten-5"},{default:n((()=>[i(P,{class:"mr-2",color:"green"},{default:n((()=>a[22]||(a[22]=[c("mdi-clock-outline")]))),_:1,__:[22]}),a[23]||(a[23]=u("span",{class:"text-subtitle-1 font-weight-medium"},"时间信息",-1))])),_:1,__:[23]}),i(D,{class:"pa-4"},{default:n((()=>[i(O,{dense:""},{default:n((()=>[i($,{cols:"12",md:"6"},{default:n((()=>[u("div",ka,[u("div",Va,[i(P,{size:"small",class:"mr-1"},{default:n((()=>a[24]||(a[24]=[c("mdi-calendar-plus")]))),_:1,__:[24]}),a[25]||(a[25]=c(" 申请时间 "))]),u("div",wa,o(k(l.pr.requested_date)),1)])])),_:1}),i($,{cols:"12",md:"6"},{default:n((()=>{return[u("div",za,[u("div",Ca,[i(P,{size:"small",class:"mr-1"},{default:n((()=>a[26]||(a[26]=[c("mdi-calendar-clock")]))),_:1,__:[26]}),a[27]||(a[27]=c(" 需求时间 "))]),u("div",qa,o((e=l.pr.required_date,(e?new Date(e).toLocaleDateString("zh-CN"):"-")||"-")),1)])];var e})),_:1}),l.pr.approved_date?(s(),r($,{key:0,cols:"12",md:"6"},{default:n((()=>[u("div",Ua,[u("div",Pa,[i(P,{size:"small",class:"mr-1",color:"success"},{default:n((()=>a[28]||(a[28]=[c("mdi-check-circle")]))),_:1,__:[28]}),a[29]||(a[29]=c(" 批准时间 "))]),u("div",ja,o(k(l.pr.approved_date)),1)])])),_:1})):d("",!0),l.pr.delivery_date?(s(),r($,{key:1,cols:"12",md:"6"},{default:n((()=>[u("div",Ea,[u("div",Ra,[i(P,{size:"small",class:"mr-1",color:"orange"},{default:n((()=>a[30]||(a[30]=[c("mdi-truck-delivery")]))),_:1,__:[30]}),a[31]||(a[31]=c(" 到货时间 "))]),u("div",Ma,o(k(l.pr.delivery_date)),1)])])),_:1})):d("",!0)])),_:1})])),_:1})])),_:1}),i(q,{flat:"",class:"ma-4 mb-2",border:""},{default:n((()=>[i(U,{class:"d-flex align-center pa-4 bg-purple-lighten-5"},{default:n((()=>[i(P,{class:"mr-2",color:"purple"},{default:n((()=>a[32]||(a[32]=[c("mdi-timeline")]))),_:1,__:[32]}),a[33]||(a[33]=u("span",{class:"text-subtitle-1 font-weight-medium"},"进度时间轴",-1))])),_:1,__:[33]}),i(D,{class:"pa-4"},{default:n((()=>[i(Z,{density:"compact",side:"end",align:"start"},{default:n((()=>[i(G,{"dot-color":"primary",size:"small",icon:"mdi-file-document-plus"},{opposite:n((()=>[u("span",La,o(k(l.pr.requested_date)),1)])),default:n((()=>{var e;return[u("div",null,[a[34]||(a[34]=u("div",{class:"text-subtitle-2"},"申请提交",-1)),u("div",Da," 由 "+o(null==(e=l.pr.requester)?void 0:e.name)+" 提交申请 ",1)])]})),_:1}),l.pr.approved_date?(s(),r(G,{key:0,"dot-color":"success",size:"small",icon:"mdi-check-circle"},{opposite:n((()=>[u("span",Aa,o(k(l.pr.approved_date)),1)])),default:n((()=>[a[35]||(a[35]=u("div",null,[u("div",{class:"text-subtitle-2"},"申请批准"),u("div",{class:"text-caption text-medium-emphasis"}," 申请已通过审批 ")],-1))])),_:1,__:[35]})):d("",!0),l.pr.delivery_date?(s(),r(G,{key:1,"dot-color":"orange",size:"small",icon:"mdi-truck-delivery"},{opposite:n((()=>[u("span",Oa,o(k(l.pr.delivery_date)),1)])),default:n((()=>[a[36]||(a[36]=u("div",null,[u("div",{class:"text-subtitle-2"},"物品到货"),u("div",{class:"text-caption text-medium-emphasis"}," 物品已送达指定地点 ")],-1))])),_:1,__:[36]})):d("",!0),i(G,{"dot-color":h(l.pr.status),size:"small",icon:x(l.pr.status)},{opposite:n((()=>[u("span",$a,o(k(l.pr.updated_at)),1)])),default:n((()=>{var e;return[u("div",null,[a[37]||(a[37]=u("div",{class:"text-subtitle-2"},"当前状态",-1)),u("div",Na,o(null==(e=l.pr.status)?void 0:e.name),1)])]})),_:1},8,["dot-color","icon"])])),_:1})])),_:1})])),_:1}),b.value?(s(),r(q,{key:0,flat:"",class:"ma-4 mb-2",border:""},{default:n((()=>[i(U,{class:"d-flex align-center pa-4 bg-orange-lighten-5"},{default:n((()=>[i(P,{class:"mr-2",color:"orange"},{default:n((()=>a[38]||(a[38]=[c("mdi-swap-horizontal")]))),_:1,__:[38]}),a[39]||(a[39]=u("span",{class:"text-subtitle-1 font-weight-medium"},"状态更改",-1))])),_:1,__:[39]}),i(D,{class:"pa-4"},{default:n((()=>[i(O,{dense:""},{default:n((()=>[i($,{cols:"12",md:"6"},{default:n((()=>[i(Q,{modelValue:p.value,"onUpdate:modelValue":a[0]||(a[0]=e=>p.value=e),items:l.statusOptions,"item-title":"name","item-value":"id",label:"新状态",variant:"outlined",density:"compact","prepend-inner-icon":"mdi-flag"},{item:n((({props:e,item:a})=>[i(Y,f(e,{"prepend-icon":x(a.raw)}),{prepend:n((()=>[i(P,{color:h(a.raw)},{default:n((()=>[c(o(x(a.raw)),1)])),_:2},1032,["color"])])),_:2},1040,["prepend-icon"])])),_:1},8,["modelValue","items"])])),_:1}),i($,{cols:"12"},{default:n((()=>[i(T,{modelValue:_.value,"onUpdate:modelValue":a[1]||(a[1]=e=>_.value=e),label:"变更备注",rows:"2",variant:"outlined",density:"compact","prepend-inner-icon":"mdi-comment-text"},null,8,["modelValue"])])),_:1}),i($,{cols:"12",class:"d-flex justify-end"},{default:n((()=>[i(j,{color:"primary",disabled:!p.value||p.value===l.pr.status_id,loading:y.value,"prepend-icon":"mdi-check",onClick:V},{default:n((()=>a[40]||(a[40]=[c(" 更改状态 ")]))),_:1,__:[40]},8,["disabled","loading"])])),_:1})])),_:1})])),_:1})])),_:1})):d("",!0)])),_:1}),i(L),i(K,{class:"pa-4"},{default:n((()=>[i(H),i(j,{onClick:w},{default:n((()=>a[41]||(a[41]=[c(" 关闭 ")]))),_:1,__:[41]})])),_:1})])),_:1})):d("",!0)])),_:1},8,["modelValue"]))}},[["__scopeId","data-v-d798dcd3"]]),Sa={class:"font-weight-medium"},Ta={class:"font-weight-medium"},Fa={class:"font-weight-medium"},Ba=x({__name:"PrManagement",setup(m){const _=k(),x=e(!1),w=e(!1),E=e(!1),R=e(!1),L=e(!1),A=e(!1),N=e([]),I=e([]),T=e([]),F=e(-1),B=e({}),J=e(null),W=e(null),Z=y({status_id:null,requester_id:null,search:""}),G=y({page:1,page_size:20,total:0}),ie=[{title:"物品名称",key:"item_name",sortable:!1},{title:"型号",key:"specification",sortable:!1},{title:"品牌",key:"brand",sortable:!1},{title:"数量",key:"quantity",sortable:!1},{title:"物料编码",key:"material_code",sortable:!1},{title:"请购单号",key:"purchase_order_number",sortable:!1},{title:"申请人",key:"requester",sortable:!1},{title:"申请日期",key:"requested_date",sortable:!0},{title:"状态",key:"status",sortable:!1},{title:"操作",key:"actions",sortable:!1,width:120}],ne=a((()=>()=>!0)),re=a((()=>e=>{var a;const l=["待提交"].includes(null==(a=e.status)?void 0:a.name),t=String(e.requester_id)===String(_.userId);return l&&t})),de=async()=>{try{x.value=!0;const e={page:G.page,page_size:Math.max(1,G.page_size),...Z};Object.keys(e).forEach((a=>{null!==e[a]&&""!==e[a]||delete e[a]}));const a=(await V.get("/pr/",{params:e})).data;N.value=a.items,G.total=a.total}catch(e){C.error("加载PR列表失败")}finally{x.value=!1}},ue=e=>{G.page=e.page,G.page_size=-1===e.itemsPerPage?1e3:e.itemsPerPage,de()},oe=e=>{var a;if(!e)return"grey";if(e.color){if(e.color.startsWith("#")){return{"#9E9E9E":"grey","#FF9800":"orange","#2196F3":"blue","#4CAF50":"green","#9C27B0":"purple","#00BCD4":"cyan","#8BC34A":"light-green","#F44336":"red","#E91E63":"pink"}[e.color]||"grey"}return e.color}switch(null==(a=e.name)?void 0:a.toLowerCase()){case"待提交":return"orange";case"审批中":return"blue";case"已批准":return"green";case"采购中":return"purple";case"已到货":return"cyan";case"已拒绝":return"red";default:return"grey"}},ce=()=>{F.value=-1,B.value={material_name:"",description:"",priority_id:1,required_date:null,estimated_cost:null,supplier:"",material_code:"",specification:"",quantity:1,brand:"",remarks:""},R.value=!0},me=()=>{R.value=!1,B.value={},F.value=-1},ve=async e=>{var a,l;try{if(w.value=!0,e&&e.isExcelImport)return await de(),void me();const a={material_name:e.material_name||"",description:e.description||null,required_date:e.required_date||null,approved_date:e.approved_date||null,delivery_date:e.delivery_date||null,material_code:e.material_code||null,specification:e.specification||null,quantity:parseFloat(e.quantity)||0,brand:e.brand||null,remarks:e.remarks||null,purchase_order_number:e.purchase_order_number||null};if(-1===F.value){const e=await V.post("/pr/",a);C.success(`PR创建成功！编号：${e.data.pr_number||""}`)}else await V.put(`/pr/${B.value.id}`,a),C.success("PR更新成功");me(),de()}catch(t){C.error("保存PR失败: "+((null==(l=null==(a=t.response)?void 0:a.data)?void 0:l.detail)||t.message))}finally{w.value=!1}},pe=async e=>{try{const a=await V.get(`/pr/${e.id}`);J.value=a.data,L.value=!0}catch(a){C.error("获取PR详情失败")}},_e=()=>{L.value=!1,J.value=null},fe=async e=>{var a,l;try{await V.put(`/pr/${J.value.id}/status`,e),C.success("状态更新成功"),_e(),de()}catch(t){C.error("更新状态失败: "+((null==(l=null==(a=t.response)?void 0:a.data)?void 0:l.detail)||t.message))}},ye=async()=>{var e,a;try{E.value=!0,await V.delete(`/pr/${W.value.id}`),C.success("PR删除成功"),A.value=!1,W.value=null,de()}catch(l){C.error("删除PR失败: "+((null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.detail)||l.message))}finally{E.value=!1}},ge=e=>{var a;if(!e)return"mdi-help-circle";switch(null==(a=e.name)?void 0:a.toLowerCase()){case"待提交":return"mdi-file-document-outline";case"待审批":case"审批中":return"mdi-clock-outline";case"已批准":case"已审批":return"mdi-check-circle";case"已下单":case"采购中":return"mdi-cart";case"已到货":return"mdi-truck-delivery";case"已拒绝":return"mdi-close-circle";default:return"mdi-help-circle"}},be=e=>{var a,l;return"待审批"===(null==(a=e.status)?void 0:a.name)||"审批中"===(null==(l=e.status)?void 0:l.name)},he=e=>{var a,l;return"已批准"===(null==(a=e.status)?void 0:a.name)||"已审批"===(null==(l=e.status)?void 0:l.name)},xe=e=>{var a,l;return"已下单"===(null==(a=e.status)?void 0:a.name)||"采购中"===(null==(l=e.status)?void 0:l.name)},ke=async(e,a)=>{var l,t;try{await V.put(`/pr/${e.id}/status`,{status_id:a.id}),C.success(`状态已更新为：${a.name}`),de()}catch(s){C.error("状态更新失败: "+((null==(t=null==(l=s.response)?void 0:l.data)?void 0:t.detail)||s.message))}};let Ve=null;return l((()=>Z.search),(()=>{Ve&&clearTimeout(Ve),Ve=setTimeout((()=>{G.page=1,de()}),500)})),g((()=>{(async()=>{try{const e=await V.get("/pr/status");I.value=e.data;const a=await V.get("/pr/requesters");T.value=a.data}catch(e){C.error("加载基础数据失败")}})(),de()})),(e,a)=>(s(),r(z,{title:"PR管理",icon:"mdi-file-document-multiple",color:"info"},{"header-actions":n((()=>[i(j,{color:"primary","prepend-icon":"mdi-plus",onClick:ce},{default:n((()=>a[10]||(a[10]=[c(" 新建PR ")]))),_:1,__:[10]})])),default:n((()=>[i(q,{class:"mb-4",rounded:"lg"},{default:n((()=>[i(U,{class:"d-flex align-center"},{default:n((()=>[i(P,{color:"info",class:"mr-2"},{default:n((()=>a[11]||(a[11]=[c(" mdi-filter-variant ")]))),_:1,__:[11]}),a[12]||(a[12]=u("span",null,"筛选条件",-1))])),_:1,__:[12]}),i(D,null,{default:n((()=>[i(O,null,{default:n((()=>[i($,{cols:"12",md:"3"},{default:n((()=>[i(Q,{modelValue:Z.status_id,"onUpdate:modelValue":[a[0]||(a[0]=e=>Z.status_id=e),de],items:I.value,"item-title":"name","item-value":"id",label:"状态筛选",clearable:"",variant:"outlined",density:"compact"},null,8,["modelValue","items"])])),_:1}),i($,{cols:"12",md:"3"},{default:n((()=>[i(Q,{modelValue:Z.requester_id,"onUpdate:modelValue":[a[1]||(a[1]=e=>Z.requester_id=e),de],items:T.value,"item-title":"name","item-value":"id",label:"申请人筛选",clearable:"",variant:"outlined",density:"compact","prepend-inner-icon":"mdi-account"},null,8,["modelValue","items"])])),_:1}),i($,{cols:"12",md:"3"},{default:n((()=>[i(S,{modelValue:Z.search,"onUpdate:modelValue":a[2]||(a[2]=e=>Z.search=e),label:"搜索",placeholder:"请购单号、PR编号、物品名称或编码","prepend-inner-icon":"mdi-magnify",variant:"outlined",density:"compact",clearable:"",onKeyup:b(de,["enter"]),"onClick:clear":de},null,8,["modelValue"])])),_:1})])),_:1})])),_:1})])),_:1}),i(q,{rounded:"lg"},{default:n((()=>[i(U,{class:"d-flex align-center"},{default:n((()=>[i(P,{color:"info",class:"mr-2"},{default:n((()=>a[13]||(a[13]=[c(" mdi-format-list-bulleted ")]))),_:1,__:[13]}),a[14]||(a[14]=u("span",null,"PR列表",-1)),i(H),N.value.length>0?(s(),r(M,{key:0,color:"info",variant:"outlined",size:"small"},{default:n((()=>[c(" 共 "+o(G.total)+" 条记录 ",1)])),_:1})):d("",!0)])),_:1,__:[14]}),i(D,null,{default:n((()=>[i(ee,{"items-per-page":G.page_size,"onUpdate:itemsPerPage":a[3]||(a[3]=e=>G.page_size=e),page:G.page,"onUpdate:page":a[4]||(a[4]=e=>G.page=e),headers:ie,items:N.value,"items-length":G.total,loading:x.value,"item-value":"id",density:"compact",hover:!1,class:"unified-table","onUpdate:options":ue},{"item.pr_number":n((({item:e})=>[i(M,{color:"primary",variant:"outlined",size:"small",class:"cursor-pointer",onClick:a=>pe(e)},{default:n((()=>[c(o(e.pr_number),1)])),_:2},1032,["onClick"])])),"item.status":n((({item:e})=>[i(le,{"offset-y":""},{activator:n((({props:l})=>[i(M,f(l,{color:oe(e.status),size:"small",variant:"flat",class:"cursor-pointer","prepend-icon":ge(e.status)}),{default:n((()=>{var l;return[c(o(null==(l=e.status)?void 0:l.name)+" ",1),i(P,{size:"small",class:"ml-1"},{default:n((()=>a[15]||(a[15]=[c("mdi-chevron-down")]))),_:1,__:[15]})]})),_:2},1040,["color","prepend-icon"])])),default:n((()=>[i(te,{density:"compact"},{default:n((()=>[(s(!0),t(v,null,p(I.value,(a=>(s(),r(Y,{key:a.id,disabled:a.id===e.status_id,onClick:l=>ke(e,a)},{prepend:n((()=>[i(P,{color:oe(a),size:"small"},{default:n((()=>[c(o(ge(a)),1)])),_:2},1032,["color"])])),default:n((()=>[i(se,null,{default:n((()=>[c(o(a.name),1)])),_:2},1024)])),_:2},1032,["disabled","onClick"])))),128))])),_:2},1024)])),_:2},1024)])),"item.item_name":n((({item:e})=>[u("span",Sa,o(e.item_name),1)])),"item.specification":n((({item:e})=>[u("span",Ta,o(e.specification),1)])),"item.brand":n((({item:e})=>[u("span",Fa,o(e.brand),1)])),"item.quantity":n((({item:e})=>[u("span",null,o(e.quantity)+" "+o(e.unit||""),1)])),"item.requester":n((({item:e})=>{var a;return[c(o(null==(a=e.requester)?void 0:a.name),1)]})),"item.purchase_order_number":n((({item:e})=>[u("span",{class:h(["font-weight-medium",{"text-grey":!e.purchase_order_number}])},o(e.purchase_order_number||"-"),3)])),"item.requested_date":n((({item:e})=>{return[c(o((a=e.requested_date,a?new Date(a).toLocaleDateString("zh-CN"):"-")),1)];var a})),"item.actions":n((({item:e})=>[i(ae,{variant:"text",density:"compact"},{default:n((()=>[i(j,{icon:"mdi-eye",size:"small",color:"info",title:"查看详情",onClick:a=>pe(e)},null,8,["onClick"]),ne.value(e)?(s(),r(j,{key:0,icon:"mdi-pencil",size:"small",color:"primary",title:"编辑",onClick:a=>(e=>{F.value=N.value.indexOf(e),B.value={...e},R.value=!0})(e)},null,8,["onClick"])):d("",!0),be(e)?(s(),r(j,{key:1,icon:"mdi-check-circle",size:"small",color:"success",title:"标记已批准",onClick:a=>(async e=>{const a=I.value.find((e=>"已批准"===e.name||"已审批"===e.name));a&&await ke(e,a)})(e)},null,8,["onClick"])):d("",!0),he(e)?(s(),r(j,{key:2,icon:"mdi-cart",size:"small",color:"purple",title:"标记已采购",onClick:a=>(async e=>{const a=I.value.find((e=>"采购中"===e.name||"已下单"===e.name));a&&await ke(e,a)})(e)},null,8,["onClick"])):d("",!0),xe(e)?(s(),r(j,{key:3,icon:"mdi-truck-delivery",size:"small",color:"orange",title:"标记已到货",onClick:a=>(async e=>{const a=I.value.find((e=>"已到货"===e.name));a&&await ke(e,a)})(e)},null,8,["onClick"])):d("",!0),re.value(e)?(s(),r(j,{key:4,icon:"mdi-delete",size:"small",color:"error",title:"删除",onClick:a=>(e=>{var a;if(!re.value(e)){let l="无法删除此PR：";const t=[];return["待提交"].includes(null==(a=e.status)?void 0:a.name)||t.push("只能删除待提交状态的PR"),e.requester_id!==_.userId&&t.push("只能删除自己创建的PR"),l+=t.join("，"),void C.warning(l)}W.value=e,A.value=!0})(e)},null,8,["onClick"])):d("",!0)])),_:2},1024)])),_:1},8,["items-per-page","page","items","items-length","loading"])])),_:1})])),_:1}),i(Ze,{modelValue:R.value,"onUpdate:modelValue":a[5]||(a[5]=e=>R.value=e),pr:B.value,"onUpdate:pr":a[6]||(a[6]=e=>B.value=e),"is-new":-1===F.value,loading:w.value,"status-options":I.value,onSave:ve,onClose:me},null,8,["modelValue","pr","is-new","loading","status-options"]),i(Ia,{modelValue:L.value,"onUpdate:modelValue":a[7]||(a[7]=e=>L.value=e),pr:J.value,"status-options":I.value,onStatusChange:fe,onClose:_e},null,8,["modelValue","pr","status-options"]),i(X,{modelValue:A.value,"onUpdate:modelValue":a[9]||(a[9]=e=>A.value=e),"max-width":"400"},{default:n((()=>[i(q,null,{default:n((()=>[i(U,null,{default:n((()=>a[16]||(a[16]=[c("确认删除")]))),_:1,__:[16]}),i(D,null,{default:n((()=>{var e;return[c(' 确定要删除PR "'+o(null==(e=W.value)?void 0:e.material_name)+'" 吗？此操作不可撤销。 ',1)]})),_:1}),i(K,null,{default:n((()=>[i(H),i(j,{onClick:a[8]||(a[8]=e=>A.value=!1)},{default:n((()=>a[17]||(a[17]=[c(" 取消 ")]))),_:1,__:[17]}),i(j,{color:"error",loading:E.value,onClick:ye},{default:n((()=>a[18]||(a[18]=[c(" 删除 ")]))),_:1,__:[18]},8,["loading"])])),_:1})])),_:1})])),_:1},8,["modelValue"])])),_:1}))}},[["__scopeId","data-v-8109428b"]]);export{Ba as default};
