import{_ as e,U as a,d as t,i as l,M as i,p as r}from"./entry-index.D92NaooR.js";import{h as n,K as o}from"./chunk-kpiUtils.CSbvtC9I.js";import{z as u,A as s,aa as d,k as c,f as _,o as v,$ as m,Z as p,m as g,l as f,V as y,e as h,g as k,h as x,j as w}from"./chunk-vue-core.CxEQweee.js";import{r as V,N as b,w as C,ae as U,ac as T,ad as J,H as A,u as M,a4 as P,ab as j,af as E,X as I,K}from"./chunk-vendors.D0_dqILu.js";import"./chunk-utils-vendor.DVew6AbD.js";import"./chunk-chart-core.HkgdsJMe.js";const S={class:"font-weight-medium"},z={class:"text-center"},N={class:"d-flex align-center justify-center"},D={class:"text-caption font-weight-bold"},O={key:0,class:"d-flex align-center"},Y={key:1,class:"text-center text-grey"},F=e({__name:"EngKpi",setup(e){const{month:F,year:$}=(()=>{const e=new Date,a=e.getMonth(),t=e.getFullYear();return 0===a?{month:12,year:t-1}:{month:a,year:t}})(),H=V(!1),L=V(!1),X=V(F),Z=V($),q=V(!1),B=V(!1),G=V(!1),Q=V(!1),R=V([]),W=V(!1),ee=V(null),ae=Array.from({length:12},((e,a)=>({title:`${a+1}月`,value:a+1}))),te=Array.from({length:5},((e,a)=>({title:`${(new Date).getFullYear()-2+a}年`,value:(new Date).getFullYear()-2+a}))),le=[{title:"描述",key:"description",align:"start",width:"280px"},{title:"区域",key:"area",align:"center",width:"100px"},{title:"实际值",key:"actual_value",align:"center",width:"120px"},{title:"目标值",key:"target_value",align:"center",width:"120px"},{title:"YTD",key:"ytd_value",align:"center",width:"120px"},{title:"原因分析",key:"remark",align:"center",width:"150px"}],ie=[{title:"描述",key:"description",align:"start",width:"280px"},{title:"区域",key:"area",align:"center",width:"120px"},{title:"目标值 (%)",key:"target_value",align:"center",width:"150px"}],re=V([]),ne=V([]),oe=(e,a)=>0===a?0:Math.round(e/a*100),ue=e=>(e.actual_value||0)<(e.target_value||0),se=()=>{q.value=!0,B.value=!0},de=async()=>{var e,a;H.value=!0;try{re.value=(()=>{const e=[];let a=1;return[{description:"Achievement of CT Target at PPAP Approval",areas:["TJM","TJC","汇总"]}].forEach((t=>{t.areas.forEach((l=>{e.push({id:a++,description:t.description,area:l,actual_value:0,target_value:0,ytd_value:0,remark:null,action_plan_content:null,expected_close_date:null,actual_close_date:null,root_cause_analysis:null})}))})),e})();const e=await l("/eng/kpi/",{params:{month:X.value,year:Z.value}});if(e.data&&e.data.length>0)e.data.forEach((e=>{const a=re.value.find((a=>a.area===e.area&&a.description===e.description));a&&(a.actual_value=e.actual_value||0,a.target_value=e.target_value||0,a.ytd_value=e.ytd_value||0,a.remark=e.remark||null,a.action_plan_content=e.action_plan_content||null,a.expected_close_date=e.expected_close_date||null,a.actual_close_date=e.actual_close_date||null,a.root_cause_analysis=e.root_cause_analysis||null)}));else try{const e=await l("/eng/kpi/targets/",{params:{year:Z.value}});e.data&&e.data.length>0&&e.data.forEach((e=>{const a=re.value.find((a=>a.area===e.area&&a.description===e.description));a&&(a.target_value=e.target_value||0)}))}catch(t){}ne.value=JSON.parse(JSON.stringify(re.value)),q.value=!1,B.value=!1}catch(t){i.error("加载数据失败: "+((null==(a=null==(e=t.response)?void 0:e.data)?void 0:a.detail)||t.message))}finally{H.value=!1}},ce=async()=>{var e,a;L.value=!0;try{const e={month:X.value,year:Z.value,items:re.value.map((e=>({area:e.area,description:e.description,actual_value:e.actual_value,ytd_value:e.ytd_value,remark:e.remark,action_plan_content:e.action_plan_content,expected_close_date:e.expected_close_date,actual_close_date:e.actual_close_date,root_cause_analysis:e.root_cause_analysis})))};(await r("/eng/kpi/",e)).success&&(i.success("工程KPI数据保存成功"),q.value=!1,await de())}catch(t){i.error("保存数据失败: "+((null==(a=null==(e=t.response)?void 0:e.data)?void 0:a.detail)||t.message))}finally{L.value=!1}},_e=()=>{re.value=JSON.parse(JSON.stringify(ne.value)),q.value=!1,B.value=!1,i.info("数据已重置")},ve=async()=>{var e,a;try{const e=[];let a=1;[{description:"Achievement of CT Target at PPAP Approval",areas:["TJM","TJC","汇总"]}].forEach((t=>{t.areas.forEach((l=>{e.push({id:a++,description:t.description,area:l,target_value:0})}))})),R.value=e;const t=await l("/eng/kpi/targets/",{params:{year:Z.value}});t.data&&t.data.length>0&&t.data.forEach((e=>{const a=R.value.find((a=>a.area===e.area&&a.description===e.description));a&&(a.target_value=e.target_value||0)})),G.value=!0}catch(t){i.error("获取目标值失败: "+((null==(a=null==(e=t.response)?void 0:e.data)?void 0:a.detail)||t.message))}},me=async()=>{Q.value=!0;try{const e={year:Z.value,items:R.value.map((e=>({area:e.area,description:e.description,target_value:e.target_value||0})))};await r("/eng/kpi/targets/",e),i.success("目标值保存成功"),G.value=!1,de()}catch(e){i.error("保存目标值失败")}finally{Q.value=!1}},pe=e=>n(e)?"查看/编辑":"填写分析",ge=e=>{ee.value&&(ee.value.root_cause_analysis=e.root_cause_analysis,ee.value.action_plan_content=e.action_plan_content,ee.value.expected_close_date=e.expected_close_date,ee.value.actual_close_date=e.actual_close_date,se())};return b((()=>{de()})),C(Z,(()=>{de()})),(e,l)=>(T(),U(t,{title:"工程KPI管理",icon:"mdi-engineering",color:"primary"},{default:J((()=>[A(u,{class:"mb-4 align-center"},{default:J((()=>[A(s,{cols:"12",md:"6"},{default:J((()=>[A(u,null,{default:J((()=>[A(s,{cols:"6",md:"4"},{default:J((()=>[A(d,{modelValue:X.value,"onUpdate:modelValue":[l[0]||(l[0]=e=>X.value=e),de],items:M(ae),label:"选择月份",variant:"outlined",density:"compact"},null,8,["modelValue","items"])])),_:1}),A(s,{cols:"6",md:"4"},{default:J((()=>[A(d,{modelValue:Z.value,"onUpdate:modelValue":[l[1]||(l[1]=e=>Z.value=e),de],items:M(te),label:"选择年份",variant:"outlined",density:"compact"},null,8,["modelValue","items"])])),_:1})])),_:1})])),_:1}),A(s,{cols:"12",md:"6",class:"text-right"},{default:J((()=>[A(c,{color:"info","prepend-icon":"mdi-target",variant:"outlined",class:"mr-2",onClick:ve},{default:J((()=>l[7]||(l[7]=[P(" 设置目标值 ")]))),_:1,__:[7]}),A(c,{color:"secondary",disabled:!q.value,"prepend-icon":"mdi-refresh",variant:"outlined",class:"mr-2",onClick:_e},{default:J((()=>l[8]||(l[8]=[P(" 重置 ")]))),_:1,__:[8]},8,["disabled"]),A(c,{color:"primary",loading:L.value,disabled:!q.value,"prepend-icon":"mdi-content-save",variant:"elevated",onClick:ce},{default:J((()=>l[9]||(l[9]=[P(" 保存数据 ")]))),_:1,__:[9]},8,["loading","disabled"])])),_:1})])),_:1}),A(a,{headers:le,items:re.value,loading:H.value,density:"comfortable",class:"mb-6","hide-default-footer":"","items-per-page":-1},{"item.description":J((({item:e})=>[K("div",S,I(e.description),1)])),"item.area":J((({item:e})=>{return[A(m,{color:(a=e.area,{TJM:"primary",TJC:"secondary","汇总":"success"}[a]||"default"),size:"small",variant:"flat"},{default:J((()=>[P(I(e.area),1)])),_:2},1032,["color"])];var a})),"item.actual_value":J((({item:e})=>[A(p,{modelValue:e.actual_value,"onUpdate:modelValue":a=>e.actual_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",class:"text-field-small",onInput:se},null,8,["modelValue","onUpdate:modelValue"])])),"item.ytd_value":J((({item:e})=>[A(p,{modelValue:e.ytd_value,"onUpdate:modelValue":a=>e.ytd_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",class:"text-field-small",onInput:se},null,8,["modelValue","onUpdate:modelValue"])])),"item.target_value":J((({item:e})=>[K("div",z,[A(m,{color:e.target_value>0?"success":"grey",size:"small",variant:"flat"},{default:J((()=>{return[P(I((a=e.target_value,0===a?"0":a.toLocaleString()))+"% ",1)];var a})),_:2},1032,["color"])])])),"item.achievement_rate":J((({item:e})=>{return[K("div",N,[A(v,{"model-value":oe(e.actual_value,e.target_value),color:(a=oe(e.actual_value,e.target_value),a>=100?"success":a>=80?"warning":"error"),size:"40",width:"4"},{default:J((()=>[K("span",D,I(oe(e.actual_value,e.target_value))+"% ",1)])),_:2},1032,["model-value","color"])])];var a})),"item.remark":J((({item:e})=>[ue(e)?(T(),j("div",O,[A(c,{size:"small",variant:"outlined",color:"warning","prepend-icon":"mdi-clipboard-edit",onClick:a=>(e=>{ee.value=e,W.value=!0})(e)},{default:J((()=>[P(I(pe(e)),1)])),_:2},1032,["onClick"]),M(n)(e)?(T(),U(_,{key:0,color:"success",class:"ml-2"},{default:J((()=>l[10]||(l[10]=[P(" mdi-check-circle ")]))),_:1,__:[10]})):E("",!0)])):(T(),j("div",Y,[A(_,null,{default:J((()=>l[11]||(l[11]=[P("mdi-check-circle")]))),_:1,__:[11]}),l[12]||(l[12]=K("div",{class:"text-caption"}," 达标 ",-1))]))])),_:1},8,["items","loading"]),A(g,{modelValue:B.value,"onUpdate:modelValue":l[3]||(l[3]=e=>B.value=e),timeout:3e3,color:"warning",location:"bottom","multi-line":"",class:"change-alert"},{actions:J((()=>[A(c,{color:"white",variant:"text",loading:L.value,onClick:ce},{default:J((()=>l[14]||(l[14]=[P(" 保存 ")]))),_:1,__:[14]},8,["loading"]),A(c,{color:"white",variant:"text",onClick:l[2]||(l[2]=e=>B.value=!1)},{default:J((()=>l[15]||(l[15]=[P(" 关闭 ")]))),_:1,__:[15]})])),default:J((()=>[A(_,{start:"",class:"mr-2"},{default:J((()=>l[13]||(l[13]=[P(" mdi-alert ")]))),_:1,__:[13]}),l[16]||(l[16]=P(" 数据已修改，请记得保存 "))])),_:1,__:[16]},8,["modelValue"]),A(f,{modelValue:G.value,"onUpdate:modelValue":l[5]||(l[5]=e=>G.value=e),"max-width":"800px",persistent:""},{default:J((()=>[A(y,null,{default:J((()=>[A(h,{class:"text-h5 bg-primary text-white"},{default:J((()=>[A(_,{start:""},{default:J((()=>l[17]||(l[17]=[P(" mdi-target ")]))),_:1,__:[17]}),P(" 设置工程KPI目标值 ("+I(Z.value)+"年) ",1)])),_:1}),A(k,{class:"pa-6"},{default:J((()=>[A(a,{headers:ie,items:R.value,density:"compact","hide-default-footer":""},{"item.target_value":J((({item:e})=>[A(p,{modelValue:e.target_value,"onUpdate:modelValue":a=>e.target_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",suffix:"%"},null,8,["modelValue","onUpdate:modelValue"])])),_:1},8,["items"])])),_:1}),A(x,{class:"pa-6 pt-0"},{default:J((()=>[A(w),A(c,{color:"grey",variant:"outlined",onClick:l[4]||(l[4]=e=>G.value=!1)},{default:J((()=>l[18]||(l[18]=[P(" 取消 ")]))),_:1,__:[18]}),A(c,{color:"primary",variant:"elevated",loading:Q.value,onClick:me},{default:J((()=>l[19]||(l[19]=[P(" 保存目标值 ")]))),_:1,__:[19]},8,["loading"])])),_:1})])),_:1})])),_:1},8,["modelValue"]),A(o,{modelValue:W.value,"onUpdate:modelValue":l[6]||(l[6]=e=>W.value=e),item:ee.value,title:"原因分析与行动计划",onSave:ge},null,8,["modelValue","item"])])),_:1}))}},[["__scopeId","data-v-0965b3cc"]]);export{F as default};
