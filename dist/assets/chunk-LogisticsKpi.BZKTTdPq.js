import{_ as e,c as a,U as l,d as t,i,M as s,p as o}from"./entry-index.D92NaooR.js";import{h as r,K as u}from"./chunk-kpiUtils.CSbvtC9I.js";import{z as n,A as c,aa as d,j as _,k as m,f as v,Z as p,$ as f,m as g,l as y,V as h,e as k,g as b,h as x}from"./chunk-vue-core.CxEQweee.js";import{r as V,N as w,w as C,ae as U,ac as D,ad as I,K as A,H as J,u as K,a4 as O,ab as P,af as T,X as j}from"./chunk-vendors.D0_dqILu.js";import"./chunk-utils-vendor.DVew6AbD.js";import"./chunk-chart-core.HkgdsJMe.js";const M={class:"sticky-header-container"},z={class:"controls-bar"},F={class:"scrollable-table-container"},E={class:"font-weight-medium"},N={class:"text-center"},S={key:0,class:"d-flex align-center"},H={key:1,class:"text-grey"},L=e({__name:"LogisticsKpi",setup(e){const{month:L,year:Y}=(()=>{const e=new Date,a=e.getMonth(),l=e.getFullYear();return 0===a?{month:12,year:l-1}:{month:a,year:l}})(),$=V(!1),X=V(!1),Z=V(L),q=V(Y),B=V(!1),G=V(!1),Q=V(!1),R=V([]),W=V(!1),ee=V(null),ae=Array.from({length:12},((e,a)=>({title:`${a+1}月`,value:a+1}))),le=Array.from({length:10},((e,a)=>({title:`${(new Date).getFullYear()-5+a}年`,value:(new Date).getFullYear()-5+a}))),te=[{title:"KPI指标",key:"description",width:"200px",sortable:!1},{title:"区域",key:"area",width:"100px",sortable:!1},{title:"实际值",key:"actual_value",width:"120px",sortable:!1},{title:"目标值",key:"target_value",width:"120px",sortable:!1},{title:"YTD",key:"ytd_value",width:"120px",sortable:!1},{title:"原因分析与行动计划",key:"remark",width:"200px",sortable:!1}],ie=[{title:"KPI指标",key:"description",sortable:!1},{title:"区域",key:"area",width:"100px",sortable:!1},{title:"目标值",key:"target_value",width:"150px",sortable:!1}],se=["Premium Freight","On time delivery to customers","DTime due to Logistics","Inv Accuracy- Absolute Value","Inv Accuracy - Absolute Count Difference","DOH"],oe=["TJM","TJC","汇总"],re=V([]),ue=V([]),ne=e=>({TJM:"primary",TJC:"secondary","汇总":"success"}[e]||"grey"),ce=(e,a,l)=>{if(!a||0===a)return"grey";return["Premium Freight","DTime due to Logistics","DOH"].includes(l)?e>a?"error":"success":e<a?"error":"success"},de=e=>{if(!e.target_value||0===e.target_value)return!1;return["Premium Freight","DTime due to Logistics","DOH"].includes(e.description)?e.actual_value>e.target_value:e.actual_value<e.target_value},_e=e=>r(e)?"查看/编辑":"添加备注",me=e=>{ee.value&&(ee.value.action_plan_content=e.action_plan_content,ee.value.expected_close_date=e.expected_close_date,ee.value.actual_close_date=e.actual_close_date,ee.value.root_cause_analysis=e.root_cause_analysis,ve()),W.value=!1},ve=()=>{B.value=!0},pe=async()=>{$.value=!0;try{re.value=(()=>{const e=[];let a=1;return se.forEach((l=>{oe.forEach((t=>{e.push({id:a++,description:l,area:t,actual_value:0,target_value:0,ytd_value:0,remark:null,action_plan_content:null,expected_close_date:null,actual_close_date:null,root_cause_analysis:null})}))})),e})();const e=await i("/logistics/kpi/",{params:{month:Z.value,year:q.value}});e.data&&e.data.length>0&&e.data.forEach((e=>{const a=re.value.find((a=>a.area===e.area&&a.description===e.description));a&&(a.actual_value=e.actual_value||0,a.target_value=e.target_value||0,a.ytd_value=e.ytd_value||0,a.remark=e.remark||null,a.action_plan_content=e.action_plan_content||null,a.expected_close_date=e.expected_close_date||null,a.actual_close_date=e.actual_close_date||null,a.root_cause_analysis=e.root_cause_analysis||null)})),ue.value=JSON.parse(JSON.stringify(re.value)),B.value=!1}catch(e){s.error("加载数据失败")}finally{$.value=!1}},fe=async()=>{if(B.value){X.value=!0;try{const e={month:Z.value,year:q.value,items:re.value.map((e=>({area:e.area,description:e.description,actual_value:e.actual_value||0,ytd_value:e.ytd_value||0,remark:e.remark,action_plan_content:e.action_plan_content,expected_close_date:e.expected_close_date,actual_close_date:e.actual_close_date,root_cause_analysis:e.root_cause_analysis})))};await o("/logistics/kpi/",e),s.success("物流KPI数据保存成功"),B.value=!1,await pe()}catch(e){s.error("保存数据失败")}finally{X.value=!1}}else s.info("没有数据变更")},ge=()=>{re.value=JSON.parse(JSON.stringify(ue.value)),B.value=!1,s.info("数据已重置")},ye=async()=>{try{const e=await i("/logistics/kpi/targets/",{params:{year:q.value}});e.data&&e.data.length>0?R.value=e.data:(R.value=[],se.forEach((e=>{oe.forEach((a=>{R.value.push({area:a,description:e,target_value:0})}))}))),G.value=!0}catch(e){s.error("获取目标值失败")}},he=async()=>{Q.value=!0;try{const e={year:q.value,targets:R.value.map((e=>({year:q.value,area:e.area,description:e.description,target_value:e.target_value||0})))};await o("/logistics/kpi/targets/",e),s.success("目标值保存成功"),G.value=!1,await pe()}catch(e){s.error("保存目标值失败")}finally{Q.value=!1}};return w((()=>{pe()})),C([Z,q],(()=>{if(B.value){if(!confirm("有未保存的更改，是否要放弃更改并切换？"))return;pe()}else pe()})),(e,i)=>(D(),U(t,{title:"物流KPI管理",icon:"mdi-truck",color:"info"},{default:I((()=>[A("div",M,[A("div",z,[J(n,{class:"align-center"},{default:I((()=>[J(c,{cols:"12",md:"6"},{default:I((()=>[J(n,null,{default:I((()=>[J(c,{cols:"6",md:"4"},{default:I((()=>[J(d,{modelValue:Z.value,"onUpdate:modelValue":[i[0]||(i[0]=e=>Z.value=e),pe],items:K(ae),label:"选择月份",variant:"outlined",density:"compact","hide-details":"",class:"control-select"},null,8,["modelValue","items"])])),_:1}),J(c,{cols:"6",md:"4"},{default:I((()=>[J(d,{modelValue:q.value,"onUpdate:modelValue":[i[1]||(i[1]=e=>q.value=e),pe],items:K(le),label:"选择年份",variant:"outlined",density:"compact","hide-details":"",class:"control-select"},null,8,["modelValue","items"])])),_:1})])),_:1})])),_:1}),J(_),J(c,{cols:"auto"},{default:I((()=>[J(m,{color:"info","prepend-icon":"mdi-target",variant:"outlined",class:"mr-2 action-btn",onClick:ye},{default:I((()=>i[7]||(i[7]=[O(" 设置目标值 ")]))),_:1,__:[7]}),J(m,{color:"secondary",disabled:!B.value,"prepend-icon":"mdi-refresh",variant:"outlined",class:"mr-2 action-btn",onClick:ge},{default:I((()=>i[8]||(i[8]=[O(" 重置 ")]))),_:1,__:[8]},8,["disabled"]),J(m,{color:"primary","prepend-icon":"mdi-content-save",loading:X.value,disabled:!B.value,variant:"elevated",class:"action-btn",onClick:fe},{default:I((()=>i[9]||(i[9]=[O(" 保存数据 ")]))),_:1,__:[9]},8,["loading","disabled"])])),_:1})])),_:1})])]),J(a,{loading:$.value,message:"加载数据中..."},null,8,["loading"]),A("div",F,[J(l,{headers:te,items:re.value,loading:$.value,density:"comfortable",class:"logistics-kpi-table logistics-data-table frozen-header-table","hide-default-footer":"","items-per-page":-1,hover:!1,"fixed-header":!0,height:"calc(100vh - 280px)"},{"item.description":I((({item:e})=>[A("div",E,j(e.description),1)])),"item.area":I((({item:e})=>[J(f,{color:ne(e.area),size:"small",variant:"flat"},{default:I((()=>[O(j(e.area),1)])),_:2},1032,["color"])])),"item.actual_value":I((({item:e})=>[J(p,{modelValue:e.actual_value,"onUpdate:modelValue":a=>e.actual_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",class:"text-field-small",onInput:ve},null,8,["modelValue","onUpdate:modelValue"])])),"item.target_value":I((({item:e})=>[A("div",N,[J(f,{color:ce(e.actual_value,e.target_value,e.description),size:"small",variant:"flat"},{default:I((()=>[O(j(e.target_value||0),1)])),_:2},1032,["color"])])])),"item.ytd_value":I((({item:e})=>[J(p,{modelValue:e.ytd_value,"onUpdate:modelValue":a=>e.ytd_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",class:"text-field-small",onInput:ve},null,8,["modelValue","onUpdate:modelValue"])])),"item.remark":I((({item:e})=>[de(e)?(D(),P("div",S,[J(m,{size:"small",variant:"outlined",color:"warning","prepend-icon":"mdi-clipboard-edit",onClick:a=>(e=>{ee.value=e,W.value=!0})(e)},{default:I((()=>[O(j(_e(e)),1)])),_:2},1032,["onClick"]),K(r)(e)?(D(),U(v,{key:0,color:"success",class:"ml-2"},{default:I((()=>i[10]||(i[10]=[O(" mdi-check-circle ")]))),_:1,__:[10]})):T("",!0)])):(D(),P("span",H,"-"))])),_:1},8,["items","loading"])]),J(g,{modelValue:e.showChangeAlert,"onUpdate:modelValue":i[3]||(i[3]=a=>e.showChangeAlert=a),timeout:3e3,color:"warning",location:"bottom","multi-line":"",class:"change-alert"},{actions:I((()=>[J(m,{color:"white",variant:"text",loading:X.value,onClick:fe},{default:I((()=>i[12]||(i[12]=[O(" 保存 ")]))),_:1,__:[12]},8,["loading"]),J(m,{color:"white",variant:"text",onClick:i[2]||(i[2]=a=>e.showChangeAlert=!1)},{default:I((()=>i[13]||(i[13]=[O(" 关闭 ")]))),_:1,__:[13]})])),default:I((()=>[J(v,{start:"",class:"mr-2"},{default:I((()=>i[11]||(i[11]=[O(" mdi-alert ")]))),_:1,__:[11]}),i[14]||(i[14]=O(" 数据已修改，请记得保存 "))])),_:1,__:[14]},8,["modelValue"]),J(y,{modelValue:G.value,"onUpdate:modelValue":i[5]||(i[5]=e=>G.value=e),"max-width":"1200px",persistent:""},{default:I((()=>[J(h,null,{default:I((()=>[J(k,{class:"d-flex align-center"},{default:I((()=>[J(v,{class:"mr-2"},{default:I((()=>i[15]||(i[15]=[O(" mdi-target ")]))),_:1,__:[15]}),O(" "+j(q.value)+"年 物流KPI 目标值设置 ",1)])),_:1}),J(b,null,{default:I((()=>[J(l,{headers:ie,items:R.value,loading:Q.value,density:"compact","hide-default-footer":"","items-per-page":-1},{"item.area":I((({item:e})=>[J(f,{color:ne(e.area),size:"small",variant:"flat"},{default:I((()=>[O(j(e.area),1)])),_:2},1032,["color"])])),"item.target_value":I((({item:e})=>[J(p,{modelValue:e.target_value,"onUpdate:modelValue":a=>e.target_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",class:"text-field-small"},null,8,["modelValue","onUpdate:modelValue"])])),_:1},8,["items","loading"])])),_:1}),J(x,null,{default:I((()=>[J(_),J(m,{variant:"text",disabled:Q.value,onClick:i[4]||(i[4]=e=>G.value=!1)},{default:I((()=>i[16]||(i[16]=[O(" 取消 ")]))),_:1,__:[16]},8,["disabled"]),J(m,{color:"primary",loading:Q.value,onClick:he},{default:I((()=>i[17]||(i[17]=[O(" 保存目标值 ")]))),_:1,__:[17]},8,["loading"])])),_:1})])),_:1})])),_:1},8,["modelValue"]),J(u,{modelValue:W.value,"onUpdate:modelValue":i[6]||(i[6]=e=>W.value=e),item:ee.value,onSave:me},null,8,["modelValue","item"])])),_:1}))}},[["__scopeId","data-v-f713c904"]]);export{L as default};
