import{_ as e,c as a,e as l,U as t,d,i as s,M as u,p as o,j as i,k as n}from"./entry-index.D92NaooR.js";import{z as r,A as c,a9 as m,k as v,Z as _,aa as p,$ as y,l as f,V as g,e as h,f as x,g as b,W as V,h as k,j as w,a1 as C}from"./chunk-vue-core.CxEQweee.js";import{r as U,d as j,N as z,ae as S,ac as D,ad as q,K as L,H as $,ab as F,af as E,a4 as H,X as M}from"./chunk-vendors.D0_dqILu.js";import"./chunk-utils-vendor.DVew6AbD.js";import"./chunk-chart-core.HkgdsJMe.js";const N={class:"controls-bar mb-4"},A={key:0,class:"summary-cards mb-4"},I={class:"table-container"},K={class:"text-center font-weight-medium"},O={class:"text-center"},R={class:"text-center"},W={class:"text-center"},X={class:"safety-range"},Z={class:"text-grey-600"},B={class:"text-center"},G={class:"text-center"},J={class:"text-center"},P={class:"mb-4"},Q=e({__name:"DohMasterData",setup(e){const Q=U(!1),T=U(!1),Y=U(!1),ee=U("all"),ae=U(""),le=U(null),te=[{text:"全部状态",value:null},{text:"仅启用",value:1},{text:"仅禁用",value:0}],de=U([]),se=U(null),ue=U(!1),oe=U(!1),ie=U(!1),ne=U(!1),re=U(null),ce=U({category:"",product_code:"",product_name:"",unit:"天",sort_order:0,is_active:1}),me=U({min_safety_days:0,max_safety_days:0}),ve=[{title:"分类",key:"category",width:"100px",sortable:!1},{title:"分类",key:"product_code",width:"120px",sortable:!1},{title:"产品名称",key:"product_name",width:"200px",sortable:!1},{title:"单位",key:"unit",width:"80px",sortable:!1},{title:"安全库存范围",key:"safety_range",width:"140px",sortable:!1},{title:"状态",key:"status",width:"80px",sortable:!1},{title:"更新时间",key:"updated_at",width:"120px",sortable:!1},{title:"操作",key:"actions",width:"150px",sortable:!1}],_e=[{title:"原材料",value:"原材料"},{title:"半成品",value:"半成品"},{title:"成品",value:"成品"}],pe=j((()=>{let e=de.value;if("all"!==ee.value&&(e=e.filter((e=>e.category===ee.value))),ae.value){const a=ae.value.toLowerCase();e=e.filter((e=>e.product_code.toLowerCase().includes(a)||e.product_name.toLowerCase().includes(a)))}return e.sort(((e,a)=>{const l={"原材料":1,"半成品":2,"成品":3},t=l[e.category]-l[a.category];return 0!==t?t:(e.sort_order||0)-(a.sort_order||0)}))})),ye=async()=>{var e,a;Q.value=!0;try{const e={};null!==le.value&&(e.is_active=le.value);const a=await s("/doh/v2/master-data/",{params:e});de.value=a.data||[],fe()}catch(l){u.error("获取主数据失败: "+((null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.detail)||l.message))}finally{Q.value=!1}},fe=()=>{const e={total:de.value.length,raw_material:0,semi_finished:0,finished_goods:0};de.value.forEach((a=>{switch(a.category){case"原材料":e.raw_material++;break;case"半成品":e.semi_finished++;break;case"成品":e.finished_goods++}})),se.value=e},ge=()=>{ie.value=!0,ce.value={category:"",product_code:"",product_name:"",unit:"天",sort_order:0,is_active:1},ue.value=!0},he=async()=>{var e,a;T.value=!0;try{let e;const a=i(ce.value,{removeEmpty:!1,trimStrings:!0});e=ie.value?await n("/doh/v2/master-data/",a):await o(`/doh/v2/master-data/${re.value.id}/`,a),e&&e.data?(u.success(ie.value?"产品创建成功":"产品更新成功"),ue.value=!1,await ye()):u.error("保存失败: 服务器响应格式不正确")}catch(l){u.error("保存失败: "+((null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.detail)||l.message))}finally{T.value=!1}},xe=async()=>{var e,a;if(re.value){Y.value=!0;try{const e={min_safety_days:parseFloat(me.value.min_safety_days)||0,max_safety_days:parseFloat(me.value.max_safety_days)||0},a=await o(`/doh/v2/master-data/${re.value.id}/safety-stock`,e);a&&a.data?(u.success("安全库存设置保存成功"),oe.value=!1,await ye()):u.error("保存失败: 服务器响应格式不正确")}catch(l){u.error("保存失败: "+((null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.detail)||l.message))}finally{Y.value=!1}}},be=()=>{ye()};return z((()=>{ye()})),(e,s)=>(D(),S(d,{title:"DOH主数据维护",icon:"mdi-database-cog",color:"primary"},{default:q((()=>[L("div",N,[$(r,{class:"align-center"},{default:q((()=>[$(c,{cols:"12",md:"8"},{default:q((()=>[$(r,{class:"align-center"},{default:q((()=>[$(c,{cols:"auto"},{default:q((()=>[$(m,{modelValue:ee.value,"onUpdate:modelValue":s[0]||(s[0]=e=>ee.value=e),density:"comfortable",color:"primary",mandatory:""},{default:q((()=>[$(v,{value:"all","prepend-icon":"mdi-view-grid"},{default:q((()=>s[15]||(s[15]=[H(" 全部 ")]))),_:1,__:[15]}),$(v,{value:"原材料","prepend-icon":"mdi-cube-outline"},{default:q((()=>s[16]||(s[16]=[H(" 原材料 ")]))),_:1,__:[16]}),$(v,{value:"半成品","prepend-icon":"mdi-package"},{default:q((()=>s[17]||(s[17]=[H(" 半成品 ")]))),_:1,__:[17]}),$(v,{value:"成品","prepend-icon":"mdi-package-variant-closed"},{default:q((()=>s[18]||(s[18]=[H(" 成品 ")]))),_:1,__:[18]})])),_:1},8,["modelValue"])])),_:1}),$(c,{cols:"auto"},{default:q((()=>[$(_,{modelValue:ae.value,"onUpdate:modelValue":s[1]||(s[1]=e=>ae.value=e),"prepend-inner-icon":"mdi-magnify",label:"搜索产品",variant:"outlined",density:"compact","hide-details":"",clearable:"",style:{"min-width":"200px"}},null,8,["modelValue"])])),_:1}),$(c,{cols:"auto"},{default:q((()=>[$(p,{modelValue:le.value,"onUpdate:modelValue":[s[2]||(s[2]=e=>le.value=e),ye],items:te,"item-title":"text","item-value":"value",label:"产品状态",variant:"outlined",density:"compact","hide-details":"",style:{"min-width":"120px"}},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),$(c,{cols:"12",md:"4",class:"text-right"},{default:q((()=>[$(v,{"prepend-icon":"mdi-plus",color:"primary",onClick:ge},{default:q((()=>s[19]||(s[19]=[H(" 新增产品 ")]))),_:1,__:[19]}),$(v,{"prepend-icon":"mdi-refresh",variant:"text",class:"ml-2",loading:Q.value,onClick:be},{default:q((()=>s[20]||(s[20]=[H(" 刷新 ")]))),_:1,__:[20]},8,["loading"])])),_:1})])),_:1})]),$(a,{loading:Q.value,message:"加载数据中..."},null,8,["loading"]),se.value?(D(),F("div",A,[$(r,null,{default:q((()=>[$(c,{cols:"12",sm:"6",md:"3"},{default:q((()=>[$(l,{title:"总产品数",value:se.value.total.toString(),subtitle:"全部产品",icon:"mdi-package-variant",color:"primary"},null,8,["value"])])),_:1}),$(c,{cols:"12",sm:"6",md:"3"},{default:q((()=>[$(l,{title:"原材料",value:se.value.raw_material.toString(),subtitle:"原材料产品",icon:"mdi-cube-outline"},null,8,["value"])])),_:1}),$(c,{cols:"12",sm:"6",md:"3"},{default:q((()=>[$(l,{title:"半成品",value:se.value.semi_finished.toString(),subtitle:"半成品产品",icon:"mdi-package"},null,8,["value"])])),_:1}),$(c,{cols:"12",sm:"6",md:"3"},{default:q((()=>[$(l,{title:"成品",value:se.value.finished_goods.toString(),subtitle:"成品产品",icon:"mdi-package-variant-closed"},null,8,["value"])])),_:1})])),_:1})])):E("",!0),L("div",I,[$(t,{headers:ve,items:pe.value,loading:Q.value,class:"mt-4 master-data-table doh-master-table",hover:""},{item:q((({item:e})=>{return[L("tr",null,[L("td",K,[$(y,{color:(l=e.category,{"原材料":"orange","半成品":"blue","成品":"green"}[l]||"grey"),size:"small",variant:"tonal"},{default:q((()=>[H(M(e.category),1)])),_:2},1032,["color"])]),L("td",O,M(e.product_code),1),L("td",null,M(e.product_name),1),L("td",R,M(e.unit),1),L("td",W,[L("div",X,[L("small",Z,M(e.min_safety_days||0)+" - "+M(e.max_safety_days||0)+" 天 ",1)])]),L("td",B,[$(y,{color:e.is_active?"success":"error",size:"small",variant:"tonal"},{default:q((()=>[H(M(e.is_active?"启用":"禁用"),1)])),_:2},1032,["color"])]),L("td",G,M((a=e.updated_at,a?new Date(a).toLocaleDateString("zh-CN"):"-")),1),L("td",J,[$(v,{icon:"mdi-pencil",size:"small",variant:"text",title:"编辑产品",onClick:a=>(e=>{ie.value=!1,re.value=e,ce.value={category:e.category,product_code:e.product_code,product_name:e.product_name,unit:e.unit,sort_order:e.sort_order||0,is_active:e.is_active},ue.value=!0})(e)},null,8,["onClick"]),$(v,{icon:"mdi-cog",size:"small",variant:"text",title:"设置安全库存",onClick:a=>(e=>{re.value=e,me.value={min_safety_days:e.min_safety_days||0,max_safety_days:e.max_safety_days||0},oe.value=!0})(e)},null,8,["onClick"]),$(v,{icon:e.is_active?"mdi-eye-off":"mdi-eye",size:"small",variant:"text",color:e.is_active?"warning":"success",title:e.is_active?"禁用产品":"启用产品",onClick:a=>(async e=>{var a,l;try{const a=e.is_active?0:1,l={...e,is_active:a},t=await o(`/doh/v2/master-data/${e.id}/`,l);t&&t.data?(u.success("产品已"+(a?"启用":"禁用")),await ye()):u.error("状态更新失败")}catch(t){u.error("状态更新失败: "+((null==(l=null==(a=t.response)?void 0:a.data)?void 0:l.detail)||t.message))}})(e)},null,8,["icon","color","title","onClick"])])])];var a,l})),_:1},8,["items","loading"])]),$(f,{modelValue:ue.value,"onUpdate:modelValue":s[10]||(s[10]=e=>ue.value=e),"max-width":"600px"},{default:q((()=>[$(g,null,{default:q((()=>[$(h,{class:"text-h6"},{default:q((()=>[$(x,{icon:ie.value?"mdi-plus":"mdi-pencil",class:"mr-2"},null,8,["icon"]),H(" "+M(ie.value?"新增产品":"编辑产品"),1)])),_:1}),$(b,null,{default:q((()=>[$(V,{ref:"editFormRef",modelValue:ne.value,"onUpdate:modelValue":s[8]||(s[8]=e=>ne.value=e)},{default:q((()=>[$(r,null,{default:q((()=>[$(c,{cols:"12",md:"6"},{default:q((()=>[$(p,{modelValue:ce.value.category,"onUpdate:modelValue":s[3]||(s[3]=e=>ce.value.category=e),items:_e,label:"产品分类",variant:"outlined",density:"compact",rules:[e=>!!e||"请选择产品分类"],required:""},null,8,["modelValue","rules"])])),_:1}),$(c,{cols:"12",md:"6"},{default:q((()=>[$(_,{modelValue:ce.value.product_code,"onUpdate:modelValue":s[4]||(s[4]=e=>ce.value.product_code=e),label:"分类",variant:"outlined",density:"compact",rules:[e=>!!e||"请输入产品分类"],"persistent-hint":"",required:""},null,8,["modelValue","rules"])])),_:1}),$(c,{cols:"12"},{default:q((()=>[$(_,{modelValue:ce.value.product_name,"onUpdate:modelValue":s[5]||(s[5]=e=>ce.value.product_name=e),label:"产品名称",variant:"outlined",density:"compact",rules:[e=>!!e||"请输入产品名称"],"persistent-hint":"",required:""},null,8,["modelValue","rules"])])),_:1}),$(c,{cols:"12",md:"6"},{default:q((()=>[$(_,{modelValue:ce.value.unit,"onUpdate:modelValue":s[6]||(s[6]=e=>ce.value.unit=e),label:"单位",variant:"outlined",density:"compact",rules:[e=>!!e||"请输入单位"],required:""},null,8,["modelValue","rules"])])),_:1}),$(c,{cols:"12",md:"6"},{default:q((()=>[$(_,{modelValue:ce.value.sort_order,"onUpdate:modelValue":s[7]||(s[7]=e=>ce.value.sort_order=e),label:"排序顺序",type:"number",variant:"outlined",density:"compact"},null,8,["modelValue"])])),_:1})])),_:1})])),_:1},8,["modelValue"])])),_:1}),$(k,null,{default:q((()=>[$(w),$(v,{variant:"text",onClick:s[9]||(s[9]=e=>ue.value=!1)},{default:q((()=>s[21]||(s[21]=[H(" 取消 ")]))),_:1,__:[21]}),$(v,{color:"primary",loading:T.value,disabled:!ne.value,onClick:he},{default:q((()=>s[22]||(s[22]=[H(" 保存 ")]))),_:1,__:[22]},8,["loading","disabled"])])),_:1})])),_:1})])),_:1},8,["modelValue"]),$(f,{modelValue:oe.value,"onUpdate:modelValue":s[14]||(s[14]=e=>oe.value=e),"max-width":"500px"},{default:q((()=>[$(g,null,{default:q((()=>[$(h,{class:"text-h6"},{default:q((()=>[$(x,{icon:"mdi-cog",class:"mr-2"}),s[23]||(s[23]=H(" 设置安全库存 "))])),_:1,__:[23]}),$(b,null,{default:q((()=>{var e,a;return[L("div",P,[s[24]||(s[24]=L("strong",null,"产品：",-1)),H(M(null==(e=re.value)?void 0:e.product_name)+" ",1),s[25]||(s[25]=L("br",null,null,-1)),s[26]||(s[26]=L("strong",null,"分类：",-1)),H(M(null==(a=re.value)?void 0:a.product_code),1)]),$(r,null,{default:q((()=>[$(c,{cols:"6"},{default:q((()=>[$(_,{modelValue:me.value.min_safety_days,"onUpdate:modelValue":s[11]||(s[11]=e=>me.value.min_safety_days=e),label:"最小安全库存",type:"number",step:"0.1",min:"0",suffix:"天",variant:"outlined",density:"compact","hide-details":""},null,8,["modelValue"])])),_:1}),$(c,{cols:"6"},{default:q((()=>[$(_,{modelValue:me.value.max_safety_days,"onUpdate:modelValue":s[12]||(s[12]=e=>me.value.max_safety_days=e),label:"最大安全库存",type:"number",step:"0.1",min:"0",suffix:"天",variant:"outlined",density:"compact","hide-details":""},null,8,["modelValue"])])),_:1})])),_:1}),$(C,{type:"info",variant:"tonal",class:"mt-4",density:"compact"},{default:q((()=>s[27]||(s[27]=[L("small",null,' 设置后将作为库存预警的参考标准。当前库存天数低于最小值时显示为"偏低"，高于最大值时显示为"偏高"。 ',-1)]))),_:1,__:[27]})]})),_:1}),$(k,null,{default:q((()=>[$(w),$(v,{variant:"text",onClick:s[13]||(s[13]=e=>oe.value=!1)},{default:q((()=>s[28]||(s[28]=[H(" 取消 ")]))),_:1,__:[28]}),$(v,{color:"primary",loading:Y.value,onClick:xe},{default:q((()=>s[29]||(s[29]=[H(" 保存 ")]))),_:1,__:[29]},8,["loading"])])),_:1})])),_:1})])),_:1},8,["modelValue"])])),_:1}))}},[["__scopeId","data-v-cb32986c"]]);export{Q as default};
