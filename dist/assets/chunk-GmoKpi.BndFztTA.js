import{_ as e,c as a,U as l,d as t,i as n,M as i,p as o}from"./entry-index.D92NaooR.js";import{h as s,K as r}from"./chunk-kpiUtils.CSbvtC9I.js";import{z as u,A as d,aa as c,j as m,k as v,f as _,Z as p,$ as g,m as f,l as y,V as h,e as k,g as J,T as V,h as T}from"./chunk-vue-core.CxEQweee.js";import{r as x,w as b,N as C,ae as w,ac as M,ad as A,K as U,H as E,u as S,a4 as I,ab as P,af as j,X as N}from"./chunk-vendors.D0_dqILu.js";import"./chunk-utils-vendor.DVew6AbD.js";import"./chunk-chart-core.HkgdsJMe.js";const O={class:"sticky-header-container"},$={class:"controls-bar"},z={class:"scrollable-table-container"},D={class:"font-weight-medium"},K={class:"text-center"},R={key:0,class:"d-flex align-center"},Y={key:1,class:"text-center text-grey"},F=e({__name:"GmoKpi",setup(e){const{month:F,year:G}=(()=>{const e=new Date,a=e.getMonth(),l=e.getFullYear();return 0===a?{month:12,year:l-1}:{month:a,year:l}})(),H=x(!1),L=x(!1),X=x(F),Z=x(G),q=x(!1),B=x(!1),Q=x(!1),W=x(!1),ee=x([]),ae=x(!1),le=x(null),te=Array.from({length:12},((e,a)=>({title:`${a+1}月`,value:a+1}))),ne=Array.from({length:5},((e,a)=>({title:`${(new Date).getFullYear()-2+a}年`,value:(new Date).getFullYear()-2+a}))),ie=[{title:"描述",key:"description",align:"start",width:"250px"},{title:"区域",key:"area",align:"center",width:"100px"},{title:"实际值",key:"actual_value",align:"center",width:"120px"},{title:"目标值",key:"target_value",align:"center",width:"120px"},{title:"YTD",key:"ytd_value",align:"center",width:"120px"},{title:"原因分析",key:"remark",align:"center",width:"150px"}],oe=[{title:"描述",key:"description",align:"start",width:"300px"},{title:"区域",key:"area",align:"center",width:"100px"},{title:"目标值",key:"target_value",align:"center",width:"150px"}],se=["Purchasing","Engineering (VA/VE)","Continuous Improvement","Total cost saving","Audit score","AP/AR Spread"],re=["TJM","TJC","汇总"],ue=x([]),de=x([]),ce=e=>"AP/AR Spread"===e.description&&(e.actual_value||0)<(e.target_value||0),me=()=>{B.value=!0,q.value=!0},ve=async()=>{H.value=!0;try{ue.value=(()=>{const e=[];let a=1;const l={Purchasing:["TJM","TJC","汇总"],"Engineering (VA/VE)":["TJM","TJC","汇总"],"Continuous Improvement":["TJM","TJC","汇总"],"Total cost saving":["TJM","TJC","汇总"],"Audit score":["TJM","TJC","汇总"],"AP/AR Spread":["TJM","TJC","汇总"]};return se.forEach((t=>{(l[t]||re).forEach((l=>{e.push({id:a++,description:t,area:l,actual_value:0,target_value:0,ytd_value:0,remark:null,action_plan_content:null,expected_close_date:null,actual_close_date:null,root_cause_analysis:null})}))})),e})();const a=await n("/gmo/kpi/",{params:{month:X.value,year:Z.value}});if(a.data&&a.data.length>0)a.data.forEach((e=>{const a=ue.value.find((a=>a.area===e.area&&a.description===e.description));a&&(a.actual_value=e.actual_value||0,a.target_value=e.target_value||0,a.ytd_value=e.ytd_value||0,a.remark=e.remark||null,a.action_plan_content=e.action_plan_content||null,a.expected_close_date=e.expected_close_date||null,a.actual_close_date=e.actual_close_date||null,a.root_cause_analysis=e.root_cause_analysis||null)}));else try{const e=await n("/gmo/kpi/targets/",{params:{year:Z.value}});e.data&&e.data.length>0&&e.data.forEach((e=>{const a=ue.value.find((a=>a.area===e.area&&a.description===e.description));a&&(a.target_value=e.target_value||0)}))}catch(e){}de.value=JSON.parse(JSON.stringify(ue.value)),B.value=!1}catch(e){i.error(`获取数据失败: ${e.message||"未知错误"}`)}finally{H.value=!1}},_e=async()=>{var e,a,l,t;L.value=!0;try{const e={month:X.value,year:Z.value,items:ue.value.map((e=>({area:e.area,description:e.description,actual_value:e.actual_value,ytd_value:e.ytd_value,remark:e.remark,action_plan_content:e.action_plan_content,expected_close_date:e.expected_close_date,actual_close_date:e.actual_close_date,root_cause_analysis:e.root_cause_analysis})))};await o("/gmo/kpi/",e),i.success("数据保存成功"),B.value=!1,de.value=JSON.parse(JSON.stringify(ue.value))}catch(n){const o=(null==(a=null==(e=n.response)?void 0:e.data)?void 0:a.detail)||(null==(t=null==(l=n.response)?void 0:l.data)?void 0:t.message)||n.message||"未知错误";i.error(`保存失败: ${o}`)}finally{L.value=!1}},pe=()=>{ue.value=JSON.parse(JSON.stringify(de.value)),B.value=!1,q.value=!1,i.info("数据已重置")};b([X,Z],(()=>{if(B.value){if(!confirm("当前有未保存的数据，切换月份将丢失这些数据，是否继续？"))return;ve()}else ve()}));const ge=async()=>{try{const e=await n("/gmo/kpi/targets/",{params:{year:Z.value}});if(e.data&&e.data.length>0)ee.value=e.data;else{ee.value=[];const e={Purchasing:["TJM","TJC","汇总"],"Engineering (VA/VE)":["TJM","TJC","汇总"],"Continuous Improvement":["TJM","TJC","汇总"],"Total cost saving":["TJM","TJC","汇总"],"Audit score":["TJM","TJC","汇总"],"AP/AR Spread":["TJM","TJC","汇总"]};se.forEach((a=>{(e[a]||re).forEach((e=>{ee.value.push({area:e,description:a,target_value:0})}))}))}Q.value=!0}catch(e){i.error("获取目标值失败")}},fe=async()=>{var e,a,l,t;W.value=!0;try{const e={year:Z.value,items:ee.value.map((e=>({area:e.area,description:e.description,target_value:e.target_value||0})))};await o("/gmo/kpi/targets/",e),i.success("目标值保存成功"),Q.value=!1,ve()}catch(n){const o=(null==(a=null==(e=n.response)?void 0:e.data)?void 0:a.detail)||(null==(t=null==(l=n.response)?void 0:l.data)?void 0:t.message)||n.message||"未知错误";i.error(`保存目标值失败: ${o}`)}finally{W.value=!1}},ye=e=>s(e)?"查看/编辑":"填写分析",he=e=>{le.value&&(le.value.root_cause_analysis=e.root_cause_analysis,le.value.action_plan_content=e.action_plan_content,le.value.expected_close_date=e.expected_close_date,le.value.actual_close_date=e.actual_close_date,me())};return C((()=>{ve()})),(e,n)=>(M(),w(t,{title:"GMO KPI管理",icon:"mdi-dna",color:"primary"},{default:A((()=>[U("div",O,[U("div",$,[E(u,{class:"align-center"},{default:A((()=>[E(d,{cols:"12",md:"6"},{default:A((()=>[E(u,null,{default:A((()=>[E(d,{cols:"6",md:"4"},{default:A((()=>[E(c,{modelValue:X.value,"onUpdate:modelValue":[n[0]||(n[0]=e=>X.value=e),ve],items:S(te),label:"选择月份",variant:"outlined",density:"compact","hide-details":"",class:"control-select"},null,8,["modelValue","items"])])),_:1}),E(d,{cols:"6",md:"4"},{default:A((()=>[E(c,{modelValue:Z.value,"onUpdate:modelValue":[n[1]||(n[1]=e=>Z.value=e),ve],items:S(ne),label:"选择年份",variant:"outlined",density:"compact","hide-details":"",class:"control-select"},null,8,["modelValue","items"])])),_:1})])),_:1})])),_:1}),E(m),E(d,{cols:"auto"},{default:A((()=>[E(v,{color:"info","prepend-icon":"mdi-target",variant:"outlined",class:"mr-2 action-btn",onClick:ge},{default:A((()=>n[7]||(n[7]=[I(" 设置目标值 ")]))),_:1,__:[7]}),E(v,{color:"secondary",disabled:!B.value,"prepend-icon":"mdi-refresh",variant:"outlined",class:"mr-2 action-btn",onClick:pe},{default:A((()=>n[8]||(n[8]=[I(" 重置 ")]))),_:1,__:[8]},8,["disabled"]),E(v,{color:"primary",loading:L.value,disabled:!B.value,"prepend-icon":"mdi-content-save",variant:"elevated",class:"action-btn",onClick:_e},{default:A((()=>n[9]||(n[9]=[I(" 保存数据 ")]))),_:1,__:[9]},8,["loading","disabled"])])),_:1})])),_:1})])]),E(a,{loading:H.value,message:"加载数据中..."},null,8,["loading"]),U("div",z,[E(l,{headers:ie,items:ue.value,loading:H.value,density:"comfortable",class:"gmo-kpi-table kpi-data-table frozen-header-table",hover:"","hide-default-footer":"","items-per-page":-1,"fixed-header":!0,height:"calc(100vh - 280px)"},{"item.description":A((({item:e})=>[U("div",D,N(e.description),1)])),"item.area":A((({item:e})=>{return[E(g,{color:(a=e.area,{TJM:"primary",TJC:"secondary","汇总":"success"}[a]||"default"),size:"small",variant:"flat"},{default:A((()=>[I(N(e.area),1)])),_:2},1032,["color"])];var a})),"item.actual_value":A((({item:e})=>[E(p,{modelValue:e.actual_value,"onUpdate:modelValue":a=>e.actual_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",class:"text-field-small",onInput:me},null,8,["modelValue","onUpdate:modelValue"])])),"item.target_value":A((({item:e})=>[U("div",K,[E(g,{color:"info",size:"small",variant:"flat"},{default:A((()=>{return[I(N((a=e.target_value||0,0===a?"0":a.toLocaleString())),1)];var a})),_:2},1024)])])),"item.ytd_value":A((({item:e})=>[E(p,{modelValue:e.ytd_value,"onUpdate:modelValue":a=>e.ytd_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",class:"text-field-small",onInput:me},null,8,["modelValue","onUpdate:modelValue"])])),"item.remark":A((({item:e})=>[ce(e)?(M(),P("div",R,[E(v,{size:"small",variant:"outlined",color:"warning","prepend-icon":"mdi-clipboard-edit",onClick:a=>(e=>{le.value=e,ae.value=!0})(e)},{default:A((()=>[I(N(ye(e)),1)])),_:2},1032,["onClick"]),S(s)(e)?(M(),w(_,{key:0,color:"success",class:"ml-2"},{default:A((()=>n[10]||(n[10]=[I(" mdi-check-circle ")]))),_:1,__:[10]})):j("",!0)])):(M(),P("div",Y," - "))])),_:1},8,["items","loading"])]),E(f,{modelValue:q.value,"onUpdate:modelValue":n[3]||(n[3]=e=>q.value=e),timeout:3e3,color:"warning",location:"bottom","multi-line":"",class:"change-alert"},{actions:A((()=>[E(v,{color:"white",variant:"text",onClick:n[2]||(n[2]=e=>q.value=!1)},{default:A((()=>n[11]||(n[11]=[I(" 关闭 ")]))),_:1,__:[11]})])),default:A((()=>[n[12]||(n[12]=I(" 数据已修改，请记得保存 "))])),_:1,__:[12]},8,["modelValue"]),E(y,{modelValue:Q.value,"onUpdate:modelValue":n[5]||(n[5]=e=>Q.value=e),"max-width":"800px"},{default:A((()=>[E(h,null,{default:A((()=>[E(k,{class:"text-h5"},{default:A((()=>[I(" 设置 "+N(Z.value)+" 年度目标值 ",1)])),_:1}),E(J,null,{default:A((()=>[E(V,{headers:oe,items:ee.value,density:"compact","items-per-page":50,"hide-default-footer":"",class:"elevation-1"},{"item.target_value":A((({item:e})=>[E(p,{modelValue:e.target_value,"onUpdate:modelValue":a=>e.target_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",class:"text-field-small"},null,8,["modelValue","onUpdate:modelValue"])])),_:1},8,["items"])])),_:1}),E(T,null,{default:A((()=>[E(m),E(v,{color:"grey",variant:"text",onClick:n[4]||(n[4]=e=>Q.value=!1)},{default:A((()=>n[13]||(n[13]=[I(" 取消 ")]))),_:1,__:[13]}),E(v,{color:"primary",variant:"elevated",loading:W.value,onClick:fe},{default:A((()=>n[14]||(n[14]=[I(" 保存目标值 ")]))),_:1,__:[14]},8,["loading"])])),_:1})])),_:1})])),_:1},8,["modelValue"]),E(r,{modelValue:ae.value,"onUpdate:modelValue":n[6]||(n[6]=e=>ae.value=e),item:le.value,title:"原因分析与行动计划",onSave:he},null,8,["modelValue","item"])])),_:1}))}},[["__scopeId","data-v-9cfec92a"]]);export{F as default};
