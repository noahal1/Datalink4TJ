import{_ as e,c as a,U as l,d as t,i as n,M as o,p as i}from"./entry-index.D92NaooR.js";import{h as r,K as s}from"./chunk-kpiUtils.CSbvtC9I.js";import{z as u,A as d,aa as c,j as m,k as v,m as _,f as p,Z as y,$ as f,l as g,V as h,e as k,g as V,h as b}from"./chunk-vue-core.CxEQweee.js";import{r as w,N as x,ae as E,ac as S,ad as U,K as P,H as C,u as N,a4 as J,ab as Y,af as H,X as I}from"./chunk-vendors.D0_dqILu.js";import"./chunk-utils-vendor.DVew6AbD.js";import"./chunk-chart-core.HkgdsJMe.js";const M={class:"sticky-header-container"},j={class:"controls-bar"},G={class:"scrollable-table-container"},K={class:"font-weight-medium"},T={class:"text-center"},z={key:0,class:"d-flex align-center"},$={key:1,class:"text-grey"},D=e({__name:"EhsKpi",setup(e){const{month:D,year:O}=(()=>{const e=new Date,a=e.getMonth(),l=e.getFullYear();return 0===a?{month:12,year:l-1}:{month:a,year:l}})(),A=w(!1),F=w(!1),R=w(D),X=w(O),Z=w(!1),q=w(!1),B=w(!1),L=w(!1),Q=w([]),W=w(!1),ee=w(null),ae=Array.from({length:12},((e,a)=>({title:`${a+1}月`,value:a+1}))),le=Array.from({length:5},((e,a)=>({title:`${(new Date).getFullYear()-2+a}年`,value:(new Date).getFullYear()-2+a}))),te=[{title:"Green",value:4},{title:"Yellow/Green",value:3},{title:"Yellow",value:2},{title:"Red",value:1}],ne={4:"Green",3:"Yellow/Green",2:"Yellow",1:"Red"},oe={Green:4,"Yellow/Green":3,Yellow:2,Red:1},ie=w([]),re=w([]),se=[{title:"KPI指标",key:"description",width:"30%",sortable:!1},{title:"区域",key:"area",width:"15%",sortable:!1},{title:"实际值",key:"actual_value",width:"15%",sortable:!1},{title:"目标值",key:"target_value",width:"15%",sortable:!1},{title:"YTD",key:"ytd_value",width:"15%",sortable:!1},{title:"原因分析",key:"remark",width:"10%",sortable:!1}],ue=[{title:"KPI指标",key:"description",width:"60%",sortable:!1},{title:"区域",key:"area",width:"20%",sortable:!1},{title:"目标值",key:"target_value",width:"20%",sortable:!1}],de=e=>({TJC:"primary",TJM:"secondary","汇总":"success"}[e]||"grey"),ce=e=>!(!e.target_value||0===e.target_value)&&("H&S Numeric Score"===e.description?e.actual_value<e.target_value:"Severity incident"===e.description||"Number of H&S audit/inspection action plans open >9 months"===e.description?e.actual_value>e.target_value:(e.description,!1)),me=()=>{q.value=!0,Z.value=!0},ve=async()=>{A.value=!0;try{ie.value=(()=>{const e=["TJC","TJM","汇总"],a=[];return["H&S Numeric Score","Environmental Performance","Severity incident","Number of H&S audit/inspection action plans open >9 months"].forEach((l=>{e.forEach((e=>{a.push({area:e,description:l,actual_value:"Environmental Performance"===l?4:0,target_value:"Environmental Performance"===l?4:0,ytd_value:"Environmental Performance"===l?4:0,remark:null,action_plan_content:null,expected_close_date:null,actual_close_date:null,root_cause_analysis:null})}))})),a})();const e=await n("/ehs/kpi/",{params:{month:R.value,year:X.value}});e.data&&e.data.length>0&&e.data.forEach((e=>{const a=ie.value.find((a=>a.area===e.area&&a.description===e.description));a&&("Environmental Performance"===a.description?(a.actual_value="string"==typeof e.actual_value?oe[e.actual_value]||4:e.actual_value||4,a.target_value="string"==typeof e.target_value?oe[e.target_value]||4:e.target_value||4,a.ytd_value="string"==typeof e.ytd_value?oe[e.ytd_value]||4:e.ytd_value||4):(a.actual_value=e.actual_value||0,a.target_value=e.target_value||0,a.ytd_value=e.ytd_value||0),a.remark=e.remark||null,a.action_plan_content=e.action_plan_content||null,a.expected_close_date=e.expected_close_date||null,a.actual_close_date=e.actual_close_date||null,a.root_cause_analysis=e.root_cause_analysis||null)})),re.value=JSON.parse(JSON.stringify(ie.value)),q.value=!1,Z.value=!1}catch(e){o.error(`加载数据失败: ${e.message||"未知错误"}`)}finally{A.value=!1}},_e=async()=>{F.value=!0;try{const e={month:R.value,year:X.value,items:ie.value.map((e=>({area:e.area,description:e.description,actual_value:e.actual_value,ytd_value:e.ytd_value,remark:e.remark,action_plan_content:e.action_plan_content,expected_close_date:e.expected_close_date,actual_close_date:e.actual_close_date,root_cause_analysis:e.root_cause_analysis})))};await i("/ehs/kpi/",e);o.success("数据保存成功"),q.value=!1,re.value=JSON.parse(JSON.stringify(ie.value))}catch(e){o.error(`保存失败: ${e.message||"未知错误"}`)}finally{F.value=!1}},pe=async()=>{try{const e=await n("/ehs/kpi/targets/",{params:{year:X.value}});if(e.data&&e.data.length>0)Q.value=e.data.map((e=>({...e,target_value:"Environmental Performance"===e.description&&"string"==typeof e.target_value?oe[e.target_value]||4:e.target_value})));else{Q.value=[];const e=["TJC","TJM","汇总"];["H&S Numeric Score","Environmental Performance","Severity incident","Number of H&S audit/inspection action plans open >9 months"].forEach((a=>{e.forEach((e=>{Q.value.push({area:e,description:a,target_value:"Environmental Performance"===a?4:0})}))}))}B.value=!0}catch(e){o.error("获取目标值失败")}},ye=async()=>{var e,a,l,t;L.value=!0;try{const e={year:X.value,items:Q.value.map((e=>({area:e.area,description:e.description,target_value:"Environmental Performance"===e.description?e.target_value||4:e.target_value||0})))};await i("/ehs/kpi/targets/",e),o.success("目标值保存成功"),B.value=!1,ve()}catch(n){const i=(null==(a=null==(e=n.response)?void 0:e.data)?void 0:a.detail)||(null==(t=null==(l=n.response)?void 0:l.data)?void 0:t.message)||n.message||"未知错误";o.error(`保存目标值失败: ${i}`)}finally{L.value=!1}},fe=e=>r(e)?"查看/编辑":"填写分析",ge=e=>{ee.value&&(ee.value.root_cause_analysis=e.root_cause_analysis,ee.value.action_plan_content=e.action_plan_content,ee.value.expected_close_date=e.expected_close_date,ee.value.actual_close_date=e.actual_close_date,me())};return x((()=>{ve()})),(e,n)=>(S(),E(t,{title:"EHS KPI管理",icon:"mdi-shield-check",color:"success"},{default:U((()=>[P("div",M,[P("div",j,[C(u,{class:"align-center"},{default:U((()=>[C(d,{cols:"12",md:"6"},{default:U((()=>[C(u,null,{default:U((()=>[C(d,{cols:"6",md:"4"},{default:U((()=>[C(c,{modelValue:R.value,"onUpdate:modelValue":[n[0]||(n[0]=e=>R.value=e),ve],items:N(ae),label:"选择月份",variant:"outlined",density:"compact","hide-details":"",class:"control-select"},null,8,["modelValue","items"])])),_:1}),C(d,{cols:"6",md:"4"},{default:U((()=>[C(c,{modelValue:X.value,"onUpdate:modelValue":[n[1]||(n[1]=e=>X.value=e),ve],items:N(le),label:"选择年份",variant:"outlined",density:"compact","hide-details":"",class:"control-select"},null,8,["modelValue","items"])])),_:1})])),_:1})])),_:1}),C(m),C(d,{cols:"auto"},{default:U((()=>[C(v,{color:"info",variant:"outlined","prepend-icon":"mdi-target",class:"mr-2 action-btn",onClick:pe},{default:U((()=>n[7]||(n[7]=[J(" 目标值管理 ")]))),_:1,__:[7]}),C(v,{color:"success","prepend-icon":"mdi-content-save",loading:F.value,disabled:!q.value,class:"action-btn",variant:"elevated",onClick:_e},{default:U((()=>n[8]||(n[8]=[J(" 保存数据 ")]))),_:1,__:[8]},8,["loading","disabled"])])),_:1})])),_:1})])]),C(a,{loading:A.value,message:"加载数据中..."},null,8,["loading"]),C(_,{modelValue:Z.value,"onUpdate:modelValue":n[3]||(n[3]=e=>Z.value=e),timeout:3e3,color:"warning",location:"bottom","multi-line":"",class:"change-alert"},{actions:U((()=>[C(v,{color:"white",variant:"text",loading:F.value,onClick:_e},{default:U((()=>n[9]||(n[9]=[J(" 保存 ")]))),_:1,__:[9]},8,["loading"]),C(v,{color:"white",variant:"text",onClick:n[2]||(n[2]=e=>Z.value=!1)},{default:U((()=>n[10]||(n[10]=[J(" 关闭 ")]))),_:1,__:[10]})])),default:U((()=>[C(p,{icon:"mdi-alert",class:"mr-2"}),n[11]||(n[11]=J(" 数据已修改，请记得保存！ "))])),_:1,__:[11]},8,["modelValue"]),P("div",G,[C(l,{headers:se,items:ie.value,loading:A.value,density:"comfortable",class:"ehs-kpi-table ehs-data-table frozen-header-table",hover:!1,"hide-default-footer":"","items-per-page":-1,"fixed-header":!0,height:"calc(100vh - 280px)"},{"item.description":U((({item:e})=>[P("div",K,I(e.description),1)])),"item.area":U((({item:e})=>[C(f,{color:de(e.area),size:"small",variant:"flat"},{default:U((()=>[J(I(e.area),1)])),_:2},1032,["color"])])),"item.actual_value":U((({item:e})=>["Environmental Performance"===e.description?(S(),E(c,{key:0,modelValue:e.actual_value,"onUpdate:modelValue":[a=>e.actual_value=a,me],items:te,variant:"outlined",density:"compact","hide-details":"",class:"text-field-small"},null,8,["modelValue","onUpdate:modelValue"])):(S(),E(y,{key:1,modelValue:e.actual_value,"onUpdate:modelValue":a=>e.actual_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",class:"text-field-small",onInput:me},null,8,["modelValue","onUpdate:modelValue"]))])),"item.target_value":U((({item:e})=>[P("div",T,[C(f,{color:e.target_value>0?"primary":"grey",size:"small",variant:"flat"},{default:U((()=>[J(I("Environmental Performance"===e.description?ne[e.target_value]||"Green":e.target_value||0),1)])),_:2},1032,["color"])])])),"item.ytd_value":U((({item:e})=>["Environmental Performance"===e.description?(S(),E(c,{key:0,modelValue:e.ytd_value,"onUpdate:modelValue":[a=>e.ytd_value=a,me],items:te,variant:"outlined",density:"compact","hide-details":"",class:"text-field-small"},null,8,["modelValue","onUpdate:modelValue"])):(S(),E(y,{key:1,modelValue:e.ytd_value,"onUpdate:modelValue":a=>e.ytd_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",class:"text-field-small",onInput:me},null,8,["modelValue","onUpdate:modelValue"]))])),"item.remark":U((({item:e})=>[ce(e)?(S(),Y("div",z,[C(v,{size:"small",variant:"outlined",color:"warning","prepend-icon":"mdi-clipboard-edit",onClick:a=>(e=>{ee.value=e,W.value=!0})(e)},{default:U((()=>[J(I(fe(e)),1)])),_:2},1032,["onClick"]),N(r)(e)?(S(),E(p,{key:0,color:"success",class:"ml-2"},{default:U((()=>n[12]||(n[12]=[J(" mdi-check-circle ")]))),_:1,__:[12]})):H("",!0)])):(S(),Y("span",$,"-"))])),_:1},8,["items","loading"])]),C(g,{modelValue:B.value,"onUpdate:modelValue":n[5]||(n[5]=e=>B.value=e),"max-width":"1200px",persistent:""},{default:U((()=>[C(h,null,{default:U((()=>[C(k,{class:"d-flex align-center"},{default:U((()=>[C(p,{class:"mr-2"},{default:U((()=>n[13]||(n[13]=[J(" mdi-target ")]))),_:1,__:[13]}),J(" "+I(X.value)+"年 EHS KPI 目标值设置 ",1)])),_:1}),C(V,null,{default:U((()=>[C(l,{headers:ue,items:Q.value,loading:!1,density:"compact","items-per-page":50,"hide-default-footer":""},{"item.area":U((({item:e})=>[C(f,{color:de(e.area),size:"small",variant:"flat"},{default:U((()=>[J(I(e.area),1)])),_:2},1032,["color"])])),"item.target_value":U((({item:e})=>["Environmental Performance"===e.description?(S(),E(c,{key:0,modelValue:e.target_value,"onUpdate:modelValue":a=>e.target_value=a,items:te,variant:"outlined",density:"compact","hide-details":"",class:"text-field-small environmental-select"},null,8,["modelValue","onUpdate:modelValue"])):(S(),E(y,{key:1,modelValue:e.target_value,"onUpdate:modelValue":a=>e.target_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",class:"text-field-small"},null,8,["modelValue","onUpdate:modelValue"]))])),_:1},8,["items"])])),_:1}),C(b,null,{default:U((()=>[C(m),C(v,{variant:"text",onClick:n[4]||(n[4]=e=>B.value=!1)},{default:U((()=>n[14]||(n[14]=[J(" 取消 ")]))),_:1,__:[14]}),C(v,{color:"primary",loading:L.value,onClick:ye},{default:U((()=>n[15]||(n[15]=[J(" 保存目标值 ")]))),_:1,__:[15]},8,["loading"])])),_:1})])),_:1})])),_:1},8,["modelValue"]),C(s,{modelValue:W.value,"onUpdate:modelValue":n[6]||(n[6]=e=>W.value=e),item:ee.value,title:"原因分析与行动计划",onSave:ge},null,8,["modelValue","item"])])),_:1}))}},[["__scopeId","data-v-b077314d"]]);export{D as default};
