import{_ as e,U as a,d as t,i as l,M as u,p as i}from"./entry-index.D92NaooR.js";import{h as r,K as o}from"./chunk-kpiUtils.CSbvtC9I.js";import{z as s,A as n,aa as c,k as d,m as _,f as m,$ as v,Z as p,l as y,V as f,e as g,g as h,h as k,j as V}from"./chunk-vue-core.CxEQweee.js";import{r as b,N as w,ae as x,ac as U,ad as C,H as M,u as J,a4 as I,ab as j,af as K,X as T,K as z}from"./chunk-vendors.D0_dqILu.js";import"./chunk-utils-vendor.DVew6AbD.js";import"./chunk-chart-core.HkgdsJMe.js";const P={class:"font-weight-medium"},A={class:"text-center"},E={key:0,class:"d-flex align-center"},N={key:1,class:"text-grey"},S=e({__name:"MaintenanceKpi",setup(e){const{month:S,year:$}=(()=>{const e=new Date,a=e.getMonth(),t=e.getFullYear();return 0===a?{month:12,year:t-1}:{month:a,year:t}})(),D=b(!1),O=b(!1),Y=b(S),F=b($),H=b(!1),X=b(!1),Z=b(!1),q=b(!1),B=b([]),G=b(!1),L=b(null),Q=Array.from({length:12},((e,a)=>({title:`${a+1}月`,value:a+1}))),R=Array.from({length:5},((e,a)=>({title:`${(new Date).getFullYear()-2+a}年`,value:(new Date).getFullYear()-2+a}))),W=b([]),ee=b([]),ae=[{title:"KPI指标",key:"description",width:"30%",sortable:!1},{title:"区域",key:"area",width:"12%",sortable:!1},{title:"实际值(%)",key:"actual_value",width:"14%",sortable:!1},{title:"目标值(%)",key:"target_value",width:"14%",sortable:!1},{title:"YTD(%)",key:"ytd_value",width:"14%",sortable:!1},{title:"达成状态",key:"status",width:"12%",sortable:!1},{title:"原因分析",key:"remark",width:"14%",sortable:!1}],te=[{title:"KPI指标",key:"description",width:"60%",sortable:!1},{title:"区域",key:"area",width:"20%",sortable:!1},{title:"目标值(%)",key:"target_value",width:"20%",sortable:!1}],le=e=>({TJC:"primary",TJM:"secondary","汇总":"success"}[e]||"grey"),ue=e=>{if(!e.target_value||0===e.target_value)return"grey";const a=e.actual_value/e.target_value;return a>=1?"success":a>=.8?"warning":"error"},ie=e=>{if(!e.target_value||0===e.target_value)return"无目标";const a=e.actual_value/e.target_value;return a>=1?"达成":a>=.8?"接近":"未达成"},re=e=>!(!e.target_value||0===e.target_value)&&e.actual_value<e.target_value,oe=()=>{X.value=!0,H.value=!0},se=async()=>{D.value=!0;try{W.value=(()=>{const e=["TJC","TJM","汇总"],a=[];return["Preventative Maintenance Attainment"].forEach((t=>{e.forEach((e=>{a.push({area:e,description:t,actual_value:0,target_value:0,ytd_value:0,remark:null,action_plan_content:null,expected_close_date:null,actual_close_date:null,root_cause_analysis:null})}))})),a})();const e=await l("/maint/kpi/",{params:{month:Y.value,year:F.value}});e.data&&e.data.length>0&&e.data.forEach((e=>{const a=W.value.find((a=>a.area===e.area&&a.description===e.description));a&&(a.actual_value=e.actual_value||0,a.target_value=e.target_value||0,a.ytd_value=e.ytd_value||0,a.remark=e.remark||null,a.action_plan_content=e.action_plan_content||null,a.expected_close_date=e.expected_close_date||null,a.actual_close_date=e.actual_close_date||null,a.root_cause_analysis=e.root_cause_analysis||null)})),ee.value=JSON.parse(JSON.stringify(W.value)),X.value=!1,H.value=!1}catch(e){u.error(`加载数据失败: ${e.message||"未知错误"}`)}finally{D.value=!1}},ne=async()=>{O.value=!0;try{const e={month:Y.value,year:F.value,items:W.value.map((e=>({area:e.area,description:e.description,actual_value:e.actual_value,ytd_value:e.ytd_value,remark:e.remark,action_plan_content:e.action_plan_content,expected_close_date:e.expected_close_date,actual_close_date:e.actual_close_date,root_cause_analysis:e.root_cause_analysis})))};await i("/maint/kpi/",e),u.success("数据保存成功"),X.value=!1,ee.value=JSON.parse(JSON.stringify(W.value))}catch(e){u.error(`保存失败: ${e.message||"未知错误"}`)}finally{O.value=!1}},ce=async()=>{try{const e=await l("/maint/kpi/targets/",{params:{year:F.value}});if(e.data&&e.data.length>0)B.value=e.data;else{B.value=[];const e=["TJC","TJM","汇总"];["Preventative Maintenance Attainment"].forEach((a=>{e.forEach((e=>{B.value.push({area:e,description:a,target_value:0})}))}))}Z.value=!0}catch(e){u.error("获取目标值失败")}},de=async()=>{q.value=!0;try{const e={year:F.value,items:B.value.map((e=>({area:e.area,description:e.description,target_value:e.target_value||0})))};await i("/maint/kpi/targets/",e),u.success("目标值保存成功"),Z.value=!1,se()}catch(e){u.error("保存目标值失败")}finally{q.value=!1}},_e=e=>r(e)?"查看/编辑":"填写分析",me=e=>{L.value&&(L.value.root_cause_analysis=e.root_cause_analysis,L.value.action_plan_content=e.action_plan_content,L.value.expected_close_date=e.expected_close_date,L.value.actual_close_date=e.actual_close_date,oe())};return w((()=>{se()})),(e,l)=>(U(),x(t,{title:"维修KPI管理",icon:"mdi-wrench",color:"warning"},{default:C((()=>[M(s,{class:"mb-4 align-center"},{default:C((()=>[M(n,{cols:"12",md:"6"},{default:C((()=>[M(s,null,{default:C((()=>[M(n,{cols:"6",md:"4"},{default:C((()=>[M(c,{modelValue:Y.value,"onUpdate:modelValue":[l[0]||(l[0]=e=>Y.value=e),se],items:J(Q),label:"选择月份",variant:"outlined",density:"compact"},null,8,["modelValue","items"])])),_:1}),M(n,{cols:"6",md:"4"},{default:C((()=>[M(c,{modelValue:F.value,"onUpdate:modelValue":[l[1]||(l[1]=e=>F.value=e),se],items:J(R),label:"选择年份",variant:"outlined",density:"compact"},null,8,["modelValue","items"])])),_:1})])),_:1})])),_:1}),M(n,{cols:"12",md:"6",class:"text-right"},{default:C((()=>[M(d,{color:"primary",variant:"outlined","prepend-icon":"mdi-target",class:"mr-2",onClick:ce},{default:C((()=>l[7]||(l[7]=[I(" 目标值管理 ")]))),_:1,__:[7]}),M(d,{color:"success","prepend-icon":"mdi-content-save",loading:O.value,disabled:!X.value,onClick:ne},{default:C((()=>l[8]||(l[8]=[I(" 保存数据 ")]))),_:1,__:[8]},8,["loading","disabled"])])),_:1})])),_:1}),M(_,{modelValue:H.value,"onUpdate:modelValue":l[3]||(l[3]=e=>H.value=e),timeout:3e3,color:"warning",location:"bottom","multi-line":"",class:"change-alert"},{actions:C((()=>[M(d,{color:"white",variant:"text",loading:O.value,onClick:ne},{default:C((()=>l[10]||(l[10]=[I(" 保存 ")]))),_:1,__:[10]},8,["loading"]),M(d,{color:"white",variant:"text",onClick:l[2]||(l[2]=e=>H.value=!1)},{default:C((()=>l[11]||(l[11]=[I(" 关闭 ")]))),_:1,__:[11]})])),default:C((()=>[M(m,{start:"",class:"mr-2"},{default:C((()=>l[9]||(l[9]=[I(" mdi-alert ")]))),_:1,__:[9]}),l[12]||(l[12]=I(" 数据已修改，请记得保存 "))])),_:1,__:[12]},8,["modelValue"]),M(a,{headers:ae,items:W.value,loading:D.value,density:"comfortable",class:"mb-6","hide-default-footer":""},{"item.description":C((({item:e})=>[z("div",P,T(e.description),1)])),"item.area":C((({item:e})=>[M(v,{color:le(e.area),size:"small",variant:"flat"},{default:C((()=>[I(T(e.area),1)])),_:2},1032,["color"])])),"item.actual_value":C((({item:e})=>[M(p,{modelValue:e.actual_value,"onUpdate:modelValue":a=>e.actual_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",class:"text-field-small",onInput:oe},null,8,["modelValue","onUpdate:modelValue"])])),"item.target_value":C((({item:e})=>[z("div",A,[M(v,{color:e.target_value>0?"primary":"grey",size:"small",variant:"flat"},{default:C((()=>[I(T(e.target_value||0),1)])),_:2},1032,["color"])])])),"item.ytd_value":C((({item:e})=>[M(p,{modelValue:e.ytd_value,"onUpdate:modelValue":a=>e.ytd_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",class:"text-field-small",onInput:oe},null,8,["modelValue","onUpdate:modelValue"])])),"item.status":C((({item:e})=>[M(v,{color:ue(e),size:"small",variant:"flat"},{default:C((()=>[I(T(ie(e)),1)])),_:2},1032,["color"])])),"item.remark":C((({item:e})=>[re(e)?(U(),j("div",E,[M(d,{size:"small",variant:"outlined",color:"warning","prepend-icon":"mdi-clipboard-edit",onClick:a=>(e=>{L.value=e,G.value=!0})(e)},{default:C((()=>[I(T(_e(e)),1)])),_:2},1032,["onClick"]),J(r)(e)?(U(),x(m,{key:0,color:"success",class:"ml-2"},{default:C((()=>l[13]||(l[13]=[I(" mdi-check-circle ")]))),_:1,__:[13]})):K("",!0)])):(U(),j("span",N,"-"))])),_:1},8,["items","loading"]),M(y,{modelValue:Z.value,"onUpdate:modelValue":l[5]||(l[5]=e=>Z.value=e),"max-width":"1200px",persistent:""},{default:C((()=>[M(f,null,{default:C((()=>[M(g,{class:"d-flex align-center"},{default:C((()=>[M(m,{class:"mr-2"},{default:C((()=>l[14]||(l[14]=[I(" mdi-target ")]))),_:1,__:[14]}),I(" "+T(F.value)+"年 维修KPI 目标值设置 ",1)])),_:1}),M(h,null,{default:C((()=>[M(a,{headers:te,items:B.value,loading:!1,density:"compact","items-per-page":50},{"item.area":C((({item:e})=>[M(v,{color:le(e.area),size:"small",variant:"flat"},{default:C((()=>[I(T(e.area),1)])),_:2},1032,["color"])])),"item.target_value":C((({item:e})=>[M(p,{modelValue:e.target_value,"onUpdate:modelValue":a=>e.target_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",class:"text-field-small"},null,8,["modelValue","onUpdate:modelValue"])])),_:1},8,["items"])])),_:1}),M(k,null,{default:C((()=>[M(V),M(d,{variant:"text",onClick:l[4]||(l[4]=e=>Z.value=!1)},{default:C((()=>l[15]||(l[15]=[I(" 取消 ")]))),_:1,__:[15]}),M(d,{color:"primary",loading:q.value,onClick:de},{default:C((()=>l[16]||(l[16]=[I(" 保存目标值 ")]))),_:1,__:[16]},8,["loading"])])),_:1})])),_:1})])),_:1},8,["modelValue"]),M(o,{modelValue:G.value,"onUpdate:modelValue":l[6]||(l[6]=e=>G.value=e),item:L.value,title:"原因分析与行动计划",onSave:me},null,8,["modelValue","item"])])),_:1}))}},[["__scopeId","data-v-de150578"]]);export{S as default};
