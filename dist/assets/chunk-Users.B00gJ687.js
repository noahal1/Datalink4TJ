import{_ as e,b as a,M as l,U as t,f as s}from"./entry-index.D92NaooR.js";import{V as u,e as r,v as i,g as o,o as d,a1 as n,z as v,A as c,af as m,$ as p,j as _,Z as f,T as y,h as g,k as h,l as w,f as V,aa as b,ae as k,F as x}from"./chunk-vue-core.CxEQweee.js";import{r as C,w as U,ae as z,ac as A,ad as j,H as N,K as P,X as $,ab as q,af as I,a4 as L,F as D,ag as E,N as F}from"./chunk-vendors.D0_dqILu.js";import{u as H}from"./chunk-useNotification.BHip036b.js";import"./chunk-utils-vendor.DVew6AbD.js";import"./chunk-chart-core.HkgdsJMe.js";const R={key:0,class:"d-flex justify-center align-center",style:{height:"200px"}},S={key:1},B={class:"mb-2"},K={key:0,class:"text-grey"},M=["title"],O={class:"text-grey"},T=e({__name:"UserRoleDialog",props:{modelValue:{type:Boolean,default:!1},user:{type:Object,default:()=>({id:null,name:"",roles:[]})}},emits:["update:modelValue","save","close"],setup(e,{emit:t}){const s=e,V=t,b=C(s.modelValue),k=C(""),x=C([]),F=C([]),H=C([]),T=C(!1),X=C(!1),Z=C(!1),G=C(""),J=[{title:"角色名称",key:"name",sortable:!0},{title:"描述",key:"description",sortable:!0},{title:"权限数量",key:"permissions_count",sortable:!0}];U((()=>s.modelValue),(e=>{b.value=e,e&&Q()})),U((()=>b.value),(e=>{V("update:modelValue",e)})),U((()=>s.user),(e=>{var a;e&&e.roles?(H.value=[...e.roles||[]],F.value=(null==(a=e.roles)?void 0:a.map((e=>e.id)))||[]):(H.value=[],F.value=[])}));const Q=async()=>{var e;T.value=!0,G.value="";try{await W(),s.user&&s.user.roles&&(H.value=[...s.user.roles||[]],F.value=(null==(e=s.user.roles)?void 0:e.map((e=>e.id)))||[])}catch(a){G.value="加载数据失败: "+(a.message||"未知错误")}finally{T.value=!1}},W=async()=>{X.value=!0;try{const e=await a.get("/roles");e&&e.data&&Array.isArray(e.data)?x.value=e.data:x.value=[]}catch(e){throw e.response||e.request,x.value=[],G.value="无法加载角色列表: "+(e.message||"未知错误"),e}finally{X.value=!1}},Y=async()=>{var e,t;if(s.user&&s.user.id){Z.value=!0,G.value="";try{const e=Number(s.user.id);if(isNaN(e)||e<=0)throw new Error(`无效的用户ID: ${s.user.id}`);const t=F.value.map((e=>{const a=Number(e);if(isNaN(a)||a<=0)throw new Error(`无效的角色ID: ${e}`);return a}));await a.post(`/users/${e}/roles`,{role_ids:t}),l.success("角色分配成功"),V("save",{userId:s.user.id,roleIds:F.value}),ee()}catch(u){G.value="保存失败: "+((null==(t=null==(e=u.response)?void 0:e.data)?void 0:t.detail)||u.message||"未知错误"),l.error(G.value)}finally{Z.value=!1}}else G.value="无效的用户信息"},ee=()=>{V("close"),b.value=!1};return(a,l)=>(A(),z(w,{modelValue:b.value,"onUpdate:modelValue":l[2]||(l[2]=e=>b.value=e),"max-width":"700px",persistent:"","onClick:outside":ee},{default:j((()=>[N(u,null,{default:j((()=>[N(r,{class:"text-h5"},{default:j((()=>[P("span",null,"为 "+$(e.user.name)+" 分配角色",1)])),_:1}),N(i),N(o,{class:"pt-4"},{default:j((()=>[T.value?(A(),q("div",R,[N(d,{indeterminate:"",color:"primary"})])):(A(),q("div",S,[G.value?(A(),z(n,{key:0,type:"error",density:"compact",class:"mb-4"},{default:j((()=>[L($(G.value),1)])),_:1})):I("",!0),N(u,{class:"pa-2 mb-4",variant:"outlined"},{default:j((()=>[N(r,{class:"text-subtitle-1"},{default:j((()=>l[3]||(l[3]=[L(" 用户信息 ")]))),_:1,__:[3]}),N(o,null,{default:j((()=>[N(v,{dense:""},{default:j((()=>[N(c,{cols:"12",sm:"6"},{default:j((()=>[P("div",null,[l[4]||(l[4]=P("strong",null,"用户名:",-1)),L(" "+$(e.user.name),1)])])),_:1}),N(c,{cols:"12",sm:"6"},{default:j((()=>{var a;return[P("div",null,[l[5]||(l[5]=P("strong",null,"部门:",-1)),L(" "+$((null==(a=e.user.department)?void 0:a.name)||"未分配"),1)])]})),_:1})])),_:1})])),_:1})])),_:1}),P("div",B,[l[6]||(l[6]=P("strong",null,"当前拥有角色:",-1)),N(m,{class:"mt-2"},{default:j((()=>[(A(!0),q(D,null,E(H.value,(e=>{return A(),z(p,{key:e.id,color:(a=e.name,{"超级管理员":"red","管理员":"deep-orange","部门负责人":"indigo","班组负责人":"cyan","普通用户":"teal"}[a]||"grey"),variant:"outlined"},{default:j((()=>[L($(e.name),1)])),_:2},1032,["color"]);var a})),128)),0===H.value.length?(A(),q("div",K," 未分配任何角色 ")):I("",!0)])),_:1})]),N(i,{class:"my-4"}),N(r,{class:"text-subtitle-1 px-0"},{default:j((()=>[l[7]||(l[7]=L(" 分配角色 ")),N(_),N(f,{modelValue:k.value,"onUpdate:modelValue":l[0]||(l[0]=e=>k.value=e),"append-icon":"mdi-magnify",label:"搜索角色","single-line":"","hide-details":"",density:"compact",style:{"max-width":"200px"}},null,8,["modelValue"])])),_:1,__:[7]}),N(y,{modelValue:F.value,"onUpdate:modelValue":l[1]||(l[1]=e=>F.value=e),headers:J,items:x.value,search:k.value,loading:X.value,density:"comfortable",class:"elevation-1","item-value":"id","items-per-page":10,"show-select":""},{"item.description":j((({item:e})=>[P("div",{class:"text-truncate",style:{"max-width":"300px"},title:e.description},$(e.description||"无描述"),9,M)])),"item.permissions_count":j((({item:e})=>{var a,l;return[N(p,{color:(l=(null==(a=e.permissions)?void 0:a.length)||0,0===l?"grey":l<3?"blue":l<6?"green":l<10?"amber":"red"),"text-color":"white",size:"small"},{default:j((()=>{var a;return[L($((null==(a=e.permissions)?void 0:a.length)||0),1)]})),_:2},1032,["color"])]})),_:1},8,["modelValue","items","search","loading"])]))])),_:1}),N(i),N(g,null,{default:j((()=>[P("small",O,"已选择 "+$(F.value.length)+" 个角色",1),N(_),N(h,{color:"grey-darken-1",variant:"text",disabled:Z.value,onClick:ee},{default:j((()=>l[8]||(l[8]=[L(" 取消 ")]))),_:1,__:[8]},8,["disabled"]),N(h,{color:"primary",loading:Z.value,disabled:Z.value,onClick:Y},{default:j((()=>l[9]||(l[9]=[L(" 保存 ")]))),_:1,__:[9]},8,["loading","disabled"])])),_:1})])),_:1})])),_:1},8,["modelValue"]))}},[["__scopeId","data-v-0a390626"]]),X={key:1,class:"text-caption text-grey"},Z={key:0},G={key:1,class:"text-caption text-grey"},J=e({__name:"Users",setup(e){const{showSuccess:l,showError:i}=H(),d=[{title:"用户名",key:"name",align:"start",sortable:!0},{title:"部门",key:"department",align:"start",sortable:!0},{title:"角色",key:"roles",align:"start",sortable:!1},{title:"状态",key:"is_active",align:"center",sortable:!0},{title:"操作",key:"actions",align:"center",sortable:!1}],n=C([]),m=C([]),y=C([]),U=C(!1),R=C(!1),S=C(!1),B=C(""),K=C(!1),M=C(100),O=C(1),J=C({name:"",department_id:null,role:"",is_active:null}),Q=C(!1),W=C(""),Y=C(""),ee=C({name:"",password:"",department_id:"",is_active:!0}),ae=C(!1),le=C({password:"",confirmPassword:""}),te=C(!1),se=C(null),ue={required:e=>null!=e&&""!==e||"此字段为必填项"},re=()=>le.value.password===le.value.confirmPassword||"两次输入的密码不一致",ie=async()=>{U.value=!0;try{const e=(O.value-1)*M.value,l=await a.get("/users",{params:{skip:e,limit:M.value}});l&&l.data&&Array.isArray(l.data)?(n.value=l.data.map((e=>({...e,roles:e.roles||[]}))),m.value=[...n.value]):l&&Array.isArray(l)?(n.value=l.map((e=>({...e,roles:e.roles||[]}))),m.value=[...n.value]):(n.value=[],m.value=[],i("用户数据格式不正确"))}catch(e){i("获取用户列表失败"),n.value=[],m.value=[]}finally{U.value=!1}},oe=(e,a)=>{var l;Y.value=e,W.value="add"===e?"添加用户":"编辑用户","add"===e?ee.value={name:"",password:"",department_id:"",is_active:!0}:"edit"===e&&a&&(ee.value={id:a.id,name:a.name,department_id:(null==(l=a.department)?void 0:l.id)||a.department_id||"",is_active:void 0===a.is_active||a.is_active}),Q.value=!0},de=async()=>{var e,t;try{R.value=!0,"add"===Y.value?(await a.post("/users",ee.value),l("用户创建成功")):(await a.put(`/users/${ee.value.id}`,ee.value),l("用户更新成功")),Q.value=!1,ie()}catch(s){i("保存用户失败: "+((null==(t=null==(e=s.response)?void 0:e.data)?void 0:t.detail)||s.message))}finally{R.value=!1}},ne=async()=>{var e,t;if(le.value.password===le.value.confirmPassword)try{S.value=!0,await a.post(`/users/${se.value.id}/reset-password`,{password:le.value.password}),l("密码重置成功"),ae.value=!1}catch(s){i("重置密码失败: "+((null==(t=null==(e=s.response)?void 0:e.data)?void 0:t.detail)||s.message))}finally{S.value=!1}else i("两次输入的密码不一致")},ve=()=>{ie(),te.value=!1},ce=()=>{K.value=!1;const e=m.value.filter((e=>{var a;let l=!0;if(J.value.name&&!e.name.toLowerCase().includes(J.value.name.toLowerCase())&&(l=!1),J.value.department_id&&(null==(a=e.department)?void 0:a.id)!==J.value.department_id&&(l=!1),J.value.role&&e.roles&&e.roles.length>0){e.roles.some((e=>e.name.toLowerCase().includes(J.value.role.toLowerCase())))||(l=!1)}return null!==J.value.is_active&&e.is_active!==J.value.is_active&&(l=!1),l}));n.value=e},me=()=>{J.value={name:"",department_id:null,role:"",is_active:null},n.value=[...m.value]},pe=e=>{O.value=e,ie()},_e=e=>{M.value=e,O.value=1,ie()};return F((()=>{ie(),(async()=>{try{const e=await a.get("/departments/");e&&e.data&&Array.isArray(e.data)?y.value=e.data:e&&Array.isArray(e)?y.value=e:(y.value=[],i("部门数据格式不正确"))}catch(e){i("获取部门列表失败"),y.value=[]}})()})),(e,m)=>(A(),q("div",null,[N(v,null,{default:j((()=>[N(c,{cols:"12"},{default:j((()=>[N(t,{title:"用户管理",icon:"mdi-account-group",headers:d,items:n.value,loading:U.value,search:B.value,"items-per-page":M.value,"hide-default-footer":!1,"onUpdate:page":pe,"onUpdate:itemsPerPage":_e},{title:j((()=>[m[21]||(m[21]=P("span",null,"用户管理",-1)),N(_),N(f,{modelValue:B.value,"onUpdate:modelValue":m[0]||(m[0]=e=>B.value=e),"append-icon":"mdi-magnify",label:"搜索用户","single-line":"","hide-details":"",density:"compact",class:"ml-4",style:{"max-width":"300px"}},null,8,["modelValue"])])),"item.department":j((({item:e})=>{var a;return[(null==(a=e.department)?void 0:a.name)?(A(),z(p,{key:0,size:"small",color:"primary",variant:"flat"},{default:j((()=>{var a;return[L($(null==(a=e.department)?void 0:a.name),1)]})),_:2},1024)):(A(),q("span",X,"未分配"))]})),"item.roles":j((({item:e})=>[e.roles&&e.roles.length>0?(A(),q("div",Z,[(A(!0),q(D,null,E(e.roles.slice(0,2),((e,a)=>{return A(),z(p,{key:a,size:"x-small",class:"mr-1",color:(l=e.name,{"超级管理员":"red","管理员":"orange","部门负责人":"indigo","班组负责人":"cyan","普通用户":"teal"}[l]||"grey"),variant:"outlined"},{default:j((()=>[L($(e.name),1)])),_:2},1032,["color"]);var l})),128)),e.roles.length>2?(A(),z(p,{key:0,size:"x-small",color:"grey",variant:"outlined"},{default:j((()=>[L(" +"+$(e.roles.length-2),1)])),_:2},1024)):I("",!0)])):(A(),q("span",G,"未分配角色"))])),"item.is_active":j((({item:e})=>[N(p,{color:e.is_active?"success":"error",size:"small"},{default:j((()=>[L($(e.is_active?"启用":"禁用"),1)])),_:2},1032,["color"])])),"item.actions":j((({item:e})=>[N(h,{size:"small",variant:"text",color:"primary",class:"mr-1",onClick:a=>{oe("edit",e)}},{default:j((()=>[N(V,null,{default:j((()=>m[22]||(m[22]=[L("mdi-pencil")]))),_:1,__:[22]}),m[23]||(m[23]=L(" 编辑 "))])),_:2,__:[23]},1032,["onClick"]),N(h,{size:"small",variant:"text",color:"info",class:"mr-1",onClick:a=>{return l=e,se.value=l,void(te.value=!0);var l}},{default:j((()=>[N(V,null,{default:j((()=>m[24]||(m[24]=[L("mdi-account-key")]))),_:1,__:[24]}),m[25]||(m[25]=L(" 角色 "))])),_:2,__:[25]},1032,["onClick"]),N(h,{size:"small",variant:"text",color:"warning",class:"mr-1",onClick:a=>{return l=e,se.value=l,le.value={password:"",confirmPassword:""},void(ae.value=!0);var l}},{default:j((()=>[N(V,null,{default:j((()=>m[26]||(m[26]=[L("mdi-lock-reset")]))),_:1,__:[26]}),m[27]||(m[27]=L(" 重置密码 "))])),_:2,__:[27]},1032,["onClick"]),N(h,{size:"small",variant:"text",color:e.is_active?"error":"success",onClick:t=>(async e=>{var t,s;try{U.value=!0,await a.put(`/users/${e.id}/status`,{is_active:!e.is_active}),l(`用户${e.is_active?"禁用":"启用"}成功`),ie()}catch(u){i("更新用户状态失败: "+((null==(s=null==(t=u.response)?void 0:t.data)?void 0:s.detail)||u.message))}finally{U.value=!1}})(e)},{default:j((()=>[N(V,null,{default:j((()=>[L($(e.is_active?"mdi-account-off":"mdi-account-check"),1)])),_:2},1024),L(" "+$(e.is_active?"禁用":"启用"),1)])),_:2},1032,["color","onClick"])])),actions:j((()=>[N(h,{color:"primary","prepend-icon":"mdi-plus",onClick:m[1]||(m[1]=e=>oe("add"))},{default:j((()=>m[28]||(m[28]=[L(" 添加用户 ")]))),_:1,__:[28]}),N(h,{class:"ml-2",color:"secondary","prepend-icon":"mdi-refresh",onClick:ie},{default:j((()=>m[29]||(m[29]=[L(" 刷新 ")]))),_:1,__:[29]}),N(h,{class:"ml-2",color:"info","prepend-icon":"mdi-filter",onClick:m[2]||(m[2]=e=>K.value=!0)},{default:j((()=>m[30]||(m[30]=[L(" 筛选 ")]))),_:1,__:[30]})])),_:1},8,["items","loading","search","items-per-page"])])),_:1})])),_:1}),N(w,{modelValue:Q.value,"onUpdate:modelValue":m[8]||(m[8]=e=>Q.value=e),"max-width":"500px"},{default:j((()=>[N(u,null,{default:j((()=>[N(r,{class:"text-h5 bg-primary text-white"},{default:j((()=>[L($(W.value),1)])),_:1}),N(o,{class:"pt-4"},{default:j((()=>[N(s,{ref:"userFormRef","show-default-actions":!1},{default:j((()=>[N(f,{modelValue:ee.value.name,"onUpdate:modelValue":m[3]||(m[3]=e=>ee.value.name=e),label:"用户名",placeholder:"请输入用户名",variant:"outlined",density:"comfortable",rules:[ue.required]},null,8,["modelValue","rules"]),"add"===Y.value?(A(),z(f,{key:0,modelValue:ee.value.password,"onUpdate:modelValue":m[4]||(m[4]=e=>ee.value.password=e),label:"密码",placeholder:"请输入密码",type:"password",variant:"outlined",density:"comfortable",rules:[ue.required]},null,8,["modelValue","rules"])):I("",!0),N(b,{modelValue:ee.value.department_id,"onUpdate:modelValue":m[5]||(m[5]=e=>ee.value.department_id=e),items:y.value,"item-title":"name","item-value":"id",label:"部门",placeholder:"请选择部门",variant:"outlined",density:"comfortable",rules:[ue.required]},null,8,["modelValue","items","rules"]),"edit"===Y.value?(A(),z(k,{key:1,modelValue:ee.value.is_active,"onUpdate:modelValue":m[6]||(m[6]=e=>ee.value.is_active=e),label:"启用账户",color:"success","hide-details":"",class:"mt-2"},null,8,["modelValue"])):I("",!0)])),_:1},512)])),_:1}),N(g,null,{default:j((()=>[N(_),N(h,{color:"grey",variant:"text",onClick:m[7]||(m[7]=e=>Q.value=!1)},{default:j((()=>m[31]||(m[31]=[L(" 取消 ")]))),_:1,__:[31]}),N(h,{color:"primary",loading:R.value,onClick:de},{default:j((()=>m[32]||(m[32]=[L(" 确定 ")]))),_:1,__:[32]},8,["loading"])])),_:1})])),_:1})])),_:1},8,["modelValue"]),N(w,{modelValue:ae.value,"onUpdate:modelValue":m[12]||(m[12]=e=>ae.value=e),"max-width":"500px"},{default:j((()=>[N(u,null,{default:j((()=>[N(r,{class:"text-h5 bg-warning text-white"},{default:j((()=>m[33]||(m[33]=[L(" 重置密码 ")]))),_:1,__:[33]}),N(o,{class:"pt-4"},{default:j((()=>{var e;return[P("p",null,[m[34]||(m[34]=L("您确定要为用户 ")),P("strong",null,$(null==(e=se.value)?void 0:e.name),1),m[35]||(m[35]=L(" 重置密码吗？"))]),N(f,{modelValue:le.value.password,"onUpdate:modelValue":m[9]||(m[9]=e=>le.value.password=e),label:"新密码",placeholder:"请输入新密码",type:"password",variant:"outlined",density:"comfortable",rules:[ue.required]},null,8,["modelValue","rules"]),N(f,{modelValue:le.value.confirmPassword,"onUpdate:modelValue":m[10]||(m[10]=e=>le.value.confirmPassword=e),label:"确认密码",placeholder:"请再次输入新密码",type:"password",variant:"outlined",density:"comfortable",rules:[ue.required,re]},null,8,["modelValue","rules"])]})),_:1}),N(g,null,{default:j((()=>[N(_),N(h,{color:"grey",variant:"text",onClick:m[11]||(m[11]=e=>ae.value=!1)},{default:j((()=>m[36]||(m[36]=[L(" 取消 ")]))),_:1,__:[36]}),N(h,{color:"warning",loading:S.value,onClick:ne},{default:j((()=>m[37]||(m[37]=[L(" 确认重置 ")]))),_:1,__:[37]},8,["loading"])])),_:1})])),_:1})])),_:1},8,["modelValue"]),N(x,{modelValue:K.value,"onUpdate:modelValue":m[18]||(m[18]=e=>K.value=e),location:"right",temporary:"",width:"300"},{default:j((()=>[N(u,{class:"h-100"},{default:j((()=>[N(r,{class:"bg-primary text-white"},{default:j((()=>[N(V,{class:"mr-2",color:"white"},{default:j((()=>m[38]||(m[38]=[L(" mdi-filter ")]))),_:1,__:[38]}),m[40]||(m[40]=L(" 筛选条件 ")),N(_),N(h,{icon:"",variant:"text",color:"white",size:"small",onClick:m[13]||(m[13]=e=>K.value=!1)},{default:j((()=>[N(V,null,{default:j((()=>m[39]||(m[39]=[L("mdi-close")]))),_:1,__:[39]})])),_:1})])),_:1,__:[40]}),N(o,{class:"pt-4"},{default:j((()=>[N(s,null,{default:j((()=>[N(f,{modelValue:J.value.name,"onUpdate:modelValue":m[14]||(m[14]=e=>J.value.name=e),label:"用户名",variant:"outlined",density:"comfortable",clearable:""},null,8,["modelValue"]),N(b,{modelValue:J.value.department_id,"onUpdate:modelValue":m[15]||(m[15]=e=>J.value.department_id=e),items:y.value,"item-title":"name","item-value":"id",label:"部门",variant:"outlined",density:"comfortable",clearable:""},null,8,["modelValue","items"]),N(f,{modelValue:J.value.role,"onUpdate:modelValue":m[16]||(m[16]=e=>J.value.role=e),label:"角色",variant:"outlined",density:"comfortable",clearable:""},null,8,["modelValue"]),N(b,{modelValue:J.value.is_active,"onUpdate:modelValue":m[17]||(m[17]=e=>J.value.is_active=e),items:[{title:"启用",value:!0},{title:"禁用",value:!1}],"item-title":"title","item-value":"value",label:"状态",variant:"outlined",density:"comfortable",clearable:""},null,8,["modelValue"])])),_:1})])),_:1}),N(g,{class:"py-3"},{default:j((()=>[N(_),N(h,{variant:"text",color:"grey",onClick:me},{default:j((()=>m[41]||(m[41]=[L(" 清除筛选 ")]))),_:1,__:[41]}),N(h,{color:"primary",onClick:ce},{default:j((()=>m[42]||(m[42]=[L(" 应用筛选 ")]))),_:1,__:[42]})])),_:1})])),_:1})])),_:1},8,["modelValue"]),N(T,{modelValue:te.value,"onUpdate:modelValue":m[19]||(m[19]=e=>te.value=e),user:se.value,onSave:ve,onClose:m[20]||(m[20]=e=>te.value=!1)},null,8,["modelValue","user"])]))}},[["__scopeId","data-v-568cca14"]]);export{J as default};
