import{_ as e,c as a,U as l,d as t,i,M as r,p as o}from"./entry-index.D92NaooR.js";import{h as s,K as n}from"./chunk-kpiUtils.CSbvtC9I.js";import{z as u,A as c,aa as d,j as v,k as m,f as p,o as _,Z as f,$ as y,m as g,l as h,V as k,e as w,g as b,T as x,h as V}from"./chunk-vue-core.CxEQweee.js";import{r as J,w as T,N as M,ae as C,ac as O,ad as E,K as N,H as U,u as D,a4 as S,ab as j,af as A,X as z}from"./chunk-vendors.D0_dqILu.js";import"./chunk-utils-vendor.DVew6AbD.js";import"./chunk-chart-core.HkgdsJMe.js";const P={class:"sticky-header-container"},I={class:"controls-bar"},L={class:"scrollable-table-container"},$={class:"font-weight-medium"},K={class:"text-center"},W={class:"text-center"},Y={class:"text-caption"},F={key:0,class:"d-flex align-center"},q={key:1,class:"text-center text-grey"},G=e({__name:"ProductionKpi",setup(e){const{month:G,year:R}=(()=>{const e=new Date,a=e.getMonth(),l=e.getFullYear();return 0===a?{month:12,year:l-1}:{month:a,year:l}})(),H=J(!1),X=J(!1),Z=J(G),B=J(R),Q=J(!1),ee=J(!1),ae=J(!1),le=J(!1),te=J([]),ie=J(!1),re=J(null),oe=Array.from({length:12},((e,a)=>({title:`${a+1}月`,value:a+1}))),se=Array.from({length:5},((e,a)=>({title:`${(new Date).getFullYear()-2+a}年`,value:(new Date).getFullYear()-2+a}))),ne=[{title:"描述",key:"description",align:"start",width:"250px"},{title:"区域",key:"area",align:"center",width:"100px"},{title:"实际值",key:"actual_value",align:"center",width:"120px"},{title:"目标值",key:"target_value",align:"center",width:"120px"},{title:"YTD",key:"ytd_value",align:"center",width:"120px"},{title:"原因分析",key:"remark",align:"center",width:"150px"}],ue=[{title:"描述",key:"description",align:"start",width:"300px"},{title:"区域",key:"area",align:"center",width:"100px"},{title:"目标值",key:"target_value",align:"center",width:"150px"}],ce=J([]),de=J([]),ve=(e,a)=>0===a?0:Math.round(e/a*100),me=e=>(e.actual_value||0)<(e.target_value||0),pe=()=>{ee.value=!0,Q.value=!0},_e=async()=>{H.value=!0;try{ce.value=(()=>{const e=[];let a=1;return[{description:"Spot Welding",areas:["TJM","TJC","汇总"]},{description:"Arc Welding",areas:["TJM","汇总"]},{description:"Other Process",areas:["TJM","TJC","汇总"]},{description:"Divisional Assembly Line Overall (New)",areas:["汇总"]},{description:"Divisional General Purpose Equipment Overall (New)",areas:["汇总"]},{description:"Division Overall OEE",areas:["汇总"]},{description:"Labour Efficiency",areas:["TJM","TJC","汇总"]},{description:"Divisional Theoretical Manpower Ratio (New)",areas:["TJM","TJC","汇总"]}].forEach((l=>{l.areas.forEach((t=>{e.push({id:a++,description:l.description,area:t,actual_value:0,target_value:0,ytd_value:0,remark:null,action_plan_content:null,expected_close_date:null,actual_close_date:null,root_cause_analysis:null})}))})),e})();const a=await i("/production/kpi/",{params:{month:Z.value,year:B.value}});if(a.data&&a.data.length>0)a.data.forEach((e=>{const a=ce.value.find((a=>a.area===e.area&&a.description===e.description));a&&(a.actual_value=e.actual_value||0,a.target_value=e.target_value||0,a.ytd_value=e.ytd_value||0,a.remark=e.remark||null,a.action_plan=e.action_plan||null,a.root_cause_analysis=e.root_cause_analysis||null)}));else try{const e=await i("/production/kpi/targets/",{params:{year:B.value}});e.data&&e.data.length>0&&e.data.forEach((e=>{const a=ce.value.find((a=>a.area===e.area&&a.description===e.description));a&&(a.target_value=e.target_value||0)}))}catch(e){}de.value=JSON.parse(JSON.stringify(ce.value)),ee.value=!1}catch(e){r.error(`获取数据失败: ${e.message||"未知错误"}`)}finally{H.value=!1}},fe=async()=>{X.value=!0;try{const e={month:Z.value,year:B.value,items:ce.value.map((e=>({area:e.area,description:e.description,actual_value:e.actual_value,ytd_value:e.ytd_value,remark:e.remark,action_plan:e.action_plan,root_cause_analysis:e.root_cause_analysis})))};await o("/production/kpi/",e);r.success("数据保存成功"),ee.value=!1,de.value=JSON.parse(JSON.stringify(ce.value))}catch(e){r.error(`保存失败: ${e.message||"未知错误"}`)}finally{X.value=!1}},ye=()=>{ce.value=JSON.parse(JSON.stringify(de.value)),ee.value=!1,Q.value=!1,r.info("数据已重置")};T([Z,B],(()=>{if(ee.value){if(!confirm("当前有未保存的数据，切换月份将丢失这些数据，是否继续？"))return;_e()}else _e()}));const ge=async()=>{try{const e=await i("/production/kpi/targets/",{params:{year:B.value}});if(e.data&&e.data.length>0)te.value=e.data;else{te.value=[];[{description:"Spot Welding",areas:["TJM","TJC","汇总"]},{description:"Arc Welding",areas:["TJM","汇总"]},{description:"Other Process",areas:["TJM","TJC","汇总"]},{description:"Divisional Assembly Line Overall (New)",areas:["汇总"]},{description:"Divisional General Purpose Equipment Overall (New)",areas:["汇总"]},{description:"Division Overall OEE",areas:["汇总"]},{description:"Labour Efficiency",areas:["TJM","TJC","汇总"]},{description:"Divisional Theoretical Manpower Ratio (New)",areas:["TJM","TJC","汇总"]}].forEach((e=>{e.areas.forEach((a=>{te.value.push({area:a,description:e.description,target_value:0})}))}))}ae.value=!0}catch(e){r.error("获取目标值失败")}},he=async()=>{le.value=!0;try{const e={year:B.value,items:te.value.map((e=>({area:e.area,description:e.description,target_value:e.target_value||0})))};await o("/production/kpi/targets/",e),r.success("目标值保存成功"),ae.value=!1,_e()}catch(e){r.error("保存目标值失败")}finally{le.value=!1}},ke=e=>s(e)?"查看/编辑":"填写分析",we=e=>{re.value&&(re.value.root_cause_analysis=e.root_cause_analysis,re.value.action_plan_content=e.action_plan_content,re.value.expected_close_date=e.expected_close_date,re.value.actual_close_date=e.actual_close_date,pe())};return M((()=>{_e()})),(e,i)=>(O(),C(t,{title:"生产KPI管理",icon:"mdi-factory",color:"primary"},{default:E((()=>[N("div",P,[N("div",I,[U(u,{class:"align-center"},{default:E((()=>[U(c,{cols:"12",md:"6"},{default:E((()=>[U(u,null,{default:E((()=>[U(c,{cols:"6",md:"4"},{default:E((()=>[U(d,{modelValue:Z.value,"onUpdate:modelValue":[i[0]||(i[0]=e=>Z.value=e),_e],items:D(oe),label:"选择月份",variant:"outlined",density:"compact","hide-details":"",class:"control-select"},null,8,["modelValue","items"])])),_:1}),U(c,{cols:"6",md:"4"},{default:E((()=>[U(d,{modelValue:B.value,"onUpdate:modelValue":[i[1]||(i[1]=e=>B.value=e),_e],items:D(se),label:"选择年份",variant:"outlined",density:"compact","hide-details":"",class:"control-select"},null,8,["modelValue","items"])])),_:1})])),_:1})])),_:1}),U(v),U(c,{cols:"auto"},{default:E((()=>[U(m,{color:"info","prepend-icon":"mdi-target",variant:"outlined",class:"mr-2 action-btn",onClick:ge},{default:E((()=>i[7]||(i[7]=[S(" 设置目标值 ")]))),_:1,__:[7]}),U(m,{color:"secondary",disabled:!ee.value,"prepend-icon":"mdi-refresh",variant:"outlined",class:"mr-2 action-btn",onClick:ye},{default:E((()=>i[8]||(i[8]=[S(" 重置 ")]))),_:1,__:[8]},8,["disabled"]),U(m,{color:"primary",loading:X.value,disabled:!ee.value,"prepend-icon":"mdi-content-save",variant:"elevated",class:"action-btn",onClick:fe},{default:E((()=>i[9]||(i[9]=[S(" 保存数据 ")]))),_:1,__:[9]},8,["loading","disabled"])])),_:1})])),_:1})])]),U(a,{loading:H.value,message:"加载数据中..."},null,8,["loading"]),N("div",L,[U(l,{headers:ne,items:ce.value,loading:H.value,density:"comfortable",class:"production-kpi-table production-data-table frozen-header-table","hide-default-footer":"","items-per-page":-1,hover:!1,"fixed-header":!0,height:"calc(100vh - 280px)"},{"item.description":E((({item:e})=>[N("div",$,z(e.description),1)])),"item.area":E((({item:e})=>{return[U(y,{color:(a=e.area,{TJM:"primary",TJC:"secondary","汇总":"success"}[a]||"default"),size:"small",variant:"flat"},{default:E((()=>[S(z(e.area),1)])),_:2},1032,["color"])];var a})),"item.actual_value":E((({item:e})=>[U(f,{modelValue:e.actual_value,"onUpdate:modelValue":a=>e.actual_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",class:"text-field-small",onInput:pe},null,8,["modelValue","onUpdate:modelValue"])])),"item.target_value":E((({item:e})=>[N("div",K,[U(y,{color:"info",size:"small",variant:"flat"},{default:E((()=>{return[S(z((a=e.target_value||0,0===a?"0":a.toLocaleString())),1)];var a})),_:2},1024)])])),"item.ytd_value":E((({item:e})=>[U(f,{modelValue:e.ytd_value,"onUpdate:modelValue":a=>e.ytd_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",class:"text-field-small",onInput:pe},null,8,["modelValue","onUpdate:modelValue"])])),"item.achievement_rate":E((({item:e})=>{return[N("div",W,[U(_,{"model-value":ve(e.actual_value||0,e.target_value||0),color:(a=ve(e.actual_value||0,e.target_value||0),a>=100?"success":a>=80?"warning":"error"),size:"40",width:"4"},{default:E((()=>[N("span",Y,z(ve(e.actual_value||0,e.target_value||0))+"% ",1)])),_:2},1032,["model-value","color"])])];var a})),"item.remark":E((({item:e})=>[me(e)?(O(),j("div",F,[U(m,{size:"small",variant:"outlined",color:"warning","prepend-icon":"mdi-clipboard-edit",onClick:a=>(e=>{re.value=e,ie.value=!0})(e)},{default:E((()=>[S(z(ke(e)),1)])),_:2},1032,["onClick"]),D(s)(e)?(O(),C(p,{key:0,color:"success",class:"ml-2"},{default:E((()=>i[10]||(i[10]=[S(" mdi-check-circle ")]))),_:1,__:[10]})):A("",!0)])):(O(),j("div",q," - "))])),_:1},8,["items","loading"])]),U(g,{modelValue:Q.value,"onUpdate:modelValue":i[3]||(i[3]=e=>Q.value=e),timeout:3e3,color:"warning",location:"bottom","multi-line":"",class:"change-alert"},{actions:E((()=>[U(m,{color:"white",variant:"text",onClick:i[2]||(i[2]=e=>Q.value=!1)},{default:E((()=>i[11]||(i[11]=[S(" 关闭 ")]))),_:1,__:[11]})])),default:E((()=>[i[12]||(i[12]=S(" 数据已修改，请记得保存 "))])),_:1,__:[12]},8,["modelValue"]),U(h,{modelValue:ae.value,"onUpdate:modelValue":i[5]||(i[5]=e=>ae.value=e),"max-width":"800px"},{default:E((()=>[U(k,null,{default:E((()=>[U(w,{class:"text-h5"},{default:E((()=>[S(" 设置 "+z(B.value)+" 年度目标值 ",1)])),_:1}),U(b,null,{default:E((()=>[U(x,{headers:ue,items:te.value,density:"compact","items-per-page":50,"hide-default-footer":"",class:"elevation-1"},{"item.target_value":E((({item:e})=>[U(f,{modelValue:e.target_value,"onUpdate:modelValue":a=>e.target_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",class:"text-field-small"},null,8,["modelValue","onUpdate:modelValue"])])),_:1},8,["items"])])),_:1}),U(V,null,{default:E((()=>[U(v),U(m,{color:"grey",variant:"text",onClick:i[4]||(i[4]=e=>ae.value=!1)},{default:E((()=>i[13]||(i[13]=[S(" 取消 ")]))),_:1,__:[13]}),U(m,{color:"primary",variant:"elevated",loading:le.value,onClick:he},{default:E((()=>i[14]||(i[14]=[S(" 保存目标值 ")]))),_:1,__:[14]},8,["loading"])])),_:1})])),_:1})])),_:1},8,["modelValue"]),U(n,{modelValue:ie.value,"onUpdate:modelValue":i[6]||(i[6]=e=>ie.value=e),item:re.value,title:"原因分析与行动计划",onSave:we},null,8,["modelValue","item"])])),_:1}))}},[["__scopeId","data-v-ebd5e7eb"]]);export{G as default};
