import{_ as e,c as a,U as t,d as l,i as r,M as i,p as u}from"./entry-index.D92NaooR.js";import{h as o,K as s}from"./chunk-kpiUtils.CSbvtC9I.js";import{z as n,A as c,aa as d,j as m,k as v,f as _,o as p,Z as f,$ as y,m as g,l as h,V as k,e as x,g as b,T as C,h as w}from"./chunk-vue-core.CxEQweee.js";import{r as V,w as S,N as D,ae as M,ac as T,ad as U,K as J,H as R,u as N,a4 as P,ab as j,af as q,X as z}from"./chunk-vendors.D0_dqILu.js";import"./chunk-utils-vendor.DVew6AbD.js";import"./chunk-chart-core.HkgdsJMe.js";const E={class:"sticky-header-container"},F={class:"controls-bar"},O={class:"scrollable-table-container"},Q={class:"font-weight-medium"},I={class:"text-center"},$={class:"text-center"},K={class:"text-caption"},W={key:0,class:"d-flex align-center"},Y={key:1,class:"text-center text-grey"},A=e({__name:"QualityKpi",setup(e){const{month:A,year:H}=(()=>{const e=new Date,a=e.getMonth(),t=e.getFullYear();return 0===a?{month:12,year:t-1}:{month:a,year:t}})(),L=V(!1),X=V(!1),Z=V(A),B=V(H),G=V(!1),ee=V(!1),ae=V(!1),te=V(!1),le=V([]),re=V(!1),ie=V(null),ue=Array.from({length:12},((e,a)=>({title:`${a+1}月`,value:a+1}))),oe=Array.from({length:5},((e,a)=>({title:`${(new Date).getFullYear()-2+a}年`,value:(new Date).getFullYear()-2+a}))),se=[{title:"描述",key:"description",align:"start",width:"250px"},{title:"区域",key:"area",align:"center",width:"100px"},{title:"实际值",key:"actual_value",align:"center",width:"120px"},{title:"目标值",key:"target_value",align:"center",width:"120px"},{title:"YTD",key:"ytd_value",align:"center",width:"120px"},{title:"原因分析",key:"remark",align:"center",width:"150px"}],ne=[{title:"描述",key:"description",align:"start",width:"300px"},{title:"区域",key:"area",align:"center",width:"100px"},{title:"目标值",key:"target_value",align:"center",width:"150px"}],ce=["Customer Defects","PPM","Supplier Defects","Cost of Quality(failure cost only)","Customer Chargebacks","Customer Chargebacks%","Customer Warranty","Customer Warranty%","Supplier RDR","Supplier RDR%","Cost of Scrap","Magna FTT - Quality Performance (New)"],de=["TJC","TJM","汇总"],me=V([]),ve=V([]),_e=(e,a)=>0===a?0:Math.round(e/a*100),pe=e=>{if("Supplier RDR"===e.description||"Supplier RDR%"===e.description)return!1;if("Magna FTT - Quality Performance (New)"===e.description)return(e.actual_value||0)<(e.target_value||0);return(e.actual_value||0)>(e.target_value||0)},fe=()=>{ee.value=!0,G.value=!0},ye=async()=>{L.value=!0;try{me.value=(()=>{const e=[];let a=1;return ce.forEach((t=>{de.forEach((l=>{e.push({id:a++,description:t,area:l,actual_value:0,target_value:0,ytd_value:0,remark:null,action_plan_content:null,expected_close_date:null,actual_close_date:null,root_cause_analysis:null})}))})),e})();const a=await r("/qa/kpi/",{params:{month:Z.value,year:B.value}});if(a.data&&a.data.length>0)a.data.forEach((e=>{const a=me.value.find((a=>a.area===e.area&&a.description===e.description));a&&(a.actual_value=e.actual_value||0,a.target_value=e.target_value||0,a.ytd_value=e.ytd_value||0,a.remark=e.remark||null,a.action_plan_content=e.action_plan_content||null,a.expected_close_date=e.expected_close_date||null,a.actual_close_date=e.actual_close_date||null,a.root_cause_analysis=e.root_cause_analysis||null)}));else try{const e=await r("/qa/kpi/targets/",{params:{year:B.value}});e.data&&e.data.length>0&&e.data.forEach((e=>{const a=me.value.find((a=>a.area===e.area&&a.description===e.description));a&&(a.target_value=e.target_value||0)}))}catch(e){}ve.value=JSON.parse(JSON.stringify(me.value)),ee.value=!1}catch(e){i.error(`获取数据失败: ${e.message||"未知错误"}`)}finally{L.value=!1}},ge=async()=>{X.value=!0;try{const e={month:Z.value,year:B.value,items:me.value.map((e=>({area:e.area,description:e.description,actual_value:e.actual_value,ytd_value:e.ytd_value,remark:e.remark,action_plan_content:e.action_plan_content,expected_close_date:e.expected_close_date,actual_close_date:e.actual_close_date,root_cause_analysis:e.root_cause_analysis})))};await u("/qa/kpi/",e),i.success("数据保存成功"),ee.value=!1,ve.value=JSON.parse(JSON.stringify(me.value))}catch(e){i.error(`保存失败: ${e.message||"未知错误"}`)}finally{X.value=!1}},he=()=>{me.value=JSON.parse(JSON.stringify(ve.value)),ee.value=!1,G.value=!1,i.info("数据已重置")};S([Z,B],(()=>{if(ee.value){if(!confirm("当前有未保存的数据，切换月份将丢失这些数据，是否继续？"))return;ye()}else ye()}));const ke=async()=>{try{const e=await r("/qa/kpi/targets/",{params:{year:B.value}});if(e.data&&e.data.length>0)le.value=e.data;else{le.value=[];const e=["TJC","TJM","汇总"];["Customer Defects","PPM","Supplier Defects","Cost of Quality(failure cost only)","Customer Chargebacks","Customer Chargebacks%","Customer Warranty","Customer Warranty%","Supplier RDR","Supplier RDR%","Cost of Scrap","Magna FTT - Quality Performance (New)"].forEach((a=>{e.forEach((e=>{le.value.push({area:e,description:a,target_value:0})}))}))}ae.value=!0}catch(e){i.error("获取目标值失败")}},xe=async()=>{te.value=!0;try{const e={year:B.value,items:le.value.map((e=>({area:e.area,description:e.description,target_value:e.target_value||0})))};await u("/qa/kpi/targets/",e),i.success("目标值保存成功"),ae.value=!1,ye()}catch(e){i.error("保存目标值失败")}finally{te.value=!1}},be=e=>o(e)?"查看/编辑":"填写分析",Ce=e=>{ie.value&&(ie.value.root_cause_analysis=e.root_cause_analysis,ie.value.action_plan_content=e.action_plan_content,ie.value.expected_close_date=e.expected_close_date,ie.value.actual_close_date=e.actual_close_date,fe())};return D((()=>{ye()})),(e,r)=>(T(),M(l,{title:"质量KPI数据管理",icon:"mdi-chart-line",color:"primary"},{default:U((()=>[J("div",E,[J("div",F,[R(n,{class:"align-center"},{default:U((()=>[R(c,{cols:"12",md:"6"},{default:U((()=>[R(n,null,{default:U((()=>[R(c,{cols:"6",md:"4"},{default:U((()=>[R(d,{modelValue:Z.value,"onUpdate:modelValue":[r[0]||(r[0]=e=>Z.value=e),ye],items:N(ue),label:"选择月份",variant:"outlined",density:"compact","hide-details":"",class:"control-select"},null,8,["modelValue","items"])])),_:1}),R(c,{cols:"6",md:"4"},{default:U((()=>[R(d,{modelValue:B.value,"onUpdate:modelValue":[r[1]||(r[1]=e=>B.value=e),ye],items:N(oe),label:"选择年份",variant:"outlined",density:"compact","hide-details":"",class:"control-select"},null,8,["modelValue","items"])])),_:1})])),_:1})])),_:1}),R(m),R(c,{cols:"auto"},{default:U((()=>[R(v,{color:"info","prepend-icon":"mdi-target",variant:"outlined",class:"mr-2 action-btn",onClick:ke},{default:U((()=>r[7]||(r[7]=[P(" 设置目标值 ")]))),_:1,__:[7]}),R(v,{color:"secondary",disabled:!ee.value,"prepend-icon":"mdi-refresh",variant:"outlined",class:"mr-2 action-btn",onClick:he},{default:U((()=>r[8]||(r[8]=[P(" 重置 ")]))),_:1,__:[8]},8,["disabled"]),R(v,{color:"primary",loading:X.value,disabled:!ee.value,"prepend-icon":"mdi-content-save",variant:"elevated",class:"action-btn",onClick:ge},{default:U((()=>r[9]||(r[9]=[P(" 保存数据 ")]))),_:1,__:[9]},8,["loading","disabled"])])),_:1})])),_:1})])]),R(a,{loading:L.value,message:"加载数据中..."},null,8,["loading"]),J("div",O,[R(t,{headers:se,items:me.value,loading:L.value,density:"comfortable",class:"quality-kpi-table kpi-data-table frozen-header-table",hover:!1,"hide-default-footer":"","items-per-page":-1,"fixed-header":!0,height:"calc(100vh - 280px)"},{"item.description":U((({item:e})=>[J("div",Q,z(e.description),1)])),"item.area":U((({item:e})=>{return[R(y,{color:(a=e.area,{TJC:"primary",TJM:"secondary","汇总":"success"}[a]||"default"),size:"small",variant:"flat"},{default:U((()=>[P(z(e.area),1)])),_:2},1032,["color"])];var a})),"item.actual_value":U((({item:e})=>[R(f,{modelValue:e.actual_value,"onUpdate:modelValue":a=>e.actual_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",class:"text-field-small",onInput:fe},null,8,["modelValue","onUpdate:modelValue"])])),"item.target_value":U((({item:e})=>[J("div",I,[R(y,{color:"info",size:"small",variant:"flat"},{default:U((()=>{return[P(z((a=e.target_value||0,0===a?"0":a.toLocaleString())),1)];var a})),_:2},1024)])])),"item.ytd_value":U((({item:e})=>[R(f,{modelValue:e.ytd_value,"onUpdate:modelValue":a=>e.ytd_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",class:"text-field-small",onInput:fe},null,8,["modelValue","onUpdate:modelValue"])])),"item.achievement_rate":U((({item:e})=>{return[J("div",$,[R(p,{"model-value":_e(e.actual_value||0,e.target_value||0),color:(a=_e(e.actual_value||0,e.target_value||0),a>=100?"success":a>=80?"warning":"error"),size:"40",width:"4"},{default:U((()=>[J("span",K,z(_e(e.actual_value||0,e.target_value||0))+"% ",1)])),_:2},1032,["model-value","color"])])];var a})),"item.remark":U((({item:e})=>[pe(e)?(T(),j("div",W,[R(v,{size:"small",variant:"outlined",color:"warning","prepend-icon":"mdi-clipboard-edit",onClick:a=>(e=>{ie.value=e,re.value=!0})(e)},{default:U((()=>[P(z(be(e)),1)])),_:2},1032,["onClick"]),N(o)(e)?(T(),M(_,{key:0,color:"success",class:"ml-2"},{default:U((()=>r[10]||(r[10]=[P(" mdi-check-circle ")]))),_:1,__:[10]})):q("",!0)])):(T(),j("div",Y," - "))])),_:1},8,["items","loading"])]),R(g,{modelValue:G.value,"onUpdate:modelValue":r[3]||(r[3]=e=>G.value=e),timeout:3e3,color:"warning",location:"bottom","multi-line":"",class:"change-alert"},{actions:U((()=>[R(v,{color:"white",variant:"text",onClick:r[2]||(r[2]=e=>G.value=!1)},{default:U((()=>r[11]||(r[11]=[P(" 关闭 ")]))),_:1,__:[11]})])),default:U((()=>[r[12]||(r[12]=P(" 数据已修改，请记得保存 "))])),_:1,__:[12]},8,["modelValue"]),R(h,{modelValue:ae.value,"onUpdate:modelValue":r[5]||(r[5]=e=>ae.value=e),"max-width":"800px"},{default:U((()=>[R(k,null,{default:U((()=>[R(x,{class:"text-h5"},{default:U((()=>[P(" 设置 "+z(B.value)+" 年度目标值 ",1)])),_:1}),R(b,null,{default:U((()=>[R(C,{headers:ne,items:le.value,density:"compact","items-per-page":50,"hide-default-footer":"",class:"elevation-1"},{"item.target_value":U((({item:e})=>[R(f,{modelValue:e.target_value,"onUpdate:modelValue":a=>e.target_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",class:"text-field-small"},null,8,["modelValue","onUpdate:modelValue"])])),_:1},8,["items"])])),_:1}),R(w,null,{default:U((()=>[R(m),R(v,{color:"grey",variant:"text",onClick:r[4]||(r[4]=e=>ae.value=!1)},{default:U((()=>r[13]||(r[13]=[P(" 取消 ")]))),_:1,__:[13]}),R(v,{color:"primary",variant:"elevated",loading:te.value,onClick:xe},{default:U((()=>r[14]||(r[14]=[P(" 保存目标值 ")]))),_:1,__:[14]},8,["loading"])])),_:1})])),_:1})])),_:1},8,["modelValue"]),R(s,{modelValue:re.value,"onUpdate:modelValue":r[6]||(r[6]=e=>re.value=e),item:ie.value,title:"原因分析与行动计划",onSave:Ce},null,8,["modelValue","item"])])),_:1}))}},[["__scopeId","data-v-51caf4ad"]]);export{A as default};
