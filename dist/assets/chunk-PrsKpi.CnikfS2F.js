import{_ as e,c as a,U as l,d as t,i,M as s,p as n}from"./entry-index.D92NaooR.js";import{h as r,K as o}from"./chunk-kpiUtils.CSbvtC9I.js";import{z as u,A as d,aa as c,j as v,k as m,f as _,$ as p,Z as y,m as f,l as g,V as h,e as k,g as x,T as V,h as b}from"./chunk-vue-core.CxEQweee.js";import{r as w,N as U,w as C,ae as S,ac as j,ad as E,K as I,H as z,u as K,a4 as M,ab as N,af as P,X as D}from"./chunk-vendors.D0_dqILu.js";import"./chunk-utils-vendor.DVew6AbD.js";import"./chunk-chart-core.HkgdsJMe.js";const J={class:"sticky-header-container"},O={class:"controls-bar"},Y={class:"scrollable-table-container"},A={class:"font-weight-medium"},F={class:"text-center"},$={key:0,class:"d-flex align-center"},R={key:1,class:"text-center text-grey"},T=e({__name:"PrsKpi",setup(e){const{month:T,year:H}=(()=>{const e=new Date,a=e.getMonth(),l=e.getFullYear();return 0===a?{month:12,year:l-1}:{month:a,year:l}})(),L=w(!1),X=w(!1),Z=w(T),q=w(H),B=w(!1),G=w(!1),Q=w(!1),W=w(!1),ee=w([]),ae=w(!1),le=w(null),te=Array.from({length:12},((e,a)=>({title:`${a+1}月`,value:a+1}))),ie=Array.from({length:5},((e,a)=>({title:`${(new Date).getFullYear()-2+a}年`,value:(new Date).getFullYear()-2+a}))),se=[{title:"描述",key:"description",align:"start",width:"280px"},{title:"区域",key:"area",align:"center",width:"100px"},{title:"实际值",key:"actual_value",align:"center",width:"120px"},{title:"目标值",key:"target_value",align:"center",width:"120px"},{title:"YTD",key:"ytd_value",align:"center",width:"120px"},{title:"原因分析",key:"remark",align:"center",width:"150px"}],ne=[{title:"描述",key:"description",align:"start",width:"280px"},{title:"区域",key:"area",align:"center",width:"120px"},{title:"目标值 (%)",key:"target_value",align:"center",width:"150px"}],re=w([]),oe=w([]),ue=e=>(e.actual_value||0)<(e.target_value||0),de=()=>{B.value=!0,G.value=!0},ce=async()=>{var e,a;L.value=!0;try{re.value=(()=>{const e=[];let a=1;return[{description:"hot forming",areas:["汇总"]},{description:"laser cutting",areas:["汇总"]}].forEach((l=>{l.areas.forEach((t=>{e.push({id:a++,description:l.description,area:t,actual_value:0,target_value:0,ytd_value:0,remark:null,action_plan_content:null,expected_close_date:null,actual_close_date:null,root_cause_analysis:null})}))})),e})();const e=await i("/prs/kpi/",{params:{month:Z.value,year:q.value}});if(e.data&&e.data.length>0)e.data.forEach((e=>{const a=re.value.find((a=>a.area===e.area&&a.description===e.description));a&&(a.actual_value=e.actual_value||0,a.target_value=e.target_value||0,a.ytd_value=e.ytd_value||0,a.remark=e.remark||null,a.action_plan_content=e.action_plan_content||null,a.expected_close_date=e.expected_close_date||null,a.actual_close_date=e.actual_close_date||null,a.root_cause_analysis=e.root_cause_analysis||null)}));else try{const e=await i("/prs/kpi/targets/",{params:{year:q.value}});e.data&&e.data.length>0&&e.data.forEach((e=>{const a=re.value.find((a=>a.area===e.area&&a.description===e.description));a&&(a.target_value=e.target_value||0)}))}catch(l){}oe.value=JSON.parse(JSON.stringify(re.value)),B.value=!1,G.value=!1}catch(l){s.error("加载数据失败: "+((null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.detail)||l.message))}finally{L.value=!1}},ve=async()=>{var e,a;X.value=!0;try{const e={month:Z.value,year:q.value,items:re.value.map((e=>({area:e.area,description:e.description,actual_value:e.actual_value,ytd_value:e.ytd_value,remark:e.remark,action_plan_content:e.action_plan_content,expected_close_date:e.expected_close_date,actual_close_date:e.actual_close_date,root_cause_analysis:e.root_cause_analysis})))};await n("/prs/kpi/",e),s.success("PRS冲压部门KPI数据保存成功"),B.value=!1,ce()}catch(l){s.error("保存数据失败: "+((null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.detail)||l.message))}finally{X.value=!1}},me=()=>{re.value=JSON.parse(JSON.stringify(oe.value)),B.value=!1,G.value=!1,s.info("数据已重置")},_e=async()=>{try{const e=await i("/prs/kpi/targets/",{params:{year:q.value}});if(e.data&&e.data.length>0)ee.value=e.data;else{ee.value=[];[{description:"hot forming",areas:["汇总"]},{description:"laser cutting",areas:["汇总"]}].forEach((e=>{e.areas.forEach((a=>{ee.value.push({area:a,description:e.description,target_value:0})}))}))}Q.value=!0}catch(e){s.error("获取目标值失败")}},pe=async()=>{W.value=!0;try{const e={year:q.value,items:ee.value.map((e=>({area:e.area,description:e.description,target_value:e.target_value||0})))};await n("/prs/kpi/targets/",e),s.success("目标值保存成功"),Q.value=!1,ce()}catch(e){s.error("保存目标值失败")}finally{W.value=!1}},ye=e=>r(e)?"查看/编辑":"填写分析",fe=e=>{le.value&&(le.value.root_cause_analysis=e.root_cause_analysis,le.value.action_plan_content=e.action_plan_content,le.value.expected_close_date=e.expected_close_date,le.value.actual_close_date=e.actual_close_date,de())};return U((()=>{ce()})),C(q,(()=>{ce()})),(e,i)=>(j(),S(t,{title:"PRS冲压部门KPI数据管理",icon:"mdi-hammer",color:"primary"},{default:E((()=>[I("div",J,[I("div",O,[z(u,{class:"align-center"},{default:E((()=>[z(d,{cols:"12",md:"6"},{default:E((()=>[z(u,null,{default:E((()=>[z(d,{cols:"6",md:"4"},{default:E((()=>[z(c,{modelValue:Z.value,"onUpdate:modelValue":[i[0]||(i[0]=e=>Z.value=e),ce],items:K(te),label:"选择月份",variant:"outlined",density:"compact","hide-details":"",class:"control-select"},null,8,["modelValue","items"])])),_:1}),z(d,{cols:"6",md:"4"},{default:E((()=>[z(c,{modelValue:q.value,"onUpdate:modelValue":[i[1]||(i[1]=e=>q.value=e),ce],items:K(ie),label:"选择年份",variant:"outlined",density:"compact","hide-details":"",class:"control-select"},null,8,["modelValue","items"])])),_:1})])),_:1})])),_:1}),z(v),z(d,{cols:"auto"},{default:E((()=>[z(m,{color:"info","prepend-icon":"mdi-target",variant:"outlined",class:"mr-2 action-btn",onClick:_e},{default:E((()=>i[7]||(i[7]=[M(" 设置目标值 ")]))),_:1,__:[7]}),z(m,{color:"secondary",disabled:!B.value,"prepend-icon":"mdi-refresh",variant:"outlined",class:"mr-2 action-btn",onClick:me},{default:E((()=>i[8]||(i[8]=[M(" 重置 ")]))),_:1,__:[8]},8,["disabled"]),z(m,{color:"primary",loading:X.value,disabled:!B.value,"prepend-icon":"mdi-content-save",variant:"elevated",class:"action-btn",onClick:ve},{default:E((()=>i[9]||(i[9]=[M(" 保存数据 ")]))),_:1,__:[9]},8,["loading","disabled"])])),_:1})])),_:1})])]),z(a,{loading:L.value,message:"加载数据中..."},null,8,["loading"]),I("div",Y,[z(l,{headers:se,items:re.value,loading:L.value,density:"comfortable",class:"prs-kpi-table kpi-data-table frozen-header-table",hover:"","fixed-header":!0,height:"calc(100vh - 280px)"},{"item.description":E((({item:e})=>[I("div",A,D(e.description),1)])),"item.area":E((({item:e})=>{return[z(p,{color:(a=e.area,{"汇总":"success"}[a]||"default"),size:"small",variant:"flat"},{default:E((()=>[M(D(e.area),1)])),_:2},1032,["color"])];var a})),"item.actual_value":E((({item:e})=>[z(y,{modelValue:e.actual_value,"onUpdate:modelValue":a=>e.actual_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",class:"text-field-small",onInput:de},null,8,["modelValue","onUpdate:modelValue"])])),"item.ytd_value":E((({item:e})=>[z(y,{modelValue:e.ytd_value,"onUpdate:modelValue":a=>e.ytd_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",class:"text-field-small",onInput:de},null,8,["modelValue","onUpdate:modelValue"])])),"item.target_value":E((({item:e})=>[I("div",F,[z(p,{color:e.target_value>0?"success":"grey",size:"small",variant:"flat"},{default:E((()=>{return[M(D((a=e.target_value,0===a?"0":a.toLocaleString()))+"% ",1)];var a})),_:2},1032,["color"])])])),"item.remark":E((({item:e})=>[ue(e)?(j(),N("div",$,[z(m,{size:"small",variant:"outlined",color:"warning","prepend-icon":"mdi-clipboard-edit",onClick:a=>(e=>{le.value=e,ae.value=!0})(e)},{default:E((()=>[M(D(ye(e)),1)])),_:2},1032,["onClick"]),K(r)(e)?(j(),S(_,{key:0,color:"success",class:"ml-2"},{default:E((()=>i[10]||(i[10]=[M(" mdi-check-circle ")]))),_:1,__:[10]})):P("",!0)])):(j(),N("div",R," - "))])),_:1},8,["items","loading"])]),z(f,{modelValue:G.value,"onUpdate:modelValue":i[3]||(i[3]=e=>G.value=e),timeout:3e3,color:"warning",location:"bottom","multi-line":"",class:"change-alert"},{actions:E((()=>[z(m,{color:"white",variant:"text",onClick:i[2]||(i[2]=e=>G.value=!1)},{default:E((()=>i[11]||(i[11]=[M(" 关闭 ")]))),_:1,__:[11]})])),default:E((()=>[i[12]||(i[12]=M(" 数据已修改，请记得保存 "))])),_:1,__:[12]},8,["modelValue"]),z(g,{modelValue:Q.value,"onUpdate:modelValue":i[5]||(i[5]=e=>Q.value=e),"max-width":"800px"},{default:E((()=>[z(h,null,{default:E((()=>[z(k,{class:"text-h5"},{default:E((()=>[M(" 设置 "+D(q.value)+" 年度目标值 ",1)])),_:1}),z(x,null,{default:E((()=>[z(V,{headers:ne,items:ee.value,density:"compact","items-per-page":50,"hide-default-footer":"",class:"elevation-1"},{"item.target_value":E((({item:e})=>[z(y,{modelValue:e.target_value,"onUpdate:modelValue":a=>e.target_value=a,modelModifiers:{number:!0},type:"number",min:"0",step:"0.01",variant:"outlined",density:"compact","hide-details":"",class:"text-field-small"},null,8,["modelValue","onUpdate:modelValue"])])),_:1},8,["items"])])),_:1}),z(b,null,{default:E((()=>[z(v),z(m,{color:"grey",variant:"text",onClick:i[4]||(i[4]=e=>Q.value=!1)},{default:E((()=>i[13]||(i[13]=[M(" 取消 ")]))),_:1,__:[13]}),z(m,{color:"primary",variant:"elevated",loading:W.value,onClick:pe},{default:E((()=>i[14]||(i[14]=[M(" 保存目标值 ")]))),_:1,__:[14]},8,["loading"])])),_:1})])),_:1})])),_:1},8,["modelValue"]),z(o,{modelValue:ae.value,"onUpdate:modelValue":i[6]||(i[6]=e=>ae.value=e),item:le.value,title:"原因分析与行动计划",onSave:fe},null,8,["modelValue","item"])])),_:1}))}},[["__scopeId","data-v-2e8bface"]]);export{T as default};
