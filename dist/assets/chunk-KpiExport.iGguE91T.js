import{_ as e,d as a,i as l,M as t}from"./entry-index.D92NaooR.js";import{r as s,d as i,N as n,ae as o,ac as c,ad as u,K as r,ab as d,af as v,H as m,a4 as p,X as f,F as y,ag as h,J as k,a9 as _,ah as g,al as w,am as x}from"./chunk-vendors.D0_dqILu.js";import{V as b,e as j,f as $,v as V,ac as U,ad as C,z as I,A as O,aa as K,$ as L,ag as P,g as S,h as R,j as z,k as D,T as E,w as A,q,r as M,a0 as N}from"./chunk-vue-core.CxEQweee.js";import"./chunk-utils-vendor.DVew6AbD.js";import"./chunk-chart-core.HkgdsJMe.js";const F={class:"export-controls-container"},H={class:"config-title-content"},J={class:"unified-config-section"},T={class:"config-group"},Y={class:"group-header"},B={class:"group-header-content"},G={class:"group-content"},Q={class:"year-indicator"},X={class:"config-group"},W={class:"group-header"},Z={class:"group-header-content"},ee={class:"group-content"},ae={class:"kpi-selection-controls"},le={class:"kpi-types-grid"},te={class:"kpi-type-name"},se={class:"config-group"},ie={class:"group-header"},ne={class:"group-header-content"},oe={class:"group-content"},ce={class:"format-options"},ue={class:"format-info"},re={class:"format-name"},de={class:"format-desc"},ve={class:"export-summary"},me={class:"summary-text"},pe={class:"summary-main"},fe={class:"summary-sub"},ye={class:"export-buttons"},he={key:0,class:"preview-container"},ke={key:1,class:"history-container mt-4"},_e=e({__name:"KpiExport",setup(e){const _e=s(!1),ge=s(!1),we=s("month"),xe=s((new Date).getFullYear()),be=s((new Date).getMonth()+1),je=i((()=>{const e=(new Date).getFullYear();return Array.from({length:5},((a,l)=>e-l))})),$e=[{title:"全年",value:"all"},{title:"1月",value:1},{title:"2月",value:2},{title:"3月",value:3},{title:"4月",value:4},{title:"5月",value:5},{title:"6月",value:6},{title:"7月",value:7},{title:"8月",value:8},{title:"9月",value:9},{title:"10月",value:10},{title:"11月",value:11},{title:"12月",value:12}],Ve=[{key:"production",name:"Assy",endpoint:"/production/kpi/",icon:"mdi-factory"},{key:"quality",name:"QA",endpoint:"/qa/kpi/",icon:"mdi-quality-high"},{key:"maintenance",name:"MAT",endpoint:"/maint/kpi/",icon:"mdi-wrench"},{key:"hr",name:"HR",endpoint:"/hr/kpi/",icon:"mdi-account-group"},{key:"ehs",name:"EHS",endpoint:"/ehs/kpi/",icon:"mdi-shield-check"},{key:"eng",name:"ENG",endpoint:"/eng/kpi/",icon:"mdi-cog"},{key:"logistics",name:"PC&L",endpoint:"/logistics/kpi/",icon:"mdi-truck"},{key:"prs",name:"PRS",endpoint:"/prs/kpi/",icon:"mdi-stamper"},{key:"gmo",name:"GMO",endpoint:"/gmo/kpi/",icon:"mdi-dna"}],Ue=s([]),Ce=s(!1),Ie=[{key:"excel",name:"Excel (.xlsx)",icon:"mdi-microsoft-excel"},{key:"csv",name:"CSV (.csv)",icon:"mdi-file-delimited"},{key:"json",name:"JSON (.json)",icon:"mdi-code-json"}],Oe=s("excel"),Ke=s([]),Le=[{title:"KPI类型",key:"kpi_type",width:"120px"},{title:"时间",key:"date",width:"100px"},{title:"区域",key:"area",width:"100px"},{title:"描述",key:"description",width:"200px"},{title:"实际值",key:"actual_value",width:"100px"},{title:"目标值",key:"target_value",width:"100px"},{title:"YTD",key:"ytd_value",width:"100px"}],Pe=s([]),Se=()=>{Ce.value?Ue.value=Ve.map((e=>e.key)):Ue.value=[]},Re=e=>({excel:"适合数据分析，支持多工作表",csv:"轻量级格式，易于导入其他系统",json:"结构化数据，适合程序处理"}[e]||""),ze=async()=>{_e.value=!0;const e=[];try{for(const s of Ue.value){const i=Ve.find((e=>e.key===s));if(i)try{if("year"===we.value){const a=await l(i.endpoint,{params:{year:xe.value}});if(a.data&&a.data.length>0){const l=a.data.map((e=>({kpi_type:i.name,area:e.area||"未指定",description:e.description||"未指定",ytd_value:e.ytd_value||0,actual_value:e.actual_value||0,target_value:e.target_value||0,month:e.month,year:xe.value})));e.push(...l)}}else{const a=await l(i.endpoint,{params:{month:be.value,year:xe.value}});if(a.data&&a.data.length>0){const l=a.data.map((e=>({kpi_type:i.name,area:e.area||"未指定",description:e.description||"未指定",ytd_value:e.ytd_value||0,actual_value:e.actual_value||0,target_value:e.target_value||0,month:be.value,year:xe.value})));e.push(...l)}}}catch(a){t.warning(`获取${i.name}数据失败`)}}return Ke.value=e,e}catch(a){return t.error("获取KPI数据失败"),[]}finally{_e.value=!1}},De=async()=>{if(0!==Ue.value.length){ge.value=!0;try{const e=await ze();if(0===e.length)return void t.warning("没有可导出的数据");const a=(new Date).toISOString().slice(0,19).replace(/:/g,"-"),l=Ue.value.map((e=>{var a;return null==(a=Ve.find((a=>a.key===e)))?void 0:a.name})).join("-"),s=`KPI数据导出_${l}_${"year"===we.value?`${xe.value}年全年`:`${xe.value}年${be.value}月`}_${a}`;switch(Oe.value){case"excel":await Ee(e,s);break;case"csv":await Ae(e,s);break;case"json":await qe(e,s)}Pe.value.unshift({filename:`${s}.${Oe.value}`,date:(new Date).toLocaleString(),types:Ue.value.map((e=>{var a;return null==(a=Ve.find((a=>a.key===e)))?void 0:a.name})),format:Oe.value,status:"success",data:e}),t.success(`成功导出 ${e.length} 条KPI数据`)}catch(e){t.error("导出失败: "+e.message),Pe.value.unshift({filename:"导出失败",date:(new Date).toLocaleString(),types:Ue.value.map((e=>{var a;return null==(a=Ve.find((a=>a.key===e)))?void 0:a.name})),format:Oe.value,status:"error"})}finally{ge.value=!1}}else t.warning("请至少选择一种KPI类型")},Ee=async(e,a)=>{const l=w.book_new(),t={};e.forEach((e=>{t[e.kpi_type]||(t[e.kpi_type]=[]),t[e.kpi_type].push(e)})),Object.keys(t).forEach((e=>{const a=t[e],s=w.json_to_sheet(a);s["!cols"]=[{width:15},{width:12},{width:10},{width:25},{width:12},{width:12},{width:12},{width:10}],w.book_append_sheet(l,s,e)})),x(l,`${a}.xlsx`)},Ae=(e,a)=>{const l=[["KPI类型","时间","区域","指标名称","实际值","目标值","达成率(%)"].join(","),...e.map((e=>[`"${e.kpi_type}"`,`"${e.date}"`,`"${e.area}"`,`"${e.description}"`,e.actual_value,e.target_value].join(",")))].join("\n"),t=new Blob(["\ufeff"+l],{type:"text/csv;charset=utf-8"}),s=document.createElement("a");s.href=URL.createObjectURL(t),s.download=`${a}.csv`,s.click(),URL.revokeObjectURL(s.href)},qe=(e,a)=>{const l=JSON.stringify({export_info:{timestamp:(new Date).toISOString(),year:xe.value,month:be.value,kpi_types:Ue.value,total_records:e.length},data:e},null,2),t=new Blob([l],{type:"application/json"}),s=document.createElement("a");s.href=URL.createObjectURL(t),s.download=`${a}.json`,s.click(),URL.revokeObjectURL(s.href)};return n((()=>{ze()})),(e,l)=>{const t=a;return c(),o(t,{title:"KPI数据导出",icon:"mdi-export",color:"success"},{default:u((()=>[r("div",F,[m(b,{class:"export-config-card elevation-2"},{default:u((()=>[m(j,{class:"export-config-header"},{default:u((()=>[r("div",H,[m($,{class:"config-icon"},{default:u((()=>l[9]||(l[9]=[p(" mdi-cog ")]))),_:1,__:[9]}),l[10]||(l[10]=r("span",{class:"config-title-text"},"导出配置",-1))])])),_:1}),r("div",J,[r("div",T,[r("div",Y,[r("div",B,[m($,{class:"group-icon"},{default:u((()=>l[11]||(l[11]=[p(" mdi-calendar-range ")]))),_:1,__:[11]}),l[12]||(l[12]=r("span",{class:"group-title"},"时间范围",-1))]),m(V,{class:"group-divider"})]),r("div",G,[m(U,{modelValue:we.value,"onUpdate:modelValue":l[0]||(l[0]=e=>we.value=e),density:"compact",class:"time-mode-group"},{default:u((()=>[m(C,{label:"按月导出",value:"month",color:"primary"}),m(C,{label:"全年导出",value:"year",color:"primary"})])),_:1},8,["modelValue"]),m(I,{class:"time-selectors"},{default:u((()=>[m(O,{cols:"6"},{default:u((()=>[m(K,{modelValue:xe.value,"onUpdate:modelValue":l[1]||(l[1]=e=>xe.value=e),items:je.value,label:"年份",variant:"outlined",density:"compact","hide-details":"",class:"time-select"},null,8,["modelValue","items"])])),_:1}),"month"===we.value?(c(),o(O,{key:0,cols:"6"},{default:u((()=>[m(K,{modelValue:be.value,"onUpdate:modelValue":l[2]||(l[2]=e=>be.value=e),items:$e,label:"月份",variant:"outlined",density:"compact","hide-details":"",class:"time-select"},null,8,["modelValue"])])),_:1})):(c(),o(O,{key:1,cols:"6"},{default:u((()=>[r("div",Q,[m(L,{color:"success",variant:"elevated",class:"full-year-chip"},{default:u((()=>[m($,{start:""},{default:u((()=>l[13]||(l[13]=[p(" mdi-calendar-check ")]))),_:1,__:[13]}),l[14]||(l[14]=p(" 全年数据 (1-12月) "))])),_:1,__:[14]})])])),_:1}))])),_:1})])]),r("div",X,[r("div",W,[r("div",Z,[m($,{class:"group-icon"},{default:u((()=>l[15]||(l[15]=[p(" mdi-chart-line ")]))),_:1,__:[15]}),l[16]||(l[16]=r("span",{class:"group-title"},"KPI类型选择",-1))]),m(L,{color:Ue.value.length>0?"success":"default",variant:"outlined",size:"small"},{default:u((()=>[p(" 已选择 "+f(Ue.value.length)+"/"+f(Ve.length),1)])),_:1},8,["color"]),m(V,{class:"group-divider"})]),r("div",ee,[r("div",ae,[m(P,{modelValue:Ce.value,"onUpdate:modelValue":[l[3]||(l[3]=e=>Ce.value=e),Se],label:"全选",color:"primary",class:"select-all-checkbox"},null,8,["modelValue"])]),r("div",le,[(c(),d(y,null,h(Ve,(e=>m(b,{key:e.key,class:k(["kpi-type-item",{selected:Ue.value.includes(e.key)}]),variant:"outlined",onClick:a=>(e=>{const a=Ue.value.indexOf(e);a>-1?Ue.value.splice(a,1):Ue.value.push(e),Ce.value=Ue.value.length===Ve.length})(e.key)},{default:u((()=>[m(S,{class:"kpi-type-content"},{default:u((()=>[m($,{icon:e.icon,class:"kpi-type-icon",size:"20"},null,8,["icon"]),r("span",te,f(e.name),1),m(P,{modelValue:Ue.value,"onUpdate:modelValue":l[4]||(l[4]=e=>Ue.value=e),value:e.key,color:"primary",density:"compact",class:"kpi-type-checkbox",onClick:l[5]||(l[5]=_((()=>{}),["stop"]))},null,8,["modelValue","value"])])),_:2},1024)])),_:2},1032,["class","onClick"]))),64))])])]),r("div",se,[r("div",ie,[r("div",ne,[m($,{class:"group-icon"},{default:u((()=>l[17]||(l[17]=[p(" mdi-file-export ")]))),_:1,__:[17]}),l[18]||(l[18]=r("span",{class:"group-title"},"导出格式",-1))]),m(L,{color:"info",variant:"outlined",size:"small"},{default:u((()=>{var e;return[p(f((null==(e=Ie.find((e=>e.key===Oe.value)))?void 0:e.name)||"未选择"),1)]})),_:1}),m(V,{class:"group-divider"})]),r("div",oe,[r("div",ce,[(c(),d(y,null,h(Ie,(e=>m(b,{key:e.key,class:k(["format-option",{selected:Oe.value===e.key}]),variant:"outlined",onClick:a=>Oe.value=e.key},{default:u((()=>[m(S,{class:"format-content"},{default:u((()=>[m($,{icon:e.icon,class:"format-icon",size:"24"},null,8,["icon"]),r("div",ue,[r("div",re,f(e.name),1),r("div",de,f(Re(e.key)),1)]),m(C,{modelValue:Oe.value,"onUpdate:modelValue":l[6]||(l[6]=e=>Oe.value=e),value:e.key,color:"primary",class:"format-radio",onClick:l[7]||(l[7]=_((()=>{}),["stop"]))},null,8,["modelValue","value"])])),_:2},1024)])),_:2},1032,["class","onClick"]))),64))])])])]),m(R,{class:"export-actions"},{default:u((()=>{var e;return[r("div",ve,[m($,{class:"summary-icon"},{default:u((()=>l[19]||(l[19]=[p(" mdi-information ")]))),_:1,__:[19]}),r("div",me,[r("div",pe," 准备导出 "+f(Ue.value.length)+" 种KPI类型 ",1),r("div",fe,f("year"===we.value?`${xe.value}年全年`:`${xe.value}年${be.value}月`)+" • "+f(null==(e=Ie.find((e=>e.key===Oe.value)))?void 0:e.name),1)])]),m(z),r("div",ye,[Ke.value.length>0?(c(),o(D,{key:0,color:"default",variant:"outlined","prepend-icon":"mdi-refresh",class:"mr-3",onClick:l[8]||(l[8]=e=>Ke.value.length=0)},{default:u((()=>l[20]||(l[20]=[p(" 重置预览 ")]))),_:1,__:[20]})):v("",!0),m(D,{loading:ge.value,disabled:0===Ue.value.length,color:"success",size:"large","prepend-icon":"mdi-download",variant:"elevated",class:"export-btn",onClick:De},{default:u((()=>[ge.value?(c(),d(y,{key:0},[p(" 正在导出... ")],64)):(c(),d(y,{key:1},[p(f(Ke.value.length>0?"确认导出":"一键导出"),1)],64))])),_:1},8,["loading","disabled"])])]})),_:1})])),_:1})]),Ke.value.length>0?(c(),d("div",he,[m(b,{class:"pa-4"},{default:u((()=>[m(j,{class:"text-h6 mb-4"},{default:u((()=>[m($,{class:"mr-2"},{default:u((()=>l[21]||(l[21]=[p(" mdi-eye ")]))),_:1,__:[21]}),p(" 数据预览 ("+f(Ke.value.length)+" 条记录) ",1)])),_:1}),m(E,{headers:Le,items:Ke.value,loading:_e.value,density:"compact","items-per-page":-1,class:"preview-table"},{"item.achievement_rate":u((({item:e})=>{return[m(L,{color:(a=e.achievement_rate,a>=100?"success":a>=80?"warning":"error"),size:"small",variant:"flat"},{default:u((()=>[p(f(e.achievement_rate)+"% ",1)])),_:2},1032,["color"])];var a})),_:1},8,["items","loading"])])),_:1})])):v("",!0),Pe.value.length>0?(c(),d("div",ke,[m(b,{class:"pa-4"},{default:u((()=>[m(j,{class:"text-h6 mb-4"},{default:u((()=>[m($,{class:"mr-2"},{default:u((()=>l[22]||(l[22]=[p(" mdi-history ")]))),_:1,__:[22]}),l[23]||(l[23]=p(" 导出历史 "))])),_:1,__:[23]}),m(A,null,{default:u((()=>[(c(!0),d(y,null,h(Pe.value,((e,a)=>(c(),o(q,{key:a,class:"mb-2"},g({prepend:u((()=>[m($,{color:"success"===e.status?"success":"error"},{default:u((()=>[p(f("success"===e.status?"mdi-check-circle":"mdi-alert-circle"),1)])),_:2},1032,["color"])])),default:u((()=>[m(M,null,{default:u((()=>[p(f(e.filename),1)])),_:2},1024),m(N,null,{default:u((()=>[p(f(e.date)+" - "+f(e.types.join(", "))+" - "+f(e.format.toUpperCase()),1)])),_:2},1024)])),_:2},["success"===e.status?{name:"append",fn:u((()=>[m(D,{icon:"mdi-download",size:"small",variant:"text",onClick:a=>(e=>{if(e.data){const a=e.filename.substring(0,e.filename.lastIndexOf("."));switch(e.format){case"excel":Ee(e.data,a);break;case"csv":Ae(e.data,a);break;case"json":qe(e.data,a)}}})(e)},null,8,["onClick"])])),key:"0"}:void 0]),1024)))),128))])),_:1})])),_:1})])):v("",!0)])),_:1})}}},[["__scopeId","data-v-dcb0130b"]]);export{_e as default};
