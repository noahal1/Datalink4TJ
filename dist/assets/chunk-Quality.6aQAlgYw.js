import{_ as e,u as a,e as l,c as t,U as r,d as s,b as n,M as u}from"./entry-index.D92NaooR.js";import{z as i,A as o,V as c,e as d,f as v,j as p,k as m,g,Z as f,a9 as y}from"./chunk-vue-core.CxEQweee.js";import{r as h,d as _,N as w,ae as S,ac as k,ad as b,K as V,H as x,af as j,ab as A,F as I,ag as O,a4 as $,J as N,X as U}from"./chunk-vendors.D0_dqILu.js";import"./chunk-utils-vendor.DVew6AbD.js";import"./chunk-chart-core.HkgdsJMe.js";const D={class:"stats-row mb-4"},C={class:"stats-row mb-4"},E={class:"d-flex align-center fixed-header"},J={class:"month-selector-container"},F={class:"table-container"},q={class:"text-center font-weight-medium",style:{"min-width":"60px"}},M={class:"text-center",style:{"min-width":"80px"}},P={class:"text-center",style:{"min-width":"80px"}},Y=e({__name:"Quality",setup(e){a();const Y=(new Date).getFullYear(),z=h(((new Date).getMonth()+1).toString()),Q=h([]),G=h([]),L=["swi","rwh","w01","hf","lc"],B=["scrapswi","scraprwh","scrapw01","scraphf","scraplc"],H=h(!1);h("");const K=h("regular"),X=h(!1),Z=[{title:"日期",key:"date",align:"center",width:"100"},{title:"焊接",key:"welding",align:"center",width:"100"},{title:"冲压",key:"stamping",align:"center",width:"100"},...L.map((e=>({title:e.toUpperCase(),key:e,align:"center",width:"130"})))],R=[{title:"日期",key:"date",align:"center",width:"100"},{title:"焊接",key:"welding",align:"center",width:"100"},{title:"冲压",key:"stamping",align:"center",width:"100"},...B.map((e=>({title:`报废 ${e.replace("scrap","").toUpperCase()}`,key:e,align:"center",width:"130"})))],T=_((()=>"regular"===K.value?Z:R)),W=h(z.value),ee=e=>{const a=new Date(Y,parseInt(W.value)-1,parseInt(e)).getDay();return 0===a||6===a},ae=e=>{e.welding=e.swi+e.rwh+e.w01,e.stamping=e.hf+e.lc},le=h({swi:0,rwh:0,w01:0,hf:0,lc:0}),te=h({...le.value}),re=h(!1),se=h(!1),ne=()=>{Object.keys(le.value).forEach((e=>{le.value[e]=parseInt(le.value[e])||0})),re.value=!Object.keys(le.value).every((e=>le.value[e]===te.value[e]))},ue=async()=>{var e,a;try{const e={month:W.value,year:Y.toString()};!e.month||isNaN(parseInt(e.month));const a=(await n.get("/qa/monthly",e)).data||[];L.forEach((e=>{le.value[e]=0})),a.forEach((e=>{const a=e.line.toLowerCase();le.value[a]=e.amount&&parseInt(e.amount)||0})),te.value={...le.value},re.value=!1}catch(l){const t=(null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.detail)||l.message||"未知错误";u.error("获取月度生产总数失败: "+t)}},ie=async()=>{var e,a;try{se.value=!0;const e=Object.keys(le.value).map((e=>({line:e,month:W.value,year:Y.toString(),amount:le.value[e].toString()}))),a=await n.put("/qa/monthly",e);a&&a.data?"Monthly amounts updated successfully"===a.data.message||"success"===a.data.message?(u.success("月度总数保存成功"),te.value={...le.value},re.value=!1):u.error("保存失败: "+(a.data.message||a.data.detail||"未知错误")):!a||"Monthly amounts updated successfully"!==a.message&&"success"!==a.message?u.error("保存失败: 服务器响应格式不正确"):(u.success("月度总数保存成功"),te.value={...le.value},re.value=!1)}catch(l){const t=(null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.detail)||l.message||"未知错误";u.error("保存失败: "+t)}finally{se.value=!1}},oe=async()=>{if(X.value||re.value){if(!window.confirm("您有未保存的更改。继续切换月份将丢失这些更改。确定继续吗？"))return void(W.value=z.value)}z.value=W.value,await Promise.all([de(),ue()])},ce=async()=>{await Promise.all([de(W.value),ue()]),u.info("数据已刷新")},de=async(e=W.value)=>{var a,l;H.value=!0;try{e&&!isNaN(parseInt(e))||(e=(new Date).getMonth()+1);const a={month:e.toString()},l=(await n.get("/qa/",a)).data||[],t=new Date(Y,parseInt(e),0).getDate(),r=Array.from({length:t},((e,a)=>({date:(a+1).toString().padStart(2,"0"),swi:0,rwh:0,w01:0,hf:0,lc:0,scrapswi:0,scraprwh:0,scrapw01:0,scraphf:0,scraplc:0,welding:0,stamping:0})));l.forEach((e=>{const a=r.find((a=>parseInt(a.date)===parseInt(e.day)));if(a){const l=e.line.toLowerCase();a[e.scrapflag?`scrap${l}`:l]=parseInt(e.value,10),a.welding=a.swi+a.rwh+a.w01,a.stamping=a.hf+a.lc}})),Q.value=r,G.value=JSON.parse(JSON.stringify(r)),X.value=!1}catch(t){const e=(null==(l=null==(a=t.response)?void 0:a.data)?void 0:l.detail)||t.message||"未知错误";u.error("获取质量数据失败: "+e)}finally{H.value=!1}},ve=async()=>{var e,a;try{H.value=!0;const e=[],a=[];if(Q.value.forEach(((l,t)=>{const r=G.value[t],s=[];L.forEach((e=>{l[e]!==r[e]&&(s.push({field:e,oldValue:r[e],newValue:l[e],isScrap:!1}),a.push({line:String(e),day:String(l.date),month:String(W.value),year:String((new Date).getFullYear()),value:String(l[e]||0),scrapflag:!1}))})),B.forEach((e=>{if(l[e]!==r[e]){const t=e.replace("scrap","");s.push({field:t,oldValue:r[e],newValue:l[e],isScrap:!0}),a.push({line:String(t),day:String(l.date),month:String(W.value),year:String((new Date).getFullYear()),value:String(l[e]||0),scrapflag:!0})}})),s.length>0&&e.push({day:l.date,month:W.value,changes:s})})),0===e.length)return void u.info("没有数据变更");if(!Array.isArray(a))return void u.error("数据格式错误：不是数组格式");const l=(e=>{const a=[];return Array.isArray(e)?e.forEach(((e,l)=>{const t=["line","day","month","year","value","scrapflag"].filter((a=>!(a in e)));t.length>0&&a.push(`第${l+1}个元素缺少字段: ${t.join(", ")}`),"string"!=typeof e.line&&a.push(`第${l+1}个元素的line字段应为字符串`),"string"!=typeof e.day&&a.push(`第${l+1}个元素的day字段应为字符串`),"string"!=typeof e.month&&a.push(`第${l+1}个元素的month字段应为字符串`),"string"!=typeof e.year&&a.push(`第${l+1}个元素的year字段应为字符串`),"string"!=typeof e.value&&a.push(`第${l+1}个元素的value字段应为字符串`),"boolean"!=typeof e.scrapflag&&a.push(`第${l+1}个元素的scrapflag字段应为布尔值`)})):a.push("数据不是数组类型，当前类型: "+typeof e),0===a.length||a.forEach((e=>{})),a})(a);if(l.length>0)return void u.error("数据格式错误: "+l.join(", "));const t=(e=>{let a=e;if(!Array.isArray(e)){if("object"!=typeof e||null===e)return[];if(!Object.keys(e).every((e=>/^\d+$/.test(e))))return[];a=Object.values(e)}if(!Array.isArray(a))return[];const l=a.map((e=>({line:String(e.line||""),day:String(e.day||""),month:String(e.month||""),year:String(e.year||(new Date).getFullYear()),value:String(e.value||"0"),scrapflag:Boolean(e.scrapflag)})));return Array.from(l)})(a);if(!Array.isArray(t))return void u.error("数据格式化失败");const r=JSON.parse(JSON.stringify(t)),s=await n.put("/qa",r);s&&s.data?"QA entries updated successfully"===s.data.message?(u.success("数据保存成功"),G.value=JSON.parse(JSON.stringify(Q.value)),X.value=!1):u.error("保存失败: "+(s.data.message||s.data.detail||"未知错误")):s&&"QA entries updated successfully"===s.message?(u.success("数据保存成功"),G.value=JSON.parse(JSON.stringify(Q.value)),X.value=!1):u.error("保存失败: 服务器响应格式不正确")}catch(l){const t=(null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.detail)||l.message||"未知错误";u.error("保存失败: "+t)}finally{H.value=!1}};_((()=>Q.value.reduce(((e,a)=>e+a.welding+a.stamping),0)));const pe=_((()=>Q.value.reduce(((e,a)=>e+a.scrapswi+a.scraprwh+a.scrapw01+a.scraphf+a.scraplc),0))),me=_((()=>{const e=Object.values(le.value).reduce(((e,a)=>e+a),0);if(0===e)return"0.00%";return(pe.value/e*100).toFixed(2)+"%"})),ge=e=>{const a=Q.value.reduce(((a,l)=>a+l[`scrap${e}`]),0),l=le.value[e];return 0===l?0:a/l*100},fe=e=>ge(e).toFixed(2)+"%";return w((async()=>{await Promise.all([de(W.value),ue()])})),(e,a)=>{const n=l,u=t,h=r,_=s;return k(),S(_,{title:"GP12数据管理",icon:"mdi-checkbox-multiple-marked-circle-outline",color:"primary"},{default:b((()=>[V("div",D,[x(i,null,{default:b((()=>[(k(),A(I,null,O(L,(e=>x(o,{key:e,cols:"12",sm:"6",md:"4",lg:"2"},{default:b((()=>{return[x(n,{title:e.toUpperCase()+" 报废率",value:fe(e),icon:"mdi-percent",color:(a=ge(e),a<1?"success":a<3?"info":a<5?"warning":"error"),"show-progress":""},null,8,["title","value","color"])];var a})),_:2},1024))),64)),x(o,{cols:"12",sm:"6",md:"4",lg:"2"},{default:b((()=>[x(n,{title:"总报废率",value:me.value,icon:"mdi-percent",color:"warning","show-progress":""},null,8,["value"])])),_:1})])),_:1})]),V("div",C,[x(o,{cols:"12"},{default:b((()=>[x(c,{class:"mb-4",rounded:"lg"},{default:b((()=>[x(d,{class:"d-flex align-center"},{default:b((()=>[x(v,{color:"primary",class:"mr-2"},{default:b((()=>a[2]||(a[2]=[$(" mdi-calendar-month ")]))),_:1,__:[2]}),a[5]||(a[5]=V("span",null,"月度生产总数",-1)),x(p),re.value?(k(),S(m,{key:0,color:"primary",variant:"text",loading:se.value,size:"small",onClick:ie},{default:b((()=>[x(v,{class:"mr-1"},{default:b((()=>a[3]||(a[3]=[$(" mdi-content-save ")]))),_:1,__:[3]}),a[4]||(a[4]=$(" 保存总数 "))])),_:1,__:[4]},8,["loading"])):j("",!0)])),_:1,__:[5]}),x(g,null,{default:b((()=>[x(i,null,{default:b((()=>[(k(),A(I,null,O(L,(e=>x(o,{key:e,cols:"12",sm:"6",md:"4",lg:"2.4"},{default:b((()=>[x(f,{modelValue:le.value[e],"onUpdate:modelValue":a=>le.value[e]=a,label:e.toUpperCase()+" 月度总数",type:"number",density:"compact",variant:"outlined","hide-details":"",class:"monthly-total-input",onInput:ne},null,8,["modelValue","onUpdate:modelValue","label"])])),_:2},1024))),64))])),_:1})])),_:1})])),_:1})])),_:1})]),V("div",E,[V("div",J,[x(y,{modelValue:W.value,"onUpdate:modelValue":[a[0]||(a[0]=e=>W.value=e),oe],mandatory:"",color:"primary",class:"month-selector mr-4",density:"comfortable",rounded:"lg"},{default:b((()=>[x(m,{value:"1"},{default:b((()=>a[6]||(a[6]=[$(" 一月 ")]))),_:1,__:[6]}),x(m,{value:"2"},{default:b((()=>a[7]||(a[7]=[$(" 二月 ")]))),_:1,__:[7]}),x(m,{value:"3"},{default:b((()=>a[8]||(a[8]=[$(" 三月 ")]))),_:1,__:[8]}),x(m,{value:"4"},{default:b((()=>a[9]||(a[9]=[$(" 四月 ")]))),_:1,__:[9]}),x(m,{value:"5"},{default:b((()=>a[10]||(a[10]=[$(" 五月 ")]))),_:1,__:[10]}),x(m,{value:"6"},{default:b((()=>a[11]||(a[11]=[$(" 六月 ")]))),_:1,__:[11]}),x(m,{value:"7"},{default:b((()=>a[12]||(a[12]=[$(" 七月 ")]))),_:1,__:[12]}),x(m,{value:"8"},{default:b((()=>a[13]||(a[13]=[$(" 八月 ")]))),_:1,__:[13]}),x(m,{value:"9"},{default:b((()=>a[14]||(a[14]=[$(" 九月 ")]))),_:1,__:[14]}),x(m,{value:"10"},{default:b((()=>a[15]||(a[15]=[$(" 十月 ")]))),_:1,__:[15]}),x(m,{value:"11"},{default:b((()=>a[16]||(a[16]=[$(" 十一月 ")]))),_:1,__:[16]}),x(m,{value:"12"},{default:b((()=>a[17]||(a[17]=[$(" 十二月 ")]))),_:1,__:[17]})])),_:1},8,["modelValue"])]),x(p),x(y,{modelValue:K.value,"onUpdate:modelValue":a[1]||(a[1]=e=>K.value=e),density:"comfortable",color:"primary"},{default:b((()=>[x(m,{value:"regular","prepend-icon":"mdi-table"},{default:b((()=>a[18]||(a[18]=[$(" GP12 ")]))),_:1,__:[18]}),x(m,{value:"scrap","prepend-icon":"mdi-delete"},{default:b((()=>a[19]||(a[19]=[$(" 报废数 ")]))),_:1,__:[19]})])),_:1},8,["modelValue"]),x(m,{"prepend-icon":"mdi-refresh",variant:"text",class:"ml-2",loading:H.value,onClick:ce},{default:b((()=>a[20]||(a[20]=[$(" 刷新 ")]))),_:1,__:[20]},8,["loading"])]),x(u,{loading:H.value,message:"加载数据中..."},null,8,["loading"]),V("div",F,[x(h,{headers:T.value,items:Q.value,loading:H.value,class:"mt-4 qa-table",hover:""},{item:b((({item:e})=>{return[V("tr",{class:N({"highlight-weekend":ee(e.date)})},[V("td",q,U((a=e.date,`${W.value}月${a}日`)),1),V("td",M,U(e.welding),1),V("td",P,U(e.stamping),1),(k(!0),A(I,null,O("regular"===K.value?L:B,(a=>(k(),A("td",{key:a,style:{"min-width":"90px"},class:"editable-cell"},[x(f,{modelValue:e[a],"onUpdate:modelValue":l=>e[a]=l,variant:"outlined",density:"compact",type:"number","hide-details":"",class:N(["ma-1",{"scrap-field":"scrap"===K.value}]),onInput:l=>((e,a)=>{try{e[a]=parseInt(e[a])||0,ae(e),X.value=!0}catch(l){}})(e,a)},null,8,["modelValue","onUpdate:modelValue","class","onInput"])])))),128))],2)];var a})),_:1},8,["headers","items","loading"])]),X.value?(k(),S(m,{key:0,size:"large",class:"floating-button",color:"primary",rounded:"pill",elevation:"3",onClick:ve},{default:b((()=>[x(v,{class:"mr-1"},{default:b((()=>a[21]||(a[21]=[$(" mdi-content-save ")]))),_:1,__:[21]}),a[22]||(a[22]=$(" 保存更改 "))])),_:1,__:[22]})):j("",!0)])),_:1})}}},[["__scopeId","data-v-c877e827"]]);export{Y as default};
